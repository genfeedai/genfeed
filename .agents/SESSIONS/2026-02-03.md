# Session: 2026-02-03

## Session 1: Replace raw `<button>` tags with `Button` component

### Task
Replaced raw `<button>` HTML elements with the shared `Button` component across web apps, UI packages, and pages in the **cloud** repository (not core).

### Key Decision
- Files are in `/Users/decod3rs/www/genfeedai/cloud/`, not `/Users/decod3rs/www/genfeedai/core/` despite working directory being core.

### Files Modified (11 files, 26 replacements)

#### Studio Editor (13 buttons)
1. **`cloud/apps/web/studio/packages/components/editor/EditorToolbar.tsx`** — Full rewrite, 10 buttons replaced. Added `Button` from `@ui/buttons/base/Button`, `ButtonSize`/`ButtonVariant` from `@genfeedai/enums`. Back→GHOST/SM, playback controls→GHOST/ICON, play/pause→DEFAULT/ICON (rounded-full), add track→GHOST/SM, save→OUTLINE/SM, render→DEFAULT/SM.
2. **`cloud/apps/web/studio/packages/components/editor/EditorTimeline.tsx`** — 2 buttons (mute/lock toggles) → GHOST/XS with conditional className for active state. Added `Button`, `ButtonSize`, `ButtonVariant` imports.
3. **`cloud/apps/web/studio/app/(protected)/editor/[id]/editor-page-content.tsx`** — 1 button (Go Back error) → DEFAULT. Added `Button` from `@ui/buttons/base/Button`, `ButtonVariant` import.

#### Marketplace (8 buttons)
4. **`cloud/apps/web/marketplace/app/(protected)/library/library-content.tsx`** — 3 buttons: filter tabs→GHOST/XS, Open in Studio→SOFT/XS, Install→SOFT/XS. Added `Button`, `ButtonSize`, `ButtonVariant` imports.
5. **`cloud/apps/web/marketplace/app/(public)/[sellerSlug]/[slug]/listing-detail.tsx`** — 4 buttons: Open in Editor→DEFAULT, Install→DEFAULT, Download JSON→OUTLINE, Purchase→DEFAULT. All with `className="w-full"`. Added `Button`, `ButtonVariant` imports.

#### UI Packages (4 buttons, 2 skipped)
6. **`cloud/packages/ui/forms/pickers/color-picker/form-color-picker/FormColorPicker.tsx`** — Color picker trigger→OUTLINE. Backdrop overlay SKIPPED. Added `Button`, `ButtonVariant` imports.
7. **`cloud/packages/ui/masonry/shared/MasonryBrandLogo.tsx`** — Brand logo→UNSTYLED. Added `Button`, `ButtonVariant` imports.
8. **`cloud/packages/ui/dropdowns/multiselect/DropdownMultiSelect.tsx`** — Tab buttons→GHOST/XS. Radix trigger SKIPPED (asChild). Added `Button`, `ButtonSize`, `ButtonVariant` imports.
9. **`cloud/packages/ui/analytics/trends/trending-sounds.tsx`** — Play sound→UNSTYLED. Added `Button`, `ButtonVariant` imports.

#### Pages (2 buttons, 1 skipped)
10. **`cloud/packages/pages/posts/detail/components/PostDetailHeader.tsx`** — Thread option buttons→GHOST/SM. Added `ButtonSize` to existing enum import (Button and ButtonVariant already imported).
11. **`cloud/packages/pages/activities/activities-list.tsx`** — Image overlay→UNSTYLED. Invisible hit area SKIPPED. Button and ButtonVariant already imported.

### Skipped (per plan)
- EditorTimeline line 354 (timeline ruler) — semantic clickable area
- FormColorPicker line 74 (backdrop) — invisible accessibility dismiss
- DropdownMultiSelect line 289 (Radix trigger) — Radix asChild integration
- activities-list line 356 (invisible hit area) — invisible semantic button
- All extension files — out of scope

### Pattern Used
All replacements use `withWrapper={false}` to avoid extra wrapper div. Props mapped: `disabled`→`isDisabled`, `title`→`tooltip`, `aria-label`→`ariaLabel`, `className` preserved where needed.

### Status
- All 26 replacements complete
- No commits made (waiting for user request)
- Changes are in cloud/ repo working tree

---

## Session 2: LLM Node — Model Browser + Prompt Preview

### Task
Add model browser and input prompt preview to the LLM node, following the same pattern as ImageGenNode/VideoGenNode.

### System Flow

```
Prompt Node → [text connection] → LLM Node (shows input prompt preview)
                                     ↓
                              Click model name → ModelBrowserModal (text-generation filter)
                                     ↓
                              Select model → useModelSelection updates nodeData
                                     ↓
                              Click Generate → LLM Processor → ReplicateService.generateText(selectedModel)
```

### Affected Components
- **Types**: `providers.ts`, `ai-nodes.ts`, `registry.ts`
- **Frontend**: `registry.ts` (models), `route.ts` (API metadata), `LLMNode.tsx` (UI)
- **Backend**: `job-data.interface.ts`, `replicate.service.ts`, `llm.processor.ts`

### What Was Done
- [x] Added `'text-generation'` to `ModelCapability` union type
- [x] Added `TextModel` type and `model`/`provider`/`selectedModel`/`schemaParams` to `LLMNodeData`
- [x] Added `model: 'meta-llama-3.1-405b-instruct'` default to `llm` entry in `NODE_DEFINITIONS`
- [x] Added `LLM_MODELS`, `LLM_MODEL_MAP`, `LLM_MODEL_ID_MAP`, `DEFAULT_LLM_MODEL`, `getLLMModelLabel()` to frontend model registry
- [x] Added `meta/meta-llama-3.1-405b-instruct` to `MODEL_METADATA` in API route with `text-generation` capability
- [x] Rewrote `LLMNode.tsx` with model browser (clickable title + `ModelBrowserModal`), input prompt preview, Generate/Stop toggle, disabled inputs during processing
- [x] Added `selectedModel`/`schemaParams` to `LLMJobData` interface
- [x] Updated `LLMInput` and `generateText()` in `ReplicateService` for dynamic model selection
- [x] Passed `selectedModel`/`schemaParams` through in `LLMProcessor`

### Key Decisions
1. **Followed ImageGenNode pattern exactly** — `useModelSelection`, `useAutoLoadModelSchema`, `titleElement`, `headerActions`, `hideStatusIndicator`
2. **Input prompt preview** — Shows connected prompt text in a muted box above system prompt, truncated with `line-clamp-3`. Shows "Connect a prompt" help text when no prompt connected.
3. **Backward compatible** — `model` defaults in `NODE_DEFINITIONS`, `selectedModel` optional everywhere, falls back to `MODELS.llama` in backend

### Files Modified (9 files)

#### Types
1. **`packages/types/src/nodes/providers.ts`** — Added `'text-generation'` to `ModelCapability`
2. **`packages/types/src/nodes/ai-nodes.ts`** — Added `TextModel` type, extended `LLMNodeData` with `model`, `provider`, `selectedModel`, `schemaParams`
3. **`packages/types/src/nodes/registry.ts`** — Added `model` default to `llm.defaultData`

#### Frontend
4. **`apps/web/src/lib/models/registry.ts`** — Added LLM model registry section (TextModelConfig, maps, defaults, label getter)
5. **`apps/web/src/app/api/providers/models/route.ts`** — Added Llama 3.1 405B entry to `MODEL_METADATA`
6. **`apps/web/src/components/nodes/ai/LLMNode.tsx`** — Full rewrite with model browser + prompt preview

#### Backend
7. **`apps/api/src/interfaces/job-data.interface.ts`** — Added `selectedModel`/`schemaParams` to `LLMJobData`
8. **`apps/api/src/services/replicate.service.ts`** — Extended `LLMInput`, updated `generateText()` for dynamic model + schemaParams merge
9. **`apps/api/src/processors/llm.processor.ts`** — Passes `selectedModel`/`schemaParams` to replicate service

### Mistakes and Fixes
- None — clean implementation following established patterns

### Status
- All 9 files modified
- No commits made (waiting for user request)
- Changes are in core/ repo working tree

---

## Session 3: Fix AI Node Validation Stale Cache Bug

### Task
Fixed a bug where the Generate button on AI nodes stayed disabled despite valid connected data. The `useMemo` in `useCanGenerate` was returning a stale cached result because connected node output data wasn't in the dependency array.

### System Flow

```
Prompt Node (text changes) → useWorkflowStore triggers re-render
    ↓
useCanGenerate hook re-renders
    ↓
BEFORE FIX: useMemo sees no dep changes → returns cached canGenerate=false
AFTER FIX:  connectedNodeData in deps → useMemo recalculates → canGenerate=true
```

### Root Cause
`_connectedNodeData` (line 100) subscribed to source node output changes via `useShallow`, triggering component re-renders. However, it was prefixed with `_` (unused variable convention) and **not included in the `useMemo` dependency array** (lines 161-169). The memo cached stale validation results until an unrelated dependency like `inputSchema` changed (e.g., switching models).

### What Was Done
- [x] Renamed `_connectedNodeData` → `connectedNodeData` (removed unused-variable prefix)
- [x] Added `connectedNodeData` to `useMemo` dependency array

### Key Decisions
1. **Minimal fix** — Only the dependency array needed updating; no logic changes required since `getConnectedInputs(nodeId)` inside the memo already reads latest store state
2. **Performance safe** — `useShallow` on `connectedNodeData` already prevents unnecessary re-renders from unrelated store updates

### Files Modified (1 file)
1. **`apps/web/src/hooks/useCanGenerate.ts`** — Renamed variable, added to useMemo deps

### Mistakes and Fixes
- None

### Status
- Fix complete
- No commits made (waiting for user request)
- Changes are in core/ repo working tree

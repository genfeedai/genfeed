# Session: 2026-01-19

## Session 1: Environment File Cleanup + Codebase Cleanup

### Summary
Two cleanup tasks completed:
1. Consolidated environment files to single source of truth per app
2. Full codebase cleanup (imports, console.log → logger, dead code check)

---

### Task 1: Environment File Cleanup

#### Problem
Project had redundant env files:
- Root `/.env` and `/.env.example` (unused by apps)
- `apps/api/.env` (used by NestJS)
- `apps/web/.env.local` (used by Next.js)

Scripts were updating both root and app-specific files.

#### Solution
- Deleted root `.env` and `.env.example`
- Updated scripts to read from `apps/api/.env` only
- Added missing variables to `apps/api/.env.example`

#### Files Deleted
```
.env           # Redundant
.env.example   # Redundant
```

#### Files Modified
```
scripts/dev-tunnel.ts              # Only updates apps/api/.env now
scripts/sync-replicate-schemas.ts  # Loads env from apps/api/.env explicitly
apps/api/.env.example              # Added STORAGE_ADAPTER, SQLITE_PATH
```

#### New Structure
| App | Env File |
|-----|----------|
| API (NestJS) | `apps/api/.env` |
| Web (Next.js) | `apps/web/.env.local` |
| Scripts | Load from `apps/api/.env` |

---

### Task 2: Codebase Cleanup (/clean all)

#### Imports
- Biome auto-fixed useless switch case in `ffmpeg.service.ts`
- Biome auto-fixed optional chain patterns in `ffmpeg.service.ts`

#### Console.log → Logger

**API (2 files):**
- `main.ts` - `console.log` → `Logger.log`
- `worker.main.ts` - `console.error` → `Logger.error`

**Web (15 files):**
| File | Change |
|------|--------|
| `api/tweet/fetch/route.ts` | → `logger.error` |
| `api/tweet/remix/route.ts` | → `logger.error` |
| `api/video/process/route.ts` | → `logger.error` |
| `api/tools/grid-split/route.ts` | → `logger.error` |
| `api/rss/fetch/route.ts` | → `logger.error` |
| `api/status/[id]/route.ts` | → `logger.error` |
| `api/ai/generate-workflow/route.ts` | → `logger.error` |
| `api/replicate/webhook/route.ts` | → `logger.error` |
| `api/replicate/video/route.ts` | → `logger.error` |
| `api/replicate/lipsync/route.ts` | → `logger.error` |
| `api/replicate/llm/route.ts` | → `logger.error` |
| `api/replicate/image/route.ts` | → `logger.error` |
| `components/prompt-library/CreatePromptModal.tsx` | → `logger.error` |
| `components/models/ModelBrowserModal.tsx` | → `logger.error` |
| `store/promptLibraryStore.ts` | → `logger.error` |

#### Any Types
- No `any` types in production code (only in test files with explicit disable comments)

#### Dead Code
- No significant dead code detected

---

### Patterns Established

1. **Environment files**: One source of truth per app, scripts load from `apps/api/.env`
2. **Error logging**: Use `logger.error(message, error, { context })` format in web app
3. **NestJS logging**: Use `new Logger(ContextName)` pattern

---

## Session 2: Define OSS Core Scope

### Summary

Defined the boundary between OSS Core and Genfeed Cloud. The OSS version focuses on **media generation and processing** while Cloud handles **social publishing and content aggregation**.

### Scope Decisions

| Feature | OSS | Cloud |
|---------|-----|-------|
| Visual workflow editor | ✅ | ✅ |
| Queue-based execution | ✅ | ✅ |
| Real-time SSE updates | ✅ | ✅ |
| Gallery asset management | ✅ | ✅ |
| Templates (10 total) | ✅ | ✅ |
| Replicate provider | ✅ | ✅ |
| FAL.ai provider | ❌ | ✅ |
| HuggingFace provider | ❌ | ✅ |
| Social publishing | ❌ | ✅ |
| RSS/Twitter feeds | ❌ | ✅ |

### OSS Node Count: 26 nodes

**Input (5)**: imageInput, audioInput, videoInput, prompt, template

**AI (7)**: imageGen, videoGen, llm, lipSync, voiceChange, textToSpeech, transcribe

**Processing (12)**: resize, animation, videoStitch, videoTrim, videoFrameExtract, lumaReframeImage, lumaReframeVideo, topazImageUpscale, topazVideoUpscale, imageGridSplit, annotation, **subtitle (NEW)**

**Output (2)**: output, preview

### Cloud-Only Nodes (4)

Moved to `cloud/packages/`:
- `socialPublish` - Multi-platform video publishing
- `rssInput` - RSS feed aggregation
- `tweetInput` - Twitter content fetching
- `tweetRemix` - AI tweet variation generation

### Implementation Completed

1. **Phase 0: Subtitle Node Implementation**
   - Added types to `packages/types/src/nodes.ts`
   - Created `SubtitleNode.tsx` component
   - Added FFmpeg subtitle burning service
   - Added job processor for subtitle node

2. **Phase 1: Move Cloud Nodes**
   - Copied node components to `cloud/packages/ui/workflow-builder/nodes/`
   - Created type definitions in `cloud/packages/workflow-saas/src/nodes/`
   - Updated exports in index files
   - Removed cloud nodes from core

3. **Phase 2: Remove Excluded Providers**
   - Deleted `fal.service.ts` and `huggingface.service.ts`
   - Updated `providers.module.ts` and `providers.controller.ts`
   - Removed test spec files

4. **Phase 3: Update Templates**
   - Updated `stream-to-social.ts`: Removed 3 socialPublish nodes, simplified to output
   - Updated `youtube-video-generator.ts`: Removed youtubeUpload placeholder, connected subtitle → output

5. **Phase 4: Cloud Documentation**
   - Created `cloud/.agent/TASKS/workflow-nodes-migration.md`
   - Created `cloud/.agent/PRDS/cloud-workflow-nodes.md`

### Files Modified

**Core (types)**:
- `packages/types/src/nodes.ts` - Removed cloud types, added subtitle types

**Core (components)**:
- `apps/web/src/components/nodes/processing/SubtitleNode.tsx` (new)
- `apps/web/src/components/nodes/processing/index.ts` (updated)
- `apps/web/src/components/nodes/index.ts` (updated)
- `apps/web/src/components/nodes/input/index.ts` (updated)
- `apps/web/src/components/nodes/output/index.ts` (updated)
- `apps/web/src/components/nodes/ai/index.ts` (updated)

**Core (deleted)**:
- `apps/web/src/components/nodes/input/RssInputNode.tsx`
- `apps/web/src/components/nodes/input/TweetInputNode.tsx`
- `apps/web/src/components/nodes/output/SocialPublishNode.tsx`
- `apps/web/src/components/nodes/ai/TweetRemixNode.tsx`
- `apps/web/src/app/api/rss/` (directory)
- `apps/web/src/app/api/tweet/` (directory)
- `apps/api/src/providers/fal.service.ts`
- `apps/api/src/providers/huggingface.service.ts`
- `apps/api/src/providers/*.spec.ts`

**Core (backend)**:
- `apps/api/src/ffmpeg/ffmpeg.service.ts` (updated)
- `apps/api/src/queue/interfaces/job-data.interface.ts` (updated)
- `apps/api/src/queue/processors/processing.processor.ts` (updated)
- `apps/api/src/providers/providers.module.ts` (updated)
- `apps/api/src/providers/providers.controller.ts` (updated)

**Core (templates)**:
- `apps/web/src/templates/generated/stream-to-social.ts` (updated)
- `apps/web/src/templates/generated/youtube-video-generator.ts` (updated)
- `apps/web/src/templates/index.ts` (updated)

**Cloud (new)**:
- `packages/ui/workflow-builder/nodes/SocialPublishNode.tsx`
- `packages/ui/workflow-builder/nodes/RssInputNode.tsx`
- `packages/ui/workflow-builder/nodes/TweetInputNode.tsx`
- `packages/ui/workflow-builder/nodes/TweetRemixNode.tsx`
- `packages/workflow-saas/src/nodes/social-publish.ts`
- `packages/workflow-saas/src/nodes/rss-input.ts`
- `packages/workflow-saas/src/nodes/tweet-input.ts`
- `packages/workflow-saas/src/nodes/tweet-remix.ts`
- `packages/workflow-saas/src/nodes/index.ts` (updated)
- `.agent/TASKS/workflow-nodes-migration.md`
- `.agent/PRDS/cloud-workflow-nodes.md`

### Next Steps for Cloud

1. Configure TypeScript/JSX for workflow-builder package
2. Register nodes in workflow builder's node registry
3. Create API routes for RSS and tweet fetching
4. Implement OAuth integrations for social platforms
5. Add job processors for tweetRemix and socialPublish

---

## Session 3: README Documentation + Social Preview Card

### Summary

Added visual documentation to `core/README.md` and created a marketing social preview card for GitHub/Twitter sharing.

### Tasks Completed

1. **Video Generation Workflow Diagram**
   - Added ASCII art pipeline diagram to README.md
   - Shows: Workflow Editor → Execution Service → Orchestrator Queue → Generation Nodes → Post-Processing → Storage
   - Includes queue concurrency settings

2. **Social Preview Card**
   - Created marketing-style SVG social card
   - Converted to PNG (1280x640) for GitHub compatibility
   - Design: Dark gradient background, purple/pink glow orbs, play icon, "Genfeed" headline, "AI Video Generation Workflows" tagline, "Open Source" badge

### Files Created

```
.github/social-preview.svg   # Source SVG
.github/social-preview.png   # GitHub-ready PNG (1280x640)
```

### Files Modified

```
README.md   # Added Video Generation Workflow section after Architecture
```

### Next Steps

- Upload `social-preview.png` to GitHub: Settings → General → Social preview → Upload an image

---

## Session 4: Workflow Execution Visual Highlighting

### Summary

Added prominent visual highlighting for workflow nodes that are currently executing, making it easy to see where the process state is at a glance.

### Problem

When a workflow runs, processing nodes showed a small spinner icon in the header, but there was no prominent visual indicator making it clear which node is currently executing. The `currentNodeId` was tracked in the store but not prominently highlighted on the canvas.

### Solution

Added a pulsing glow animation that highlights processing nodes with their category color.

```
┌──────────────────────────────────────────────────────────────┐
│  Before: Only spinner icon in header                         │
│  After:  Spinner + pulsing glow around entire node          │
└──────────────────────────────────────────────────────────────┘
```

### Implementation

```mermaid
flowchart LR
    A[Node Status] -->|processing| B[Apply node-processing class]
    B --> C[CSS animation: processing-glow]
    C --> D[Pulsing box-shadow using --node-color]
```

### Files Modified

| File | Change |
|------|--------|
| `apps/web/src/app/globals.scss` | Added `@keyframes processing-glow` animation and `.node-processing` class |
| `apps/web/src/components/nodes/BaseNode.tsx` | Added `isProcessing` check and conditionally apply `node-processing` class |

### Code Changes

**globals.scss (lines 206-218)**:
```scss
@keyframes processing-glow {
  0%, 100% {
    box-shadow: 0 0 8px 2px var(--node-color, var(--primary));
  }
  50% {
    box-shadow: 0 0 20px 6px var(--node-color, var(--primary));
  }
}

.node-processing {
  animation: processing-glow 1.5s ease-in-out infinite;
}
```

**BaseNode.tsx (lines 136, 145)**:
```tsx
const isProcessing = nodeData.status === 'processing';

// In className:
isProcessing && 'node-processing'
```

### Visual Result

- Processing nodes now have a pulsing glow effect (8px → 20px → 8px)
- Glow color matches node category (blue/purple/cyan/green)
- Animation runs at 1.5s intervals for subtle, non-distracting effect
- Combined with existing spinner icon for clear execution state visibility

### Patterns Used

- Used existing `--node-color` CSS variable for category-aware coloring
- Followed existing pattern of conditional className with `clsx`
- Animation defined in globals.scss, class applied in component

---

## Session 5: VideoStitch Node Enhancements (easy-peasy-ease Inspired)

### Summary

Enhanced the VideoStitch node with audio codec selection and draft quality mode, inspired by recent updates to the [easy-peasy-ease](https://github.com/VincentShipsIt/easy-peasy-ease) project.

### Background

The easy-peasy-ease project (VincentShipsIt) recently updated with:
- Preview quality mode (720p @ 4Mbps) for faster rendering
- Audio codec changes (AAC → MP3 fallback for Twitter compatibility)
- Mediabunny 1.28.0 upgrade (Safari/Chrome stability)
- Frame rate cap (30fps for smoother previews)

While our implementation uses FFmpeg (not Mediabunny), we incorporated the relevant improvements.

### Features Added

| Feature | Description | Default |
|---------|-------------|---------|
| **Audio Codec Selection** | AAC (best compatibility) or MP3 (legacy fallback) | AAC |
| **Draft Quality Mode** | 720p @ 4Mbps, 30fps for fast preview rendering | Full |

### Files Modified

**Types (1 file)**:
- `packages/types/src/nodes.ts`
  - Added `AudioCodec` type: `'aac' | 'mp3'`
  - Added `OutputQuality` type: `'full' | 'draft'`
  - Extended `VideoStitchNodeData` with new fields

**Frontend (1 file)**:
- `apps/web/src/components/nodes/processing/VideoStitchNode.tsx`
  - Added `AUDIO_CODECS` options array
  - Added `handleAudioCodecChange` handler
  - Added `handleQualityToggle` handler
  - Added Audio Codec dropdown selector
  - Added Draft Quality toggle with Zap icon

**Backend (2 files)**:
- `apps/api/src/ffmpeg/ffmpeg.service.ts`
  - Added `StitchVideosInput` interface
  - Added `StitchVideosResult` interface
  - Added `stitchVideos()` method with:
    - FFmpeg concat for cut transitions
    - FFmpeg xfade filter for crossfade/fade/wipe
    - Lanczos scaling for high-quality output
    - Draft mode: 720p @ 4Mbps, 30fps
    - Full mode: 1080p, CRF 18
    - Audio codec selection (AAC/MP3)
    - Seamless loop support

- `apps/api/src/queue/interfaces/job-data.interface.ts`
  - Added `VideoStitchJobData` interface
  - Added to `ProcessingJobData` union type

- `apps/api/src/queue/processors/processing.processor.ts`
  - Added `videoStitch` case handler

**Templates (5 files)**:
- `apps/web/src/templates/generated/stream-to-social.ts`
- `apps/web/src/templates/generated/youtube-video-generator.ts`
- `apps/web/src/templates/generated/grid-to-video.ts`
- `apps/web/src/templates/generated/extended-video.ts`
- `apps/web/src/templates/full-pipeline.ts`
- `apps/web/src/app/api/ai/generate-workflow/route.ts`
  - All updated with new defaults: `audioCodec: 'aac'`, `outputQuality: 'full'`

### Technical Implementation

**Draft Quality Settings**:
```
-vf scale=1280:720:flags=lanczos -b:v 4M -maxrate 4M -bufsize 8M -r 30
```

**Full Quality Settings**:
```
-vf scale=-2:1080:flags=lanczos -crf 18
```

**Audio Codec Settings**:
- AAC: `-c:a aac -b:a 192k`
- MP3: `-c:a libmp3lame -q:a 2`

### Why These Choices

1. **AAC as default**: Best compatibility with Twitter, Instagram, TikTok
2. **720p for draft**: Matches easy-peasy-ease preview mode, fast enough for quick iterations
3. **Lanczos scaling**: High-quality interpolation, prevents pixelation
4. **30fps for draft**: Smoother playback, per easy-peasy-ease findings

---

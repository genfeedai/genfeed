# Session: 2026-02-02

## Session 1: Document Core vs Cloud Scope Decisions

**Goal:** Codify scope decisions about what belongs in Core OSS vs Cloud SaaS, reflecting recent deletions (telegram-bot, CLI, SDK) and architectural choices (no webhooks, no bots, no scheduled triggers in core).

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Telegram Bot → Cloud only | Core exposes no bot mechanism. Cloud owns TG bot at `cloud/apps/server/api/src/services/telegram-bot/` |
| No webhook triggers in core | Self-hosted core runs on localhost; external services can't reach it without tunnels |
| No cloudUpload node | Cloud outputs go to CDN automatically; no separate upload node needed |
| CLI and SDK removed | Already deleted from core. Docs updated to reflect this |
| Core is UI-triggered only | Workflows triggered exclusively from web UI "Run" button |

### Files Modified

| File | Change |
|------|--------|
| `.agents/SYSTEM/FEATURE-SPLIT.md` | Removed webhook triggers, scheduled execution, CLI from Core. Added Telegram Bot, Webhook triggers, Scheduled execution to Cloud SaaS table. Added guidelines #6 (no bot/trigger integrations) and #7 (no CLI/SDK). Updated date. |
| `.agents/skills/scope-validator/SKILL.md` | Added Cloud-Only Features table. Added Rule 5: Bot/Trigger Check. Added Telegram/webhook FAQ entries. Updated Quick Reference with cloud-only features and "Triggers: UI only" note. |
| `.agents/SYSTEM/ARCHITECTURE.md` | Added UI-only trigger note to data flow diagram. Fixed Output node categories (removed WebhookOutput, APIOutput). Replaced SDK package with actual packages (prompts, workflows). |
| `.agents/TASKS/INBOX.md` | Marked Telegram Bot task as moved to Cloud SaaS. Struck through Telegram bot reference in UGC Factory task. |

### Stale References Noted

Grep found webhook/telegram references in these files (left as-is since they're historical records):
- `.agents/SESSIONS/2026-01-21.md` — Session 22 documents the webhook removal process
- `.agents/SESSIONS/2026-01-14.md` — Historical webhook implementation
- `.agents/PRDS/telegram-bot-core.md` — Superseded PRD (core telegram bot was deleted)
- `.agents/PRDS/telegram-bot-workflow.md` — Original PRD, cloud portion still valid
- `.agents/PRDS/kling-motion-control.md` — References Replicate API webhooks (internal mechanism, not external triggers)
- `.agents/PRDS/ugc-factory-*.md` — Historical references to Telegram distribution

### Patterns Established

- Core scope docs now consistently state: **UI-only trigger model**
- Three-doc consistency: FEATURE-SPLIT, scope-validator SKILL, and ARCHITECTURE all align
- Cloud SaaS table in FEATURE-SPLIT is the authoritative scope boundary

---

## Session 2: Stop Tracking next-env.d.ts

**Goal:** Remove auto-generated `next-env.d.ts` files from git tracking in core repo (cloud already ignores them).

### Tasks Completed

1. Added `next-env.d.ts` to `.gitignore` under a new "Next.js auto-generated" section
2. Removed both tracked files from git index: `next-env.d.ts` and `apps/web/next-env.d.ts`
3. Committed as `3a5847e` — `chore: stop tracking next-env.d.ts`

### Files Modified

| File | Change |
|------|--------|
| `.gitignore` | Added `next-env.d.ts` to ignore list |
| `next-env.d.ts` | Removed from git tracking (file still exists locally) |
| `apps/web/next-env.d.ts` | Removed from git tracking (file still exists locally) |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Ignore pattern `next-env.d.ts` (no path prefix) | Catches all instances across the repo, matching cloud repo's approach |

### Status
- Committed, not pushed

---

## Session 3: Refactor Distribution Node Registry

**Goal:** Replace hardcoded distribution node injection with a `DistributionNodeRegistry` service. Remove concrete node coupling from `ProcessingProcessor`.

### Tasks Completed

1. Created `DistributionNodeRegistry` injectable service with `register()`, `get()`, `getRegisteredTypes()` methods
2. Updated 3 output nodes to self-register via `OnModuleInit` lifecycle hook
3. Simplified `queue.module.ts` — removed 3 string token aliases, added single registry provider + alias
4. Refactored `ProcessingProcessor` — replaced 3 concrete node injections with single registry injection, replaced switch-based lookup with registry lookup

### Files Created

| File | Purpose |
|------|---------|
| `apps/api/src/nodes/distribution/distribution-node-registry.ts` | Registry service — `Map<nodeType, { node, platform }>` |

### Files Modified

| File | Change |
|------|--------|
| `apps/api/src/nodes/distribution/telegram-output-node.ts` | Added `OnModuleInit`, injects registry, registers as `telegramPost` → `telegram` |
| `apps/api/src/nodes/distribution/discord-output-node.ts` | Added `OnModuleInit`, injects registry, registers as `discordPost` → `discord` |
| `apps/api/src/nodes/distribution/google-drive-output-node.ts` | Added `OnModuleInit`, injects registry, registers as `googleDriveUpload` → `google_drive` |
| `apps/api/src/modules/queue.module.ts` | Added `DistributionNodeRegistry` provider + string alias; removed 3 individual node aliases |
| `apps/api/src/processors/processing.processor.ts` | Replaced 3 node injections with single `DistributionNodeRegistry` injection; replaced switch with `registry.get()` |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Self-registration via `OnModuleInit` | Nodes own their registration — adding a new node = 1 file + 1 line in module providers |
| `forwardRef` on registry injection in nodes | Avoids circular dependency since registry and nodes are in the same module |
| Keep concrete nodes as providers in module | NestJS DI still needs to instantiate them for `OnModuleInit` to fire |
| Registry uses `Map<string, { node, platform }>` | Simple lookup, no switch statements, O(1) access |

### Patterns Established

- Distribution nodes self-register with `DistributionNodeRegistry` via `OnModuleInit`
- `ProcessingProcessor` has zero knowledge of concrete distribution node types
- Adding a new distribution platform = 1 new file (node with `OnModuleInit`) + 1 line in `queue.module.ts` providers

### Status
- All changes made, zero TS diagnostics
- Not committed, not pushed

---

## Session 4: Clean Stale Inbox Tasks

**Goal:** Mark completed inbox tasks as done and move to Processed section.

### Tasks Completed

1. Marked **UGC Factory Integration** as done — processing pipeline (TTS, lip sync, video stitch, reframe, upscale) is wired in `processing.processor.ts`, distribution nodes implemented via `DistributionNodeRegistry` (`5042aef`)
2. Marked **Replace direct LLM calls with provider abstraction** as done — provider selector in SettingsModal, `ProviderType` in use
3. Moved both to `## Processed` section under `### 2026-02-02`
4. Updated `Last Updated` date to `2026-02-02`

### Files Modified

| File | Change |
|------|--------|
| `.agents/TASKS/INBOX.md` | Marked 2 tasks as done, moved to Processed section, updated date |

### Status
- Inbox has zero open tasks
- Documentation updated

---

## Session 5: Investigate `apps/data/workflows` vs Root `data/`

**Goal:** Understand why `apps/data/workflows` exists when the real data directory is at the monorepo root `data/`.

### Investigation

1. Checked directory structure — found `apps/data/workflows/` (empty) and root `data/workflows/` (contains workflow data files with MongoDB ObjectId-style names)
2. Confirmed `apps/data/` has **no `package.json`** — not a valid workspace package
3. Confirmed `apps/data/workflows/` has **zero files**
4. Grep'd codebase for references:
   - `apps/api/src/services/files.service.ts` → references `/data/workflows/` (root-level)
   - `apps/web/src/app/api/gallery/[...path]/route.ts` → resolves `../../data/workflows` (root-level)
   - `apps/web/src/app/api/gallery/route.ts` → resolves `../../data/workflows` (root-level)
5. No code creates or references `apps/data/` — it's a stray empty directory (likely accidental drag in VS Code)

### Conclusion

| Finding | Detail |
|---------|--------|
| `apps/data/` is stray | Empty, no package.json, no code references it |
| Root `data/workflows/` is real | Contains actual workflow data, referenced by API and web apps |
| Safe to delete `apps/data/` | No runtime code creates or depends on it |

### Files Modified

None — investigation only, no changes made.

### Status
- Identified stray `apps/data/` directory — user can delete when ready

---

## Session 6: Full PRD + Task Audit Against Codebase

**Goal:** Cross-reference all 19 PRDs and 14 task files against actual implemented code. Identify stale statuses.

### Audit Results

**14 PRDs have wrong status** — code is shipped but PRD still says Planning/Doing/Backlog:

| PRD | Doc Status | Actual | Evidence |
|-----|-----------|--------|----------|
| `right-click-context-menu.md` | Doing | Done | `ContextMenu.tsx`, `useContextMenu.ts`, node/pane/edge/selection menus |
| `auto-save.md` | Planning | Done | `useAutoSave.ts` hook, `SaveIndicator.tsx` |
| `command-palette.md` | Planning | Done | `CommandPalette.tsx` (294 lines), `commandPaletteStore.ts` |
| `auto-reorder-blocks.md` | Planning | Done | `autoLayout.ts` (258 lines) with dagre, visible in context menu |
| `ai-quickstart-natural-language.md` | Ready for Implementation | Done | `WorkflowGeneratorService`, `GenerateWorkflowModal.tsx` |
| `kling-motion-control.md` | To Do | Done | `MotionControlNode.tsx` with all modes/quality/orientation |
| `image-annotation-editor.md` | Backlog | Done | `AnnotationModal.tsx`, `AnnotationNode.tsx`, Canvas API |
| `oss-rebrand.md` | Planning | Done | All packages `@genfeedai/*`, AGPL-3.0 license |
| `group-locking.md` | Doing | Done (buggy?) | `lockingSlice.ts`, `groupSlice.ts` in workflowStore |
| `test-coverage.md` | Doing | Done | 46 test files, vitest config, coverage thresholds set |
| `onboarding-modal.md` | Planning | Partial | `WelcomeModal.tsx` exists, no template gallery wizard |
| `ugc-factory-integration.md` | In Progress | Done | Pipeline wired in `processing.processor.ts` |
| `telegram-bot-core.md` | In Progress | Superseded | Bot removed from core (`747800b`), moved to Cloud |
| `telegram-bot-workflow.md` | In Progress | Superseded | Cloud-only, no bot in core |

**PRDs with correct status (3):**
- `avatar-workflow.md` — Implemented
- `workflow-cost-tracking.md` — Done (Phase 1 MVP)
- `input-group.md` — Complete
- `ugc-factory-prd.md` — Implemented

**Dead references in `PRDS/README.md`:**
5 marketplace PRDs linked but files don't exist (abandoned direction):
- `marketplace-overview.md`, `seller-system.md`, `listing-system.md`, `purchase-flow.md`, `reviews-ratings.md`

**Task files:** All 14 correctly show `Status: Done`.

### Remaining Work Identified

1. **Group locking** — user reports bugs, needs investigation
2. **Onboarding modal** — `WelcomeModal` exists but no template gallery/step-by-step wizard per PRD spec
3. **Stray `apps/data/`** — empty directory, safe to delete
4. **PRD status updates** — 14 PRDs need status corrected
5. **PRDS/README.md** — dead marketplace links need cleanup

### Files Modified

None — audit only, no changes made. User to decide on bulk PRD updates.

### Status
- Full audit complete
- Awaiting user decision on bulk PRD status updates

---

## Session 7: Bulk PRD Status Updates + README Cleanup

**Goal:** Update all 14 stale PRD statuses to match actual implementation state. Clean up PRDS/README.md.

### Tasks Completed

1. Updated 10 PRDs to **Done**: right-click-context-menu, auto-save, command-palette, auto-reorder-blocks, ai-quickstart-natural-language, kling-motion-control, image-annotation-editor, oss-rebrand, test-coverage, ugc-factory-integration
2. Updated group-locking to **Buggy — implemented but has reported issues, needs investigation**
3. Updated onboarding-modal to **Partial (WelcomeModal exists, template gallery wizard not implemented)**
4. Updated telegram-bot-core and telegram-bot-workflow to **Superseded** (moved to Cloud SaaS)
5. Rewrote `PRDS/README.md` — removed 5 dead marketplace links, reorganized into Done/Partial/Superseded sections, added all 18 PRDs to listing

### Files Modified

| File | Change |
|------|--------|
| `.agents/PRDS/right-click-context-menu.md` | Status: Doing → Done |
| `.agents/PRDS/auto-save.md` | Status: Planning → Done |
| `.agents/PRDS/command-palette.md` | Status: Planning → Done |
| `.agents/PRDS/auto-reorder-blocks.md` | Status: Planning → Done |
| `.agents/PRDS/ai-quickstart-natural-language.md` | Status: Ready for Implementation → Done |
| `.agents/PRDS/kling-motion-control.md` | Status: To Do → Done |
| `.agents/PRDS/image-annotation-editor.md` | Status: Backlog → Done |
| `.agents/PRDS/oss-rebrand.md` | Status: Planning → Done |
| `.agents/PRDS/test-coverage.md` | Status: Doing → Done |
| `.agents/PRDS/ugc-factory-integration.md` | Status: In Progress → Done |
| `.agents/PRDS/group-locking.md` | Status: Doing → Buggy |
| `.agents/PRDS/onboarding-modal.md` | Status: Planning → Partial |
| `.agents/PRDS/telegram-bot-core.md` | Status: Draft → In Progress → Superseded |
| `.agents/PRDS/telegram-bot-workflow.md` | Status: In Progress → Superseded |
| `.agents/PRDS/README.md` | Removed dead marketplace links, reorganized into Done/Partial/Superseded, added all PRDs, updated date |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| group-locking status = "Buggy" not "Done" | User flagged — can't call it done if it has known issues |
| Removed marketplace section entirely | 5 linked files never existed, abandoned direction |
| Organized README by status category | Easier to scan what's done vs what needs work |

### Remaining Work

1. **Group locking bugs** — needs investigation
2. **Onboarding wizard** — WelcomeModal exists but template gallery not built
3. **Stray `apps/data/`** — empty directory, safe to delete

### Status
- All PRD statuses now reflect reality
- Not committed, not pushed

---

## Session 8: Codebase Optimization — DRY, Simplify, Optimize (12 Refactors)

**Goal:** Execute a comprehensive 4-phase optimization plan covering backend distribution nodes, processor simplification, frontend component DRY, and types/store cleanup. ~840 lines removed.

### Phase 1: Distribution Node DRY (Backend)

**1.1** — Extracted `deliverToTargets<TTarget>()` template method + `ensureBuffer()` into `BaseOutputNode`. Added `PlatformConfig` base interface. Fixed `DeliveryResult.results` from `any[]` to `Array<Record<string, unknown>>`.

**1.2** — Simplified Discord/Telegram `deliver()` from ~90 lines each to single `deliverToTargets()` calls. Fixed 6 `any` types: `getChannelInfo`, `getBotInfo`, `drive`, `getStorageInfo`, config generics.

**1.3** — Replaced 2 manual `updateProgress + addJobLog` pairs in ProcessingProcessor with `updateProgressWithLog()`.

### Phase 2: Processor Simplification (Backend)

**2.1** — Added `extractOutputUrl()` (6 Replicate output formats) + `saveAndNormalizeOutput()` to BaseProcessor. ~270 lines consolidated.

**2.2** — Added `startJob()` + `completeJob()` template methods to BaseProcessor.

**2.3-2.5** — Refactored `ImageProcessor`, `VideoProcessor`, `ProcessingProcessor` to use new base methods. Debug mode and heartbeat callbacks preserved.

### Phase 3: Frontend Component DRY

**3.1** — Created `Modal` (ESC key, backdrop, header) + `ModalTabs` reusable components.

**3.2** — Split SettingsModal (558→47 lines) into 5 tab files. ESC key bug fixed.

**3.3** — Extracted `ProcessingOverlay` component, replaced 5 copy-pasted overlay blocks.

**3.4** — Extracted `useAIGenNode` hook with 5 shared useMemo/useCallback blocks.

### Phase 4: Types & Store Cleanup

**4.1** — Split `nodes.ts` (2034 lines) into 11 modules under `packages/types/src/nodes/`. Fixed 2 `any` types in `WebhookPostNodeData`. Barrel re-export preserves API.

**4.2** — Added `setAndPersist()` helper to settingsStore, refactored 11 actions.

### Files Created (19)

| File | Purpose |
|------|---------|
| `apps/web/src/components/ui/modal.tsx` | Reusable Modal + ModalTabs |
| `apps/web/src/components/nodes/ProcessingOverlay.tsx` | Shared processing spinner overlay |
| `apps/web/src/hooks/useAIGenNode.ts` | Shared AI gen node schema hook |
| `apps/web/src/components/settings/tabs/DefaultsTab.tsx` | Settings defaults tab |
| `apps/web/src/components/settings/tabs/ApiKeysTab.tsx` | Settings API keys tab |
| `apps/web/src/components/settings/tabs/AppearanceTab.tsx` | Settings appearance tab |
| `apps/web/src/components/settings/tabs/DeveloperTab.tsx` | Settings developer tab |
| `apps/web/src/components/settings/tabs/HelpTab.tsx` | Settings help tab |
| `packages/types/src/nodes/handles.ts` | Handle types and connection rules |
| `packages/types/src/nodes/providers.ts` | Provider and model types |
| `packages/types/src/nodes/base.ts` | Base node types and status |
| `packages/types/src/nodes/input-nodes.ts` | Input node data interfaces |
| `packages/types/src/nodes/ai-nodes.ts` | AI node data interfaces |
| `packages/types/src/nodes/processing-nodes.ts` | Processing node data interfaces |
| `packages/types/src/nodes/distribution-nodes.ts` | Distribution node data interfaces |
| `packages/types/src/nodes/composition-nodes.ts` | Composition node data interfaces |
| `packages/types/src/nodes/union.ts` | WorkflowNodeData union + WorkflowNode/Edge |
| `packages/types/src/nodes/registry.ts` | NODE_DEFINITIONS registry |
| `packages/types/src/nodes/index.ts` | Barrel re-export |

### Files Modified (~15)

| File | Change |
|------|--------|
| `apps/api/src/nodes/distribution/base-output-node.ts` | Added PlatformConfig, ensureBuffer(), deliverToTargets() |
| `apps/api/src/nodes/distribution/discord-output-node.ts` | Simplified deliver(), fixed any types |
| `apps/api/src/nodes/distribution/telegram-output-node.ts` | Simplified deliver(), fixed any types |
| `apps/api/src/nodes/distribution/google-drive-output-node.ts` | Fixed drive: any, getStorageInfo: any |
| `apps/api/src/processors/base.processor.ts` | Added extractOutputUrl, saveAndNormalizeOutput, startJob, completeJob |
| `apps/api/src/processors/image.processor.ts` | Uses base methods |
| `apps/api/src/processors/video.processor.ts` | Uses base methods |
| `apps/api/src/processors/processing.processor.ts` | Uses updateProgressWithLog, base methods |
| `apps/web/src/components/settings/SettingsModal.tsx` | 558→47 lines |
| `apps/web/src/components/nodes/ai/ImageGenNode.tsx` | Uses ProcessingOverlay + useAIGenNode |
| `apps/web/src/components/nodes/ai/VideoGenNode.tsx` | Uses ProcessingOverlay + useAIGenNode |
| `apps/web/src/store/settingsStore.ts` | Added setAndPersist helper |
| `packages/types/src/index.ts` | `./nodes` → `./nodes/index` |

### Files Deleted (1)

| File | Reason |
|------|--------|
| `packages/types/src/nodes.ts` | Split into 11 modules |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| `deliverToTargets()` generic template | Shared loop in base, platform-specific via callbacks |
| `filesService` as overridable getter (not abstract) | Not all processors need file saving |
| Standardized modal backdrop to `bg-black/50` | Most common existing pattern |
| Kept deprecated store re-exports | 82 files import from them; mass migration out of scope |
| `WebhookPostNodeData` any → `Record<string, unknown> \| null` | Last `any` in types package |

### Patterns Established

- Distribution nodes: `deliverToTargets()` template method
- Processors: `startJob()`/`completeJob()`/`saveAndNormalizeOutput()` from BaseProcessor
- Modals: Shared `Modal` component with ESC + optional `ModalTabs`
- AI gen nodes: `useAIGenNode` hook for schema logic
- Settings store: `setAndPersist()` for all state+persistence actions
- Types: Split by category in `nodes/` directory with barrel re-export

### Status
- All 12 refactors implemented across 4 phases
- Not committed, not pushed
- Needs verification: `bun run check`, `bun run build:api`, `bun run build:web`

---

## Session 9: Fix Auto-Save Polling Loop After Execution Completes

**Goal:** Stop the infinite auto-save cycle where backend logs `Workflow X interface updated: 0 inputs, 0 outputs` every ~2.5s after workflow execution finishes.

### Root Cause

`updateNodeData()` unconditionally set `isDirty: true` for ALL data updates, including transient execution state (`status`, `progress`, `error`, `jobId`). Combined with `propagateOutputsDownstream` not checking for no-op updates, and post-load propagation re-dirtying state, this created an infinite save loop.

### Tasks Completed

Three targeted fixes applied:

1. **Conditional `isDirty` in `updateNodeData`** — Transient keys (`status`, `progress`, `error`, `jobId`) no longer trigger `isDirty: true`. Node data still updates in state for UI rendering, but auto-save won't fire for execution-only state changes.

2. **No-op check in `propagateOutputsDownstream`** — Before applying updates and marking dirty, compares proposed values against existing node data. If all downstream nodes already have the same input values, the update is skipped entirely.

3. **Reset `isDirty` after post-load propagation** — Both `loadWorkflow` and `loadWorkflowById` now explicitly set `isDirty: false` after the propagation loop, since post-load propagation is idempotent (restoring values already present from last save).

### Files Modified

| File | Change |
|------|--------|
| `apps/web/src/store/workflow/slices/nodeSlice.ts` | Added `TRANSIENT_KEYS` set + conditional `isDirty` in `updateNodeData`; added no-op comparison in `propagateOutputsDownstream` |
| `apps/web/src/store/workflow/slices/persistenceSlice.ts` | Added `set({ isDirty: false })` after post-load propagation in both `loadWorkflow` and `loadWorkflowById` |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| `TRANSIENT_KEYS = ['status', 'progress', 'error', 'jobId']` | These are execution-only UI state; they don't need to persist and shouldn't trigger saves |
| Shallow equality check (`!==`) in propagation | Deep equality unnecessary — propagated values are strings/primitives |
| Reset dirty in both `loadWorkflow` and `loadWorkflowById` | Both have identical propagation loops that can re-dirty state |

### Patterns Established

- Transient execution fields are explicitly separated from persisted data in the dirty-tracking logic
- Propagation functions check for actual data changes before marking state as dirty

### Status
- All changes made
- Not committed, not pushed

---

## Session 10: AI Gen Node Toolbar Refinements

**Goal:** Two UI refinements to ImageGenNode and VideoGenNode toolbars: (1) Generate button swaps to Stop when processing, (2) model name becomes clickable dropdown trigger replacing separate Browse button.

### System Flow

```
BaseNode header
├── Icon
├── titleElement (clickable model name + ChevronDown) → opens ModelBrowserModal
├── [status indicator] ← hidden via hideStatusIndicator for AI gen nodes
├── Lock button
└── headerActions
    ├── Expand (if output exists)
    └── Generate / Stop toggle button
```

### Tasks Completed

1. Added `hideStatusIndicator` prop to BaseNode — skips rendering status indicator / stop square in header
2. ImageGenNode: Generate button swaps to destructive "Generating" Stop button when `status === 'processing'`
3. ImageGenNode: Model name rendered as clickable `titleElement` with ChevronDown, opens model browser
4. ImageGenNode: Removed separate "Browse" button from headerActions
5. VideoGenNode: Same changes — clickable model name, removed Browse, changed Stop label to "Generating"
6. PromptPicker: ChevronDown now toggles to ChevronUp when dropdown is open

### Files Modified

| File | Change |
|------|--------|
| `apps/web/src/components/nodes/BaseNode.tsx` | Added `hideStatusIndicator?: boolean` prop, wrapped status indicator block with conditional, added to `arePropsEqual` comparator |
| `apps/web/src/components/nodes/ai/ImageGenNode.tsx` | Added `handleStop` from `useNodeExecution`, replaced `title` with `titleElement` (clickable model name + ChevronDown), removed Browse button, Generate/Stop toggle, added `hideStatusIndicator`, replaced `Loader2` import with `Square` + `ChevronDown` |
| `apps/web/src/components/nodes/ai/VideoGenNode.tsx` | Added `titleElement` (clickable model name + ChevronDown), removed Browse button, changed Stop label to "Generating", added `hideStatusIndicator`, added `ChevronDown` import |
| `apps/web/src/components/prompt-library/PromptPicker.tsx` | Added `ChevronUp` import, toggles between ChevronDown/ChevronUp based on `isOpen` state in both label and icon-only variants |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| `hideStatusIndicator` as opt-in prop | Only AI gen nodes manage their own stop button; all other nodes keep BaseNode's default behavior |
| ChevronDown (not ChevronsUpDown) on model name | Matches existing PromptPicker pattern — signals "click to open" |
| "Generating" label on stop button | Communicates current state while being clickable to stop |

### Patterns Established

- AI gen nodes: `titleElement` with clickable model name + chevron indicator for model browser
- AI gen nodes: `hideStatusIndicator` to manage Generate/Stop in headerActions instead of BaseNode header
- Dropdowns: ChevronDown/ChevronUp toggle to indicate open state

### Status
- All changes made
- Not committed, not pushed

---

## Session 11: Model Discovery UX + Preset Workflow Templates

**Goal:** Improve model discovery with use-case filters in ModelBrowserModal, and add 3 preset workflow templates for reference image workflows (style transfer, character variations, image remix).

### Tasks Completed

1. Added `ModelUseCase` type to provider types
2. Created 3 new workflow templates (style-transfer, character-variations, image-remix)
3. Registered templates in TEMPLATE_REGISTRY and TEMPLATE_INFO
4. Added use-case filter chips to ModelBrowserModal (purple-toned, derived from loaded models)
5. Added use-case badges to model cards (distinct from capability badges)
6. Updated Next.js API route with `useCases` in MODEL_METADATA, `detectUseCases()` from schema, and `useCase` query param
7. Updated NestJS controller with `useCases` on hardcoded models and `useCase` filter param

### Files Created (3)

| File | Purpose |
|------|---------|
| `apps/web/src/templates/style-transfer.ts` | ImageInput → Prompt → ImageGen → Output (style transfer pipeline) |
| `apps/web/src/templates/character-variations.ts` | 1 ImageInput → 3 Prompts → 3 ImageGen → 3 Outputs (parallel character scenes) |
| `apps/web/src/templates/image-remix.ts` | ImageInput → Prompt → ImageGen → Output (img2img remix) |

### Files Modified (5)

| File | Change |
|------|--------|
| `packages/types/src/nodes/providers.ts` | Added `ModelUseCase` type (6 values), added optional `useCases` field to `ProviderModel` |
| `apps/web/src/templates/index.ts` | Imported + registered 3 new templates in TEMPLATE_REGISTRY, added TEMPLATE_INFO entries (IMAGE category), added exports |
| `apps/web/src/components/models/ModelBrowserModal.tsx` | Added `USE_CASE_CONFIG` mapping, `UseCaseBadge` component, `useCaseFilter` state, use-case chips row in filters, use-case badges on model cards, `availableUseCases` derived from models |
| `apps/web/src/app/api/providers/models/route.ts` | Added `useCases` to MODEL_METADATA entries, `detectUseCases()` for schema-based detection, `useCase` query param filter, merged explicit + detected use cases in `getReplicateModels()` |
| `apps/api/src/controllers/providers.controller.ts` | Added `useCases` to REPLICATE_MODELS, `useCase` to ListModelsQuery, updated `filterModels()` with useCase filtering |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| `general` use case hidden from chips and badges | Every model is "general" — filtering by it is meaningless noise |
| Purple color scheme for use-case badges | Distinct from blue/yellow/orange provider badges and gray capability badges |
| Chips derived from loaded models | Only show use-case chips that have matching models (no empty filter states) |
| `detectUseCases()` from schema keywords | Auto-detect `ip_adapter`, `reference_image`, `mask`, `upscale` patterns in inputSchema |
| Templates use `nano-banana-pro` model | Supports image-to-image, available by default, good balance of quality/cost |
| Part 3 (template tags) skipped — Option B | Search already surfaces templates by name/description; 3 new templates don't justify a filter system |

### Patterns Established

- Use-case filtering: API accepts `useCase` query param, frontend derives available chips from model data
- Template pattern for reference image workflows: ImageInput → (optional LLM) → ImageGen with `images` handle → Output
- Model metadata includes both explicit `useCases` and schema-auto-detected ones

### Status
- All changes made
- Not committed, not pushed

---

## Session 12: Disable Inputs During Node Processing

**Goal:** Prevent users from changing model parameters and switching models while an AI gen node is actively processing.

### Tasks Completed

1. Added `disabled` prop to `SchemaInputs` — applies `pointer-events-none opacity-50` to the inputs container
2. `ImageGenNode` passes `disabled={nodeData.status === 'processing'}` to `SchemaInputs`
3. `VideoGenNode` passes `disabled={nodeData.status === 'processing'}` to `SchemaInputs`
4. Model name title button disabled and dimmed during processing in both gen nodes

### Files Modified

| File | Change |
|------|--------|
| `apps/web/src/components/nodes/SchemaInputs.tsx` | Added `disabled?: boolean` to `SchemaInputsProps`, applied `pointer-events-none opacity-50` class when disabled |
| `apps/web/src/components/nodes/ai/ImageGenNode.tsx` | Added `isProcessing` variable, disabled model name button during processing, passed `disabled` to `SchemaInputs` |
| `apps/web/src/components/nodes/ai/VideoGenNode.tsx` | Same as ImageGenNode — `isProcessing`, disabled model button, passed `disabled` to `SchemaInputs` |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| `pointer-events-none` + `opacity-50` | Visual feedback that inputs are inactive, prevents accidental param changes mid-generation |
| Disable model switcher too | Changing model during processing would be confusing — params belong to the running model |
| Prop on `SchemaInputs` (not wrapper div) | Component owns its disabled state, reusable for any future caller |

### Status
- All changes made
- Not committed, not pushed

---

## Session 13: AI Influencer Pipeline — Instagram Color Grade Node

**Goal:** Implement the `effect-color-grade` workflow node for Instagram-style post-processing of AI-generated images. Part of the AI Influencer pipeline (training is already built; this adds post-processing).

### Tasks Completed

1. Added `COLOR_GRADE = 'color-grade'` to `WorkflowStepCategory` enum
2. Created `ColorGradeExecutor` backend executor with FFmpeg filter chain builder, 4 presets, custom slider mode, and AI style transfer mode
3. Registered executor in `EXECUTOR_REGISTRY` with `getColorGradeExecutor()` accessor
4. Added `effect-color-grade` node to backend `NODE_REGISTRY` with full configSchema (mode, preset, 6 sliders, style reference)
5. Added `ColorGradeNodeData`, `ColorGradeMode`, `ColorGradePreset` frontend types
6. Created `EffectColorGradeNode.tsx` React component with mode selector, preset picker, custom sliders, AI style reference input, media preview
7. Registered in frontend `extendedNodeTypes`, `extendedNodeDefinitions`, added `effects` category

### Files Created (3)

| File | Purpose |
|------|---------|
| `cloud/packages/workflow-engine/src/executors/saas/color-grade-executor.ts` | Backend executor — `buildFfmpegFilterChain()`, `COLOR_GRADE_PRESETS`, `ColorGradeExecutor` with processor injection pattern |
| `cloud/apps/web/workflows/packages/nodes/effects/EffectColorGradeNode.tsx` | Frontend node — mode/preset selectors, 6 range sliders, AI style ref input, media preview |
| `cloud/apps/web/workflows/packages/nodes/effects/index.ts` | Barrel export |

### Files Modified (5)

| File | Change |
|------|--------|
| `cloud/packages/enums/src/workflow.enum.ts` | Added `COLOR_GRADE = 'color-grade'` |
| `cloud/packages/workflow-engine/src/executors/executor-registry.ts` | Registered `colorGrade` executor + `getColorGradeExecutor()` accessor |
| `cloud/apps/server/api/src/collections/workflows/registry/node-registry.ts` | Added `effect-color-grade` with 9-field configSchema |
| `cloud/apps/web/workflows/packages/nodes/types.ts` | Added `ColorGradeNodeData`, `ColorGradeMode`, `ColorGradePreset`, updated union types |
| `cloud/apps/web/workflows/packages/nodes/index.ts` | Registered `colorGrade` in types/definitions/categories, added `effects` category |

### Architecture

- **3 modes**: `preset` (FFmpeg, free), `custom` (FFmpeg sliders, free), `ai-style` (Replicate, 5 credits)
- **4 presets**: instagram-warm, instagram-cool, instagram-moody, instagram-bright
- **6 sliders**: warmth, contrast, saturation, vignette, grain, sharpness (0-100 scale)
- **FFmpeg filter chain**: `eq` (contrast/brightness/saturation) → `colorbalance` (warmth) → `vignette` → `unsharp` → `noise`
- **Processor injection**: Same pattern as `SoundOverlayExecutor` — processing logic injected via `setProcessor()` at runtime

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| FFmpeg preset mode as default | Free, fast, deterministic — no API calls needed |
| AI style transfer as premium mode (5 credits) | Matches existing credits pattern for AI-powered features |
| 0-100 slider scale | User-friendly; mapped to FFmpeg ranges internally |
| Separate `effects` category in frontend | Distinct from distribution/automation/repurposing |
| `HiSwatch` icon for backend registry | Color palette icon matches color grading concept |

### Patterns Established

- Effects nodes: New `effects/` directory in frontend nodes alongside distribution/automation/repurposing
- Color grade presets: Defined as constants in executor, can be extended without code changes
- FFmpeg filter builder: `buildFfmpegFilterChain()` is exported and reusable for other filter-based effects

### Remaining Work

1. Wire `ColorGradeProcessor` implementation in Cloud API (actual FFmpeg execution + S3 upload)
2. Wire AI style transfer via Replicate model in the `ai-style` mode branch
3. Add `@Credits` decorator for AI style mode in the API controller
4. Create AI Influencer Avatar workflow template chaining `imageGen → colorGrade → output`
5. Add preset visual previews (thumbnail images showing each preset's effect)

### Status
- All node infrastructure created in Cloud repo
- Not committed, not pushed
- Processor runtime implementation pending (requires Cloud API service wiring)

---

## Session 14: Performance Regressions Audit

**Duration:** ~30 minutes
**Status:** Complete

**What was done:**
- Audited recent execution and model-browsing changes for performance regressions
- Identified UI re-render fan-out from execution store updates
- Flagged SSE job update churn and model listing CPU hot path
- Proposed targeted fixes (selectors, job diffing, API route caching, handle update gating)

**Files changed:**
- `apps/web/src/components/nodes/BaseNode.tsx` - selector-based execution store access, handle update gating
- `apps/web/src/components/canvas/WorkflowCanvas.tsx` - selector-based execution store access
- `apps/web/src/components/command-palette/CommandPalette.tsx` - selector-based execution store access
- `apps/web/src/components/toolbar/Toolbar.tsx` - selector-based execution store access
- `apps/web/src/hooks/useGlobalShortcuts.ts` - selector-based execution store access
- `apps/web/src/store/execution/helpers/sseSubscription.ts` - diffed job updates + node filter
- `apps/web/src/app/api/providers/models/route.ts` - module-level cache for Replicate models
- `apps/web/src/components/ui/modal.tsx` - removed unused import from Biome pass
- `apps/web/src/app/api/replicate/webhook/route.test.ts` - removed `any` in mock assertions
- `apps/web/src/app/api/status/[id]/route.test.ts` - removed `any` in mock setup/assertions
- `apps/web/src/components/settings/SettingsModal.test.tsx` - typed `useUIStore` mock
- `apps/web/src/hooks/useContextMenu.test.ts` - typed context menu store and menu mocks
- `apps/web/src/lib/api/workflows.test.ts` - typed `apiClient` mocks
- `apps/web/src/lib/api/templates.test.ts` - typed `apiClient` mocks
- `apps/web/src/store/promptLibraryStore.test.ts` - typed `promptsApi` mocks
- `packages/workflows/src/index.ts` - typed workflow JSON nodes/edges
- `packages/workflows/__tests__/ugc-factory.spec.ts` - removed `any`, typed node lookups
- `packages/types/__tests__/distribution-nodes.spec.ts` - removed `any` casts for default data

**Decisions:**
- None

**Next steps:**
- [ ] Decide whether to implement the proposed fixes

---

## Session 15: Sentry Migration to Next.js Instrumentation API + Dev Fixes

**Goal:** Fix Sentry deprecation warnings, migrate from old `sentry.*.config.ts` pattern to Next.js instrumentation files, fix TS error, suppress Node.js deprecation warning, silence workspace root warning.

### Tasks Completed

1. Migrated Sentry from `sentry.*.config.ts` → `instrumentation.ts` + `instrumentation-client.ts` (Next.js instrumentation API)
2. Added `onRouterTransitionStart` export for navigation instrumentation
3. Replaced deprecated `disableLogger` with `bundleSizeOptimizations.excludeDebugStatements` in Sentry config
4. Added `outputFileTracingRoot` to `next.config.ts` to silence workspace root warning
5. Fixed TS2352 in `processing.processor.ts` — `nodeData as unknown as PlatformConfig` (double assertion)
6. Suppressed DEP0190 Node.js deprecation warning via `NODE_OPTIONS='--disable-warning=DEP0190'` in API dev script

### Files Created

| File | Purpose |
|------|---------|
| `apps/web/instrumentation.ts` | Server + edge Sentry init inside `register()`, `onRequestError` export |
| `apps/web/instrumentation-client.ts` | Client Sentry init with replays + `onRouterTransitionStart` |

### Files Modified

| File | Change |
|------|--------|
| `apps/web/next.config.ts` | Added `outputFileTracingRoot`, replaced `disableLogger` with `bundleSizeOptimizations.excludeDebugStatements` |
| `apps/api/src/processors/processing.processor.ts` | `nodeData as PlatformConfig` → `nodeData as unknown as PlatformConfig` |
| `apps/api/package.json` | Added `NODE_OPTIONS='--disable-warning=DEP0190'` to dev script |

### Files Deleted

| File | Reason |
|------|--------|
| `apps/web/sentry.client.config.ts` | Replaced by `instrumentation-client.ts` |
| `apps/web/sentry.server.config.ts` | Replaced by `instrumentation.ts` |
| `apps/web/sentry.edge.config.ts` | Replaced by `instrumentation.ts` |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| `instrumentation.ts` with `NEXT_RUNTIME` checks | Next.js instrumentation API — single file handles both server and edge |
| `onRequestError` export | Automatic server-side error capture without manual Sentry calls |
| Double assertion for PlatformConfig | `Record<string, unknown>` doesn't overlap with `PlatformConfig`; TS requires `unknown` intermediate |
| `--disable-warning=DEP0190` | Node.js 22+ deprecation about shell args — not actionable in NestJS context |

### Sentry Setup Status

| Component | Status |
|-----------|--------|
| Web client | Configured (instrumentation-client.ts) |
| Web server | Configured (instrumentation.ts) |
| Web edge | Configured (instrumentation.ts) |
| API backend | Configured (main.ts, conditional on SENTRY_DSN) |
| Org/Project | `genfeedai` / `core-web` (needs verification in Sentry dashboard) |
| DSN env vars | `NEXT_PUBLIC_SENTRY_DSN` + `SENTRY_DSN` — must be set to activate |

### Status
- All changes made
- Not committed, not pushed

# Session: 2026-01-16

## Session 1: Templates Modal + Welcome Modal Implementation

### Summary
Continued implementing the approved plan for Templates Modal + Welcome Modal + Settings simplification. Session was a continuation from context compaction.

### Tasks Completed

1. **Added `hasSeenWelcome` to settingsStore**
   - Added to store state initialization
   - Updated `saveToStorage()` to persist the flag
   - Implemented `setHasSeenWelcome()` action

2. **Simplified SettingsModal**
   - Removed Providers tab (API key inputs)
   - Now only has "Defaults" and "Appearance" tabs
   - Added API configuration section with `.env` instructions showing required env vars

3. **Wired up modals in page.tsx**
   - Imported `WelcomeModal` and `TemplatesModal`
   - Added `useEffect` to show welcome modal on first visit (`!hasSeenWelcome`)
   - Rendered both modal components

4. **Fixed TemplatesModal always-open bug**
   - Added `isOpen = activeModal === 'templates'` check
   - Added early return `if (!isOpen) return null`
   - Fixed useEffect to only fetch when modal is open
   - Added `isOpen` to dependency array

### Files Modified

| File | Change |
|------|--------|
| `apps/web/src/store/settingsStore.ts` | Added `hasSeenWelcome` state, persistence, and action |
| `apps/web/src/components/settings/SettingsModal.tsx` | Removed Providers tab, added .env instructions |
| `apps/web/src/app/page.tsx` | Wired up WelcomeModal and TemplatesModal |
| `apps/web/src/components/templates/TemplatesModal.tsx` | Fixed always-open bug with `isOpen` check |

### Files Created (Previous Session)
- `apps/web/src/components/welcome/WelcomeModal.tsx`
- `apps/web/src/components/templates/TemplatesModal.tsx`
- `apps/web/src/components/ui/tooltip.tsx`

### Patterns Used

1. **Modal visibility pattern**: Check `activeModal === 'modalName'` and return `null` if not open
2. **Zustand persistence pattern**: Update both store state and `saveToStorage()` function signature
3. **First-visit detection**: Use persisted boolean flag + useEffect to show onboarding

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Remove API key inputs from Settings | API keys should be in .env, not browser localStorage |
| Node Banana-style welcome modal | User preference over Weavy workspace style |
| Show .env instructions in Settings | Help users understand how to configure API keys |

### Bugs Fixed

- **TemplatesModal always open**: Missing `isOpen` check before rendering JSX

### Next Steps (if continuing)
- Test the complete flow: first visit → welcome modal → templates → load workflow
- Verify localStorage persistence of `hasSeenWelcome`

---

## Session 2: Node Palette Close Button + AudioInputNode + Auto-Layout Feature

### Summary
Added close button to node palette, created missing AudioInputNode component, and implemented auto-layout feature using dagre.

### Tasks Completed

#### 1. Added Close Button to Node Palette
- **File Modified**: `apps/web/src/components/panels/NodePalette.tsx`
- **Changes**:
  - Added `X` icon import from lucide-react
  - Added `useUIStore` import to get `togglePalette`
  - Added close button in header matching ConfigPanel pattern
- **Pattern Used**: Same as ConfigPanel close button implementation

#### 2. Created AudioInputNode Component
- **Issue**: Audio Input node was rendering as white rectangle because component didn't exist
- **Root Cause**: Type `audioInput` defined in `packages/types/src/nodes.ts` but no component existed
- **Files Created**:
  - `apps/web/src/components/nodes/input/AudioInputNode.tsx`
- **Files Modified**:
  - `apps/web/src/components/nodes/input/index.ts` - Added export
  - `apps/web/src/components/nodes/index.ts` - Added import and registered in nodeTypes
- **Features**:
  - Upload audio files (MP3, WAV, etc.)
  - Audio player when file loaded
  - Displays filename and duration
  - Remove button to clear audio
  - URL input alternative
- **Pattern Used**: Followed VideoInputNode.tsx pattern exactly

#### 3. Implemented Auto-Layout Feature
- **Dependency Added**: `@dagrejs/dagre` in `apps/web/package.json`
- **Files Created**:
  - `apps/web/src/lib/autoLayout.ts` - Dagre-based layout utility
- **Files Modified**:
  - `apps/web/src/hooks/usePaneActions.ts` - Added `autoLayout` function
  - `apps/web/src/components/Toolbar.tsx` - Added auto-layout button (LayoutGrid icon)
  - `apps/web/src/components/context-menu/menus/paneMenu.tsx` - Added menu item
  - `apps/web/src/hooks/useContextMenu.ts` - Wired up autoLayout to context menu
- **Features**:
  - Left-to-right (LR) layout by default
  - Accessible via toolbar button or right-click context menu
  - Shortcut: `L` key
  - Auto fits view after layout

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| AudioInputNode follows VideoInputNode pattern | Share similar data structure (file upload, URL input, duration display) |
| Auto-layout defaults to left-to-right (LR) | Most natural for workflow diagrams |
| Auto-layout button between panel toggles and file operations | Logical grouping with view-related actions |

### Files Summary

**Created:**
- `apps/web/src/components/nodes/input/AudioInputNode.tsx`
- `apps/web/src/lib/autoLayout.ts`

**Modified:**
- `apps/web/src/components/panels/NodePalette.tsx`
- `apps/web/src/components/nodes/input/index.ts`
- `apps/web/src/components/nodes/index.ts`
- `apps/web/package.json`
- `apps/web/src/hooks/usePaneActions.ts`
- `apps/web/src/components/Toolbar.tsx`
- `apps/web/src/components/context-menu/menus/paneMenu.tsx`
- `apps/web/src/hooks/useContextMenu.ts`

### Notes for Next Session

- Run `bun install` to install `@dagrejs/dagre` dependency
- Template node explanation: Creates reusable prompt templates with variables ({{product}}, {{style}}, etc.)
- Auto-layout supports 'TB' (top-bottom) direction as well, could add UI toggle if needed

### Patterns Established

1. **Input Node Pattern**: Follow VideoInputNode structure for file upload nodes
2. **Close Button Pattern**: Use `X` icon with `toggleX` from uiStore, styled as `p-1 hover:bg-[var(--secondary)] rounded transition`
3. **Toolbar Button Pattern**: Use `IconButton` component with tooltip
4. **Context Menu Pattern**: Add to menu options interface, pass handler via props

---

## Session 3: n8n Gap Analysis + socialPublish + rssInput Implementation

### Summary
Researched n8n content creation workflows to identify feature gaps in Genfeed, then implemented the approved priorities: added LinkedIn/Facebook/Threads to socialPublish and created a new rssInput node.

### Research Completed

#### n8n Workflow Analysis
- Reviewed 1,238+ content creation templates from [n8n workflows](https://n8n.io/workflows/categories/content-creation/)
- Identified key missing features compared to n8n capabilities
- Documented viral clip detection options (Vizard AI, Klap, DIY with Replicate)
- Saved full analysis to `/Users/decod3rs/.claude/plans/purrfect-dancing-bunny.md`

#### Key Findings
| n8n Feature | Genfeed Status |
|-------------|----------------|
| LinkedIn/Facebook/Threads publishing | **Now implemented** |
| RSS content curation | **Now implemented** |
| Viral clip detection (long-form → shorts) | Documented for later (Vizard/Klap/DIY) |
| Content scheduling | SaaS feature (later) |
| Approval workflows | Not yet |

### Tasks Completed

#### 1. Extended socialPublish with 3 New Platforms

**Files Modified:**

| File | Change |
|------|--------|
| `packages/types/src/nodes.ts:603-610` | Extended `SocialPlatform` type to include `linkedin`, `facebook`, `threads` |
| `packages/types/src/nodes.ts:1216` | Updated description to list all 7 platforms |
| `apps/web/src/components/nodes/output/SocialPublishNode.tsx:11-19` | Added 3 new platform buttons |
| `apps/web/src/components/nodes/output/SocialPublishNode.tsx:80` | Changed to 4-column grid layout for 7 buttons |

**Platform List (before → after):**
- Before: YouTube, TikTok, Instagram, Twitter
- After: YouTube, TikTok, Instagram, Twitter, **LinkedIn**, **Facebook**, **Threads**

#### 2. Created rssInput Node (New)

**Files Created:**

| File | Purpose |
|------|---------|
| `apps/web/src/components/nodes/input/RssInputNode.tsx` | Full UI component with URL/XML input modes, item navigation |
| `apps/web/src/app/api/rss/fetch/route.ts` | API endpoint that parses RSS 2.0 and Atom feeds |

**Files Modified:**

| File | Change |
|------|--------|
| `packages/types/src/nodes.ts:66` | Added `rssInput` to `NodeType` union |
| `packages/types/src/nodes.ts:152-166` | Added `RssFeedItem` interface and `RssInputNodeData` interface |
| `packages/types/src/nodes.ts:660` | Added `RssInputNodeData` to `WorkflowNodeData` union |
| `packages/types/src/nodes.ts:778-796` | Added `rssInput` to `NODE_DEFINITIONS` |
| `apps/web/src/components/nodes/BaseNode.tsx:26` | Added `Rss` icon import |
| `apps/web/src/components/nodes/BaseNode.tsx:59` | Added `Rss` to `ICON_MAP` |
| `apps/web/src/components/nodes/input/index.ts:4` | Added `RssInputNode` export |
| `apps/web/src/components/nodes/index.ts:14,39` | Added import and nodeTypes registration |

**rssInput Node Features:**
- URL mode: Paste RSS feed URL → fetch and parse
- XML mode: Paste raw XML → parse directly
- Supports both RSS 2.0 and Atom feed formats
- Item navigation with prev/next buttons
- Shows: feed title, item title, description, pub date
- Outputs text to connect to LLM node

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| 4-column grid for platforms | 7 platforms too cramped in flex layout |
| rssInput follows tweetInput pattern | Consistent UX for text input nodes |
| Support both RSS 2.0 and Atom | Cover most common feed formats |
| Skip viral clip for now | Focus on publishing and content curation first |
| Document clip detection options | Vizard API has viral scoring, Klap is simpler, DIY with Replicate is possible but complex |

### Patterns Established

1. **New Input Node Pattern**: Follow TweetInputNode structure - dual mode (URL/text), fetch API, preview component
2. **Feed Parsing Pattern**: Regex-based XML parsing with CDATA extraction, supports multiple tag variants
3. **Platform Extension Pattern**: Update SocialPlatform type → update NODE_DEFINITIONS description → update UI component

### Future Reference: Viral Clip Detection

Documented three approaches for when ready to implement:

1. **Vizard AI API**: Has viral scoring (0-10), 30+ languages, Spark 1.0 video LLM
   - Docs: https://docs.vizard.ai/docs/introduction

2. **Klap API**: Simpler, per-operation pricing, 52 languages
   - Endpoint: `POST /tasks/video-to-shorts`
   - Docs: https://docs.klap.app/endpoints/tasks

3. **DIY with Replicate**:
   - Use `transcribe` → `video-llava` → `llama` scoring → FFmpeg
   - Models: `nateraw/video-llava`, `lucataco/qwen2.5-omni-7b`

### Sources Used
- [n8n Content Creation Workflows](https://n8n.io/workflows/categories/content-creation/)
- [n8n Social Media Workflows](https://n8n.io/workflows/categories/social-media/)
- [Vizard API Docs](https://docs.vizard.ai/docs/introduction)
- [Klap API Docs](https://docs.klap.app/endpoints/tasks)

---

## Session 4: Biome Lint Fixes

### Summary
Ran `bunx biome check --write` and fixed all auto-fixable issues plus manual fixes for errors that required code changes.

### Tasks Completed

#### 1. Auto-Fixed Issues
- Biome automatically fixed 27 files (formatting, import organization)

#### 2. Manual Fixes

| File | Issue | Fix |
|------|-------|-----|
| `apps/api/webpack.config.js:1` | Missing `node:` protocol | Changed `require('path')` → `require('node:path')` |
| `apps/web/src/components/nodes/ai/VideoGenNode.tsx:3-7` | Wrong import names (unused) | Changed `VIDEO_VIDEO_ASPECT_RATIOS` → `VIDEO_ASPECT_RATIOS` (etc.) |
| `apps/web/src/app/api/rss/fetch/route.ts:42,77` | Assignment in expression | Refactored while loops to separate assignment from condition |

### Files Modified

- `apps/api/webpack.config.js`
- `apps/web/src/components/nodes/ai/VideoGenNode.tsx`
- `apps/web/src/app/api/rss/fetch/route.ts`

### Remaining Warnings (Expected)

13 warnings remain in test files (`*.spec.ts`, `*.test.ts`) for intentional `any` casts used to test invalid input edge cases. These have eslint-disable comments and are expected.

### Pattern Used

**While loop without assignment in expression:**
```typescript
// Before (Biome error)
while ((match = regex.exec(str)) !== null) { ... }

// After (Biome compliant)
let match = regex.exec(str);
while (match !== null) {
  // ... loop body
  match = regex.exec(str);
}
```

### Git Status
Branch `master` is ahead of origin by 5 commits with staged changes ready to commit.

---

## Session 5: Node Design Cleanup + ResizeNode + Replicate Schema Sync

### Summary
Cleaned up node visual design to match target style (thinner borders, solid dark gray background), removed redundant Download node, created unified ResizeNode for Luma AI resizing, and updated Replicate schema sync script with new models.

### Tasks Completed

#### 1. Node Design Cleanup
- **Changed border thickness**: `border-2` → `border` (2px → 1px)
- **Changed background**: Removed color-mixing, now solid `bg-card` for all categories
- **Kept colored borders**: Still uses `var(--category-input)`, `var(--category-ai)`, etc.

**File Modified:** `apps/web/src/components/nodes/BaseNode.tsx`

#### 2. Added Loose Connection Mode
- Added `ConnectionMode.Loose` to ReactFlow config
- Users can now drop connections anywhere on a node card (not just handle dots)
- Connection auto-snaps to closest compatible handle

**File Modified:** `apps/web/src/components/canvas/WorkflowCanvas.tsx`

#### 3. Fixed Edge Type Warning
- Changed `EdgeStyle` type from `'bezier'` to `'default'` (React Flow naming)
- Updated default value in settings store

**File Modified:** `apps/web/src/store/settingsStore.ts`

#### 4. Removed Redundant Download Node
- Removed `download` from `NodeType` union
- Removed `DownloadNodeData` interface
- Removed from `NODE_DEFINITIONS`
- OutputNode already has built-in download button

**File Modified:** `packages/types/src/nodes.ts`

#### 5. Created Unified ResizeNode
- Single node that handles both image and video resizing
- Auto-switches model based on media type dropdown
- Uses Luma AI models for reframing/resizing

**File Created:** `apps/web/src/components/nodes/processing/ResizeNode.tsx`

**Files Modified:**
- `apps/web/src/components/nodes/processing/index.ts` - Added export
- `apps/web/src/components/nodes/index.ts` - Added import and nodeTypes registration
- `packages/types/src/nodes.ts` - Updated `ResizeNodeData` to use Luma types

**ResizeNode Features:**
- Media Type dropdown (image/video) - changes model automatically
- Model display showing current model and price
- Aspect ratio selector (all Luma aspect ratios)
- Grid position selector (anchor point for outpainting)
- Optional prompt field

**Models Used:**
- Image: `photon-flash-1` ($0.01)
- Video: `luma-reframe` ($0.05)

#### 6. Updated Replicate Schema Sync Script
Added new models to sync:

| Model ID | Name | Category |
|----------|------|----------|
| `luma/reframe-image` | LumaReframeImage | reframe |
| `luma/reframe-video` | LumaReframeVideo | reframe |
| `kwaivgi/kling-v2.5-turbo-pro` | KlingV25TurboPro | video |
| `kwaivgi/kling-v2.6-motion-control` | KlingV26MotionControl | video |

**Files Modified:**
- `scripts/sync-replicate-schemas.ts` - Added 4 new models to MODELS_TO_SYNC
- `apps/api/src/replicate/replicate.service.ts` - Added `klingTurboPro` and `klingMotionControl` to MODELS constant

### Files Summary

**Created:**
- `apps/web/src/components/nodes/processing/ResizeNode.tsx`

**Modified:**
- `apps/web/src/components/nodes/BaseNode.tsx` - Thinner border, solid bg
- `apps/web/src/components/canvas/WorkflowCanvas.tsx` - ConnectionMode.Loose
- `apps/web/src/store/settingsStore.ts` - Fixed edge type naming
- `packages/types/src/nodes.ts` - Removed download, updated ResizeNodeData
- `apps/web/src/components/nodes/processing/index.ts` - Export ResizeNode
- `apps/web/src/components/nodes/index.ts` - Register ResizeNode
- `scripts/sync-replicate-schemas.ts` - Added Luma + Kling models
- `apps/api/src/replicate/replicate.service.ts` - Added Kling model constants

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Single ResizeNode vs separate image/video | Better UX - one node handles both, model auto-switches |
| Remove Download node | OutputNode already has download button, redundant |
| Use `ConnectionMode.Loose` | Easier for users to connect nodes without precise targeting |
| Add Kling models | Support start/end frame workflows (kling-v2.5-turbo-pro) |

### Next Steps
- Run `bun run sync:replicate` to download schemas for new models
- Implement Kling video generation node for start/end frame workflows
- Add more models to ResizeNode dropdown when needed

### Patterns Established

1. **Unified Media Node**: Single node with type dropdown that switches underlying model
2. **ConnectionMode.Loose**: Allow connections to any part of node card
3. **Model Schema Sync**: Add to `MODELS_TO_SYNC` in sync script, then run `bun run sync:replicate`

---

## Session 6: Minimap Settings + Workflow URL Routing

### Summary
Added minimap toggle to settings with category-colored nodes, then implemented complete workflow URL routing with dashboard at `/`, editor at `/w/[id]`, and Figma-style immediate workflow creation.

### Tasks Completed

#### 1. Minimap Settings Enhancement

**Files Modified:**
| File | Change |
|------|--------|
| `apps/web/src/store/settingsStore.ts` | Added `showMinimap` state with persistence |
| `apps/web/src/components/settings/SettingsModal.tsx` | Added toggle switch in Appearance tab |
| `apps/web/src/components/canvas/WorkflowCanvas.tsx` | Added category colors to MiniMap, dark mask |

**MiniMap Changes:**
- Added `nodeColor` function using `NODE_DEFINITIONS` to color by category
- Category colors: input=blue (#3b82f6), ai=purple (#a855f7), processing=amber (#f59e0b), output=green (#22c55e)
- Dark mask: `rgba(0, 0, 0, 0.8)` for better contrast
- Toggle controlled by `showMinimap` from settingsStore

#### 2. Workflow URL Routing (Figma-style)

**URL Structure:**
| Route | Purpose |
|-------|---------|
| `/` | Dashboard - workflow list with create/delete/duplicate |
| `/w/new` | Creates workflow, redirects to `/w/[id]` |
| `/w/[id]` | Workflow editor |

**Files Created:**
| File | Purpose |
|------|---------|
| `apps/web/src/app/w/[id]/page.tsx` | Dynamic route with loading/error states |

**Files Modified:**
| File | Change |
|------|--------|
| `apps/web/src/app/page.tsx` | Converted from editor to dashboard |
| `apps/web/src/store/workflowStore.ts` | Added `createNewWorkflow` action |
| `apps/web/src/components/Toolbar.tsx` | Home link + New button navigates to `/w/new` |
| `apps/web/src/components/templates/TemplatesModal.tsx` | Saves + navigates after template load |
| `apps/web/src/store/settingsStore.ts` | Fixed EdgeStyle: `'default'` → `'bezier'` |

**Dashboard Features:**
- Grid layout with workflow cards
- Shows: name, node count, last updated (relative time)
- Actions: delete with confirmation, duplicate → navigate
- "New Workflow" button and card both link to `/w/new`
- Empty state with call-to-action

**Editor Route Features:**
- `initRef` prevents double initialization in React StrictMode
- AbortController for proper cleanup
- Loading spinner with context message
- Error state with dashboard/new workflow options
- Welcome modal only shows after workflow loaded

**Toolbar Changes:**
- Logo replaced with Home icon linking to dashboard
- "New" button links to `/w/new` with Plus icon

**TemplatesModal Changes:**
- After template load: save workflow → close modal → navigate to `/w/[id]`
- Shows "Creating workflow..." overlay while saving
- Proper EdgeStyle casting with fallback

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Figma-style (immediate create) | User preference - workflow exists as soon as canvas opens |
| Dashboard at root (`/`) | Clean entry point, shows all workflows |
| `initRef` for initialization | Prevents double API calls in React StrictMode |
| Category colors for minimap | Better visual distinction than white squares |
| Fixed EdgeStyle to 'bezier' | Matched types package, 'default' was incorrect |

### Bug Fixes

| Bug | Fix |
|-----|-----|
| EdgeStyle type mismatch | Changed settingsStore from `'default'` to `'bezier'` |
| TemplatesModal type errors | Added EdgeStyle cast, WorkflowFile required fields |

### Patterns Established

1. **Dynamic Route Pattern**: `useParams()` + `useRef()` for init + AbortController cleanup
2. **Dashboard Pattern**: Grid of cards with dropdown menus, relative time formatting
3. **Navigation After Action**: Save workflow → get ID → `router.push(/w/[id])`
4. **Loading States**: Show spinner with context message during async operations

### Files Summary

**Created:**
- `apps/web/src/app/w/[id]/page.tsx`

**Modified:**
- `apps/web/src/app/page.tsx` (complete rewrite to dashboard)
- `apps/web/src/store/workflowStore.ts`
- `apps/web/src/store/settingsStore.ts`
- `apps/web/src/components/Toolbar.tsx`
- `apps/web/src/components/templates/TemplatesModal.tsx`
- `apps/web/src/components/canvas/WorkflowCanvas.tsx`
- `apps/web/src/components/settings/SettingsModal.tsx`

### Next Steps
- Test full flow: dashboard → new → edit → save → back to dashboard
- Verify browser back/forward navigation works correctly
- Consider adding workflow thumbnail previews to dashboard cards

---

## Session 7: NestJS Dependency Injection Fix (import type → import)

### Summary
Fixed critical NestJS startup error caused by Biome's `useImportType` rule auto-converting service imports to `import type`. This strips the class at runtime, breaking NestJS dependency injection which needs the actual class for injection tokens.

### Root Cause
Biome has a rule `useImportType` that auto-converts imports to `type` imports when only used as types. However, in NestJS:
- Services are declared as constructor parameters: `constructor(private readonly service: MyService)`
- TypeScript sees this as "only used as a type"
- Biome converts `import { MyService }` → `import type { MyService }`
- At runtime, `type` imports are stripped, so NestJS sees `Object` instead of `MyService`
- Result: `Nest can't resolve dependencies... argument Object at index [0]`

### Error Message
```
UnknownDependenciesException: Nest can't resolve dependencies of the WorkflowGeneratorService (?).
Please make sure that the argument Object at index [0] is available in the WorkflowsModule context.
```

### Solution

#### 1. Disabled `useImportType` Rule in Biome
**File Modified:** `biome.json`

```json
"style": {
  "noNonNullAssertion": "off",
  "useImportType": "off"  // Added
}
```

#### 2. Fixed All Service Imports (type → value)

**Controllers Fixed:**
| File | Services |
|------|----------|
| `app.controller.ts` | AppService |
| `executions.controller.ts` | ExecutionsService |
| `prompt-library.controller.ts` | PromptLibraryService |
| `providers.controller.ts` | FalService, HuggingFaceService |
| `replicate.controller.ts` | ReplicateService |
| `templates.controller.ts` | TemplatesService |
| `workflows.controller.ts` | CostCalculatorService, WorkflowGeneratorService, WorkflowsService |
| `bull-board.controller.ts` | JobRecoveryService, QueueManagerService |

**Services Fixed:**
| File | Dependencies |
|------|--------------|
| `replicate.service.ts` | ConfigService, CostCalculatorService, ExecutionsService, WorkflowsService |
| `workflow-generator.service.ts` | ConfigService |
| `job-recovery.service.ts` | QueueManagerService |

#### 3. Cleared Webpack Cache
```bash
rm -rf apps/api/dist
```

### Files Modified

| File | Change |
|------|--------|
| `biome.json` | Added `"useImportType": "off"` to style rules |
| `apps/api/src/app.controller.ts` | `import type { AppService }` → `import { AppService }` |
| `apps/api/src/executions/executions.controller.ts` | Fixed ExecutionsService import |
| `apps/api/src/prompt-library/prompt-library.controller.ts` | Fixed PromptLibraryService import |
| `apps/api/src/providers/providers.controller.ts` | Fixed FalService, HuggingFaceService imports |
| `apps/api/src/replicate/replicate.controller.ts` | Fixed ReplicateService import |
| `apps/api/src/replicate/replicate.service.ts` | Fixed ConfigService, CostCalculatorService, ExecutionsService, WorkflowsService imports |
| `apps/api/src/templates/templates.controller.ts` | Fixed TemplatesService import |
| `apps/api/src/workflows/workflows.controller.ts` | Fixed CostCalculatorService, WorkflowGeneratorService, WorkflowsService imports |
| `apps/api/src/workflows/workflow-generator.service.ts` | Fixed ConfigService import |
| `apps/api/src/queue/dashboard/bull-board.controller.ts` | Fixed JobRecoveryService, QueueManagerService imports |
| `apps/api/src/queue/services/job-recovery.service.ts` | Fixed QueueManagerService import |

### Pattern Established

**NestJS Service Import Rule:**
```typescript
// WRONG - breaks DI at runtime
import type { MyService } from './my.service';

// CORRECT - class available for DI token
import { MyService } from './my.service';

// OK for interfaces/types that are only used for typing
import type { MyInterface } from './interfaces';
```

### Important Notes

1. **Processors are OK**: Queue processors use `forwardRef(() => 'ServiceName')` with string tokens, so type imports work there
2. **DTOs can use type imports**: Data transfer objects are only used for typing, not DI
3. **Interfaces should use type imports**: They don't exist at runtime anyway

### Next Steps
- Restart dev server after clearing dist folder
- Verify API starts without errors
- Consider adding ESLint rule to catch this pattern in CI

---

## Session 8: Settings Help Tab + Welcome Modal Button

### Summary
Added a Help tab to the Settings modal with a button to show the welcome screen, along with resource links.

### User Questions Answered

#### 1. Where are workflows and templates stored?
Explored the codebase and documented locations:

**Saved Workflows:**
| Location | File |
|----------|------|
| Dashboard page | `apps/web/src/app/page.tsx:100-249` |
| API endpoint | `GET /workflows` at `apps/api/src/workflows/workflows.controller.ts` |
| Zustand store | `apps/web/src/store/workflowStore.ts` - `listWorkflows()` at line 759 |
| Database schema | `apps/api/src/workflows/schemas/workflow.schema.ts` |

**Templates:**
| Location | File |
|----------|------|
| Templates modal | `apps/web/src/components/templates/TemplatesModal.tsx:70-227` |
| System templates seed | `apps/api/src/templates/templates.seed.ts` |
| Frontend registry | `apps/web/src/templates/index.ts` |
| API endpoint | `GET /templates` at `apps/api/src/templates/templates.controller.ts` |

#### 2. Can the welcome modal be shown from a button?
Yes - using `useUIStore.getState().openModal('welcome')`

### Tasks Completed

#### Added Help Tab to Settings Modal

**File Modified:** `apps/web/src/components/settings/SettingsModal.tsx`

**Changes:**
1. Added icon imports: `BookOpen`, `HelpCircle`, `MessageCircle`, `Twitter`
2. Extended `TabId` type: `'defaults' | 'appearance' | 'help'`
3. Added `{ id: 'help', label: 'Help' }` to `TABS` array
4. Created `HelpTab` component with:
   - "Show Welcome Screen" button that closes Settings and opens Welcome modal
   - Resource links: Documentation, Discord, Twitter
   - Version info display
5. Added `{activeTab === 'help' && <HelpTab />}` to modal content

**Help Tab Features:**
- **Show Welcome Screen button**: Closes settings, waits 100ms, opens welcome modal
- **Documentation link**: https://docs.genfeed.ai
- **Discord link**: https://discord.gg/genfeed
- **Twitter link**: https://twitter.com/genfeedai
- **Version display**: Genfeed v0.1.0

### Code Pattern Used

**Modal chaining (close one, open another):**
```typescript
const handleShowWelcome = () => {
  closeModal();
  setTimeout(() => openModal('welcome'), 100);
};
```

### Files Modified

| File | Change |
|------|--------|
| `apps/web/src/components/settings/SettingsModal.tsx` | Added Help tab with welcome button and resource links |

### How to Access

1. Click Settings (gear icon) in toolbar
2. Click "Help" tab
3. Click "Show Welcome Screen"

### Pre-existing Issues Noted

TypeScript errors about `EdgeStyle` type mismatch in the Appearance tab (lines 148, 211) - these were pre-existing and unrelated to this session's changes.

---

## Session 9: README Tech Stack Documentation

### Summary
Updated README.md with comprehensive tech stack documentation including MongoDB Atlas reference, version numbers, and organized tables for each layer.

### Tasks Completed

#### Updated Tech Stack Section in README
- Replaced simple bullet list with organized tables
- Added version numbers from package.json files
- Added MongoDB Atlas reference with connection string examples
- Linked to official documentation for each technology

**File Modified:** `README.md`

### Changes Made

**Frontend Table:**
| Technology | Version | Description |
|------------|---------|-------------|
| Next.js | 16 | React framework |
| React | 19 | UI library |
| React Flow | 12.10 | Visual workflow editor |
| Tailwind CSS | 4.1 | Utility-first CSS |
| Zustand | 5.0 | State management |
| Radix UI | Latest | Accessible UI primitives |

**Backend Table:**
| Technology | Version | Description |
|------------|---------|-------------|
| NestJS | 11 | Node.js framework |
| MongoDB/Atlas | 8.9 (Mongoose) | Document database |
| Redis | 7 | In-memory data store |
| BullMQ | 5.66 | Job queue system |
| Replicate SDK | 1.0 | AI model API client |

**Infrastructure Table:**
| Technology | Description |
|------------|-------------|
| Bun | JavaScript runtime & package manager |
| Docker | Containerization |
| Biome | Linter & formatter |
| Vitest | Testing framework |
| Husky | Git hooks |

**AI Providers Table:**
| Provider | Use Case |
|----------|----------|
| Replicate | Image & video generation models |
| fal.ai | Fast inference endpoints |
| HuggingFace | Open-source models |

**Database Options Added:**
- Local development connection string example
- MongoDB Atlas connection string example with placeholder
- Link to get free MongoDB Atlas cluster

### Files Summary

**Modified:**
- `README.md` - Expanded tech stack section with tables, versions, and MongoDB Atlas reference

---

## Session 10: Simplified Input Node Labels

### Summary
Simplified input node labels by removing the redundant "Input" suffix since the category context is already clear.

### Tasks Completed

#### Renamed Input Nodes
Updated `NODE_DEFINITIONS` in `packages/types/src/nodes.ts` to use shorter labels:

| Before | After |
|--------|-------|
| Image Input | Image |
| Audio Input | Audio |
| Video Input | Video |
| Tweet Input | Tweet |
| RSS Input | RSS |

### Files Modified

| File | Change |
|------|--------|
| `packages/types/src/nodes.ts` | Updated `label` and `defaultData.label` for 5 input nodes |

### Rationale
User requested: "no need for 'audio input', 'rss input', just call it 'audio', 'rss' because i know they are all inputs."

The input category grouping in the node palette already provides context, making "Input" suffix redundant.

---

## Session 11: Architecture Discussion - NestJS vs Next.js API + Deployment

### Summary
Brief architecture consultation session. Discussed backend architecture choices and deployment options.

### Questions Answered

#### 1. Should I use NestJS or Next.js API routes?

**Verdict: NestJS is justified for this project.**

Reasons to keep NestJS:
- BullMQ job queues (background processing doesn't fit serverless)
- Multi-tenant architecture with organization-scoped queries
- MongoDB with compound indexes and repository patterns
- Redis for caching (persistent connections expensive in serverless)
- Potential WebSockets for real-time features

Alternative suggested: Hybrid approach
- NestJS for workers/queues only
- Next.js API for simple routes
- Best of both: Vercel handles simple stuff, NestJS handles async work

#### 2. EC2 vs alternatives (currently 200€/mo)

**Alternatives compared:**

| Option | Cost | Notes |
|--------|------|-------|
| Railway | ~$20-50/mo | Easy, native NestJS/Redis support |
| Render | ~$25-50/mo | Free tier, background workers |
| Fly.io | ~$20-40/mo | Global edge, good for WebSockets |
| Hetzner | ~€10-20/mo | Cheapest VPS, EU-based |
| DigitalOcean | ~$24-48/mo | Middle ground |

**Cost reduction suggestions for staying on EC2:**
- Reserved instances (30-40% savings with 1-year commit)
- Spot instances for non-critical workers
- Right-size check with htop/CloudWatch

**User decision:** Keep AWS EC2, optimize later. Focus on product first.

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Keep NestJS | Background jobs, queues, stateful connections justify it |
| Keep AWS EC2 | Working infrastructure > premature optimization |
| Scale later | Ship product first, revisit infra when it's a bottleneck |

### No Files Modified

This was a consultation-only session.

---

## Session 12: Queue-Based Execution Architecture + Circular Dependency Fixes

### Summary
Refactored the execution architecture from polling-based to queue-based with SSE (Server-Sent Events) for real-time updates. Fixed multiple circular dependency issues in NestJS modules. Also fixed a UI bug with white backgrounds behind selected nodes.

### Tasks Completed

#### 1. Fixed White Background Behind Selected Nodes

**Issue:** Selected nodes showed a white/light background between the node and the selection ring.

**Root Cause:** `ring-offset-2 ring-offset-background` in BaseNode.tsx was using the CSS `--background` variable which was light-colored.

**Fix:** Removed the ring-offset classes.

**File Modified:** `apps/web/src/components/nodes/BaseNode.tsx`
```typescript
// Before
isSelected && 'ring-2 ring-offset-2 ring-offset-background',

// After
isSelected && 'ring-2',
```

#### 2. Identified Architecture Problem

**Issue:** Frontend was calling `/api/replicate/*` which hit Next.js API routes, duplicating logic that already existed in NestJS.

**Problems with old approach:**
- Replicate API key needed in both apps/api/.env AND apps/web/.env
- Duplicate code paths
- Polling (120 requests over 10 minutes per job)
- No persistence - refresh loses job state

#### 3. Implemented Queue-Based Execution Architecture

**New Flow:**
```
Frontend → NestJS API → BullMQ Queue → Worker → Replicate
                ↓                          ↓
           SSE Stream  ←─────── Webhook callback
```

**Changes:**

##### ExecutionsController (apps/api/src/executions/executions.controller.ts)
- `createExecution()` now calls `queueManager.enqueueWorkflow()` after creating execution
- Added SSE endpoint `GET /executions/:id/stream` for real-time status updates
- Used `@Inject(forwardRef(() => QueueManagerService))` for circular dependency

##### ExecutionsModule (apps/api/src/executions/executions.module.ts)
- Added `forwardRef(() => QueueModule)` to imports

##### Frontend executionStore (apps/web/src/store/executionStore.ts)
- **Full workflow execution:** Uses SSE for real-time updates (no polling)
- **Single node execution:** Direct API call + polling (for testing individual nodes)
- Added `executionId`, `eventSource` state
- Workflow must be saved before execution

#### 4. Fixed Circular Dependency Issues

**ReplicateModule (apps/api/src/replicate/replicate.module.ts)**
```typescript
// Before
imports: [ExecutionsModule, WorkflowsModule, CostModule],

// After
imports: [forwardRef(() => ExecutionsModule), forwardRef(() => WorkflowsModule), CostModule],
```

**ReplicateService (apps/api/src/replicate/replicate.service.ts)**
```typescript
constructor(
  private readonly configService: ConfigService,
  @Inject(forwardRef(() => ExecutionsService))
  private readonly executionsService: ExecutionsService,
  @Inject(forwardRef(() => WorkflowsService))
  private readonly workflowsService: WorkflowsService,
  private readonly costCalculatorService: CostCalculatorService
) { ... }
```

**ExecutionsController (apps/api/src/executions/executions.controller.ts)**
```typescript
constructor(
  private readonly executionsService: ExecutionsService,
  @Inject(forwardRef(() => QueueManagerService))
  private readonly queueManager: QueueManagerService
) {}
```

### Files Modified

| File | Change |
|------|--------|
| `apps/web/src/components/nodes/BaseNode.tsx` | Removed ring-offset from selected state |
| `apps/web/src/store/executionStore.ts` | Complete rewrite for SSE-based execution |
| `apps/api/src/executions/executions.controller.ts` | Added SSE endpoint, enqueue workflow, forwardRef |
| `apps/api/src/executions/executions.module.ts` | Added QueueModule import with forwardRef |
| `apps/api/src/replicate/replicate.module.ts` | Added forwardRef for ExecutionsModule, WorkflowsModule |
| `apps/api/src/replicate/replicate.service.ts` | Added @Inject(forwardRef()) for dependencies |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| SSE over WebSockets | Simpler for unidirectional server→client updates |
| Keep polling for single node | Individual node execution doesn't need queue overhead |
| forwardRef pattern | Standard NestJS solution for circular module dependencies |
| Save workflow before execution | Execution needs workflowId to track in database |

### Patterns Established

**NestJS Circular Dependency Pattern:**
```typescript
// Module level
imports: [forwardRef(() => OtherModule)]

// Service/Controller level
@Inject(forwardRef(() => OtherService))
private readonly otherService: OtherService
```

**SSE Subscription Pattern (Frontend):**
```typescript
const eventSource = new EventSource(`${API_URL}/stream`);
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  // Update state
};
eventSource.onerror = () => {
  eventSource.close();
};
// Cleanup on unmount
return () => eventSource.close();
```

### For Webhook Testing (Local Dev)

To test Replicate webhooks locally:
1. Add to `apps/api/.env`: `WEBHOOK_BASE_URL=https://your-id.ngrok.io`
2. Run: `ngrok http 3001`
3. Replicate will call back to your ngrok URL

### API Changes

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/workflows/:workflowId/execute` | POST | Create execution + enqueue workflow |
| `/executions/:id/stream` | GET (SSE) | Real-time execution status stream |

### Next Steps (if continuing)
- Test full SSE flow end-to-end
- Add ngrok setup for webhook testing
- Consider adding progress percentage to SSE updates
- May need to handle SSE reconnection on network errors

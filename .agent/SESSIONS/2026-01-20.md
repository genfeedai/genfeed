# Session: 2026-01-20

## Session 1: CLI + Workflows Packages
Fixed ESM module resolution, missing directory creation, workflow edge bug, and tsconfig build error in `packages/cli/` and `packages/workflows/`.

**Files:** `packages/cli/src/utils/npm.ts`, `packages/cli/src/commands/add.ts`, `packages/cli/tsconfig.json`, `packages/workflows/workflows/image-series.json`

---

## Session 2: React Flow Drop-to-Connect & Env Config
Added `allowedDevOrigins` to Next.js config. Implemented drop-to-connect: drag connection to node body auto-connects to first compatible handle.

**Files:** `cloud/configs/next.config.base.ts`, `apps/web/src/store/workflowStore.ts` (added `findCompatibleHandle`), `apps/web/src/components/canvas/WorkflowCanvas.tsx` (added `onConnectEnd`)

---

## Session 3: Output Node White Background & Edge Crossing
Fixed React Flow default white background on nodes. Added `useOptimalHandleOrder` hook to sort input handles by source node Y position (prevents edge crossings).

**Files:** `apps/web/src/app/globals.scss`, `apps/web/src/hooks/useOptimalHandleOrder.ts` (new), `apps/web/src/components/nodes/BaseNode.tsx`

---

## Session 4: API Refactor - Centralize Structure + Path Aliases
Major refactor: moved all controllers, services, modules, schemas, DTOs, interfaces, processors into dedicated folders. Converted all relative imports to `@/` path aliases.

**Files:** 50+ files moved/updated. New structure: `controllers/`, `services/`, `modules/`, `schemas/`, `dto/`, `interfaces/`, `processors/`

---

## Session 5: Settings Modal & Node Category Colors
Fixed settings modal full-height issue (now centered auto-height). Changed processing node color from teal to blue. Created `lib/constants/colors.ts` for shared color constants.

**Files:** `apps/web/src/components/settings/SettingsModal.tsx`, `apps/web/src/app/globals.scss`, `apps/web/src/lib/constants/colors.ts` (new)

---

## Session 6: React 18 Strict Mode Bug Fix
Removed `initRef` pattern that broke workflow loading on strict mode remount. AbortController alone handles cleanup.

**Files:** `apps/web/src/app/w/[id]/page.tsx`

---

## Session 7: Unified Reframe & Upscale Nodes
Consolidated 4 nodes into 2 unified nodes with auto-detect input type. Added `NODE_ORDER` constant for explicit node ordering per category.

**Created:** `ReframeNode.tsx`, `UpscaleNode.tsx`
**Deleted:** `LumaReframeImageNode`, `LumaReframeVideoNode`, `TopazImageUpscaleNode`, `TopazVideoUpscaleNode`
**Files:** `packages/types/src/nodes.ts`, `apps/api/src/interfaces/job-data.interface.ts`, `apps/api/src/services/replicate.service.ts`

---

## Session 8: Clean Up `as any` Types
Replaced `as any` with proper types or `as never` for invalid type tests. Zero Biome errors.

**Files:** Test files in `apps/api/`, `packages/core/`, `apps/web/`

---

## Session 9: Lint Fixes + Biome/VSCode Config
Fixed React Rules of Hooks violation (hook after early return). Fixed parseInt radix. Synced Biome import organization.

**Files:** `apps/web/src/components/nodes/BaseNode.tsx`, `apps/api/src/services/ffmpeg.service.ts`, `.vscode/settings.json`

---

## Session 10: Interface Placement Guidelines
Documented scope-based interface placement: file-local inline OK, shared interfaces in `interfaces/` or `packages/types/`.

**Files:** `.agent/SYSTEM/RULES.md`

---

## Session 11: Clean Up Relative Imports + Code Simplification
Converted 29 relative imports to `@/` path aliases. Added `createSeparator()` helper to ContextMenu. Refactored ffmpeg.service with `withTempFiles()` and `handleFFmpegError()`.

**Files:** 29 node/menu components, `apps/api/src/services/ffmpeg.service.ts`

---

## Session 12: Fix Build Error - Deprecated Node Types
Updated all references from old node types (`lumaReframeImage`, etc.) to unified names (`reframe`, `upscale`).

**Files:** Template files, queue constants, processors, DTOs, controllers, stores, preview components

---

## Session 13: Output Node Video Auto-Play
Added `autoPlay muted loop playsInline` to video element, removed controls.

**Files:** `apps/web/src/components/nodes/output/OutputNode.tsx`

---

## Session 14: Workflow Composition Feature
Implemented workflowRef nodes for nested workflow execution. Created `WorkflowInputNode`, `WorkflowOutputNode`, `WorkflowRefNode`. Added child execution tracking with depth protection (MAX_DEPTH=10).

**Created:** `apps/web/src/components/nodes/composition/` (3 nodes)
**Files:** `apps/api/src/processors/workflow.processor.ts`, `apps/api/src/services/executions.service.ts`, `packages/types/src/nodes.ts`

---

## Session 15: Disable Generate Buttons When Inputs Missing
Created `useRequiredInputs` hook. Updated AI and processing nodes to disable buttons when required inputs not connected.

**Created:** `apps/web/src/hooks/useRequiredInputs.ts`
**Files:** `ImageGenNode`, `VideoGenNode`, `LLMNode`, `TranscribeNode`, `VideoTrimNode`, `AnimationNode`

---

## Session 16: Workflow Generator Model Selection
Added model dropdown to AI Workflow Generator. Fixed DeepSeek R1 compatibility (prepends system prompt to user prompt).

**Files:** `apps/web/src/components/workflow/GenerateWorkflowModal.tsx`, `apps/api/src/services/workflow-generator.service.ts`

---

## Session 17: Template Explorer Enhancement
Rewrote TemplatesModal with sidebar layout, search, category/provider filters, marketplace CTA.

**Created:** `apps/web/src/lib/template-utils.ts`
**Files:** `apps/web/src/components/templates/TemplatesModal.tsx`, `apps/api/src/services/templates.service.ts`

---

## Session 18: Prompt Node Expand Button
Added expand button to PromptNode that opens modal for easier editing.

**Created:** `apps/web/src/store/promptEditorStore.ts`, `apps/web/src/components/prompt-editor/PromptEditorModal.tsx`
**Files:** `apps/web/src/components/nodes/input/PromptNode.tsx`

---

## Session 19: Replace Logo with CDN
Replaced placeholder gradient logos with `https://cdn.genfeed.ai/assets/branding/logo-white.png`.

**Files:** `apps/web/src/components/Toolbar.tsx`, `apps/web/src/components/welcome/WelcomeModal.tsx`

---

## Session 20: Reduce Canvas Dot Visibility
Changed background dots to `rgba(255, 255, 255, 0.08)` for reduced eye strain.

**Files:** `apps/web/src/components/canvas/WorkflowCanvas.tsx`

---

## Session 21: Node-Banana Feature Integration
Added keyboard shortcuts (Shift+V/I/P/L for nodes), node dimension utilities, comment navigation system, DB-backed user settings.

**Created:** `apps/web/src/lib/utils/nodeDimensions.ts`, `apps/web/src/hooks/useCommentNavigation.ts`, `apps/api/src/schemas/user-settings.schema.ts`, `apps/api/src/services/settings.service.ts`, `apps/api/src/controllers/settings.controller.ts`, `apps/web/src/lib/api/settings.ts`
**Files:** `packages/types/src/nodes.ts` (added `comment`), `apps/web/src/store/workflowStore.ts`, `apps/web/src/store/settingsStore.ts`

---

## Session 22: Consolidate localStorage Keys
Moved `autoSaveEnabled` from uiStore to settingsStore. Single key: `genfeed-settings`.

**Files:** `apps/web/src/store/settingsStore.ts`, `apps/web/src/store/uiStore.ts`

---

## Session 23: Fix Build Error + README Setup Guide
Fixed templates API signature mismatch. Added comprehensive setup guide for Replicate/MongoDB/Redis.

**Files:** `apps/web/src/lib/api/templates.ts`, `README.md`

---

## Session 24: Hide ConfigPanel When No Node Selected
Changed empty state from placeholder UI to `return null`.

**Files:** `apps/web/src/components/panels/ConfigPanel.tsx`

---

## Session 25: Node UI Improvements
Added `headerActions` slot to BaseNode. Moved PromptNode toolbar to header. Created compact dropdown layout in ImageGenNode.

**Files:** `apps/web/src/components/nodes/BaseNode.tsx`, `apps/web/src/components/nodes/input/PromptNode.tsx`, `apps/web/src/components/nodes/ai/ImageGenNode.tsx`

---

## Session 26: UI Theme Update + Route Restructure
Replaced green/teal accents with white/grey. Moved routes from `/w/` to `/workflows/`. Added gallery filters and delete all.

**Created:** `apps/web/src/app/workflows/page.tsx`, `apps/web/src/app/page.tsx` (redirect)
**Files:** Gallery and dashboard pages, Toolbar, TemplatesModal

---

## Session 27: Auto-Save Timing + Workflow Preview Fixes
Reduced auto-save delay to 2.5s. Fixed WorkflowPreview with auto-layout by topological depth. Added hover dimming to dashboard cards.

**Files:** `apps/web/src/hooks/useAutoSave.ts`, `apps/web/src/components/WorkflowPreview.tsx`, `apps/web/src/app/workflows/page.tsx`

---

## Session 28: Remove "New Workflow" Button from Header
Removed redundant header button, kept "New Workflow" card in grid.

**Files:** `apps/web/src/app/workflows/page.tsx`

---

## Session 29: Fix "No workflows yet" Flash
Added `hasFetched` flag to prevent false empty state during re-mount.

**Files:** `apps/web/src/app/workflows/page.tsx`

---

## Session 30: Highlight Node Dependencies on Selection
Unconnected nodes dim to 40%, connected edges glow. Added `getConnectedNodeIds` (BFS traversal) to workflowStore.

**Files:** `apps/web/src/store/workflowStore.ts`, `apps/web/src/store/uiStore.ts`, `apps/web/src/components/canvas/WorkflowCanvas.tsx`, `apps/web/src/components/nodes/BaseNode.tsx`, `apps/web/src/app/globals.scss`

---

## Session 31: Command Palette + Fix Subworkflow API Route
Implemented command palette (âŒ˜+K). Fixed NestJS route ordering: static routes must come before parameterized routes.

**Created:** `apps/web/src/store/commandPaletteStore.ts`, `apps/web/src/components/command-palette/`, `apps/web/src/hooks/useGlobalShortcuts.ts`
**Files:** `apps/api/src/controllers/workflows.controller.ts` (reordered routes)

---

## Session 32: n8n-Style Minimap
Minimap shows on pan/zoom, hides after 1.5s delay with fade animation.

**Files:** `apps/web/src/components/canvas/WorkflowCanvas.tsx`

---

## Session 33: Node UI Refinements
ImageGenNode shows model name as title. PromptPicker has marketplace link. PromptNode label is dropdown trigger.

**Files:** `apps/web/src/components/nodes/BaseNode.tsx` (added `title`, `titleElement` props), `apps/web/src/components/nodes/ai/ImageGenNode.tsx`, `apps/web/src/components/prompt-library/PromptPicker.tsx`, `apps/web/src/components/nodes/input/PromptNode.tsx`

---

## Session 34: Node Palette Search + Sidebar Toggle
Added search to NodePalette. Moved sidebar toggle into sidebar. Added slide animation.

**Files:** `apps/web/src/components/panels/NodePalette.tsx`, `apps/web/src/components/Toolbar.tsx`, `apps/web/src/app/workflows/[id]/page.tsx`

---

## Session 35: n8n-Inspired Cloud Workflow Features
Created 6 cloud-only nodes: PlatformExportNode, CaptionGenNode, WebhookTriggerNode, ReviewGateNode, ClipSelectorNode, PlatformMultiplierNode. Added webhook endpoints.

**Created:** `cloud/web/workflows/packages/nodes/` (distribution, automation, repurposing subdirs)
**Files:** Cloud monorepo workflow schema, services, controllers

---

## Session 36: Turbo Logging Configuration
Created `turbo.json` with `outputLogs: "full"`. Added `logs/` to gitignore. Updated dev script to pipe errors to `logs/errors.log`.

**Created:** `turbo.json`, `logs/.gitkeep`
**Files:** `.gitignore`, `package.json`

---

## Session 37: Compact Session File
Rewrote session file from 2527 lines to ~275 lines (~90% reduction) while preserving all 36 sessions with essential info.

**Files:** `.agent/SESSIONS/2026-01-20.md`

---

## Session 38: Code Simplification Post-PreviewNode Removal

Cleaned up code following PreviewNode deprecation. Extracted shared utility, generated node mapping dynamically, removed dead history code.

**Created:** `apps/web/src/lib/utils/mediaExtraction.ts` (shared `getMediaFromNode()` function)

**Modified:**
- `apps/web/src/components/nodes/PreviewTooltip.tsx` - removed duplicate function, uses shared utility
- `apps/web/src/components/nodes/NodeDetailModal.tsx` - removed duplicate function, dead `TabButton` component, dead `outputHistory` useMemo, history tab UI that never showed
- `apps/web/src/components/WorkflowPreview.tsx` - replaced 23-line manual node type mapping with dynamic generation from `NODE_DEFINITIONS`

**Lines saved:** ~65 lines of duplicate/dead code

---

## Session 39: Biome Lint Fixes

Ran `bunx biome check --write` and fixed all linting errors.

**Auto-fixed (25 files):**
- Template literals, unused variables, useless fragments, autoFocus a11y warnings, extra useEffect dependencies

**Manual fix:**
- `apps/web/src/components/WorkflowPreview.tsx:98` - Changed `nodes.forEach((n) => getDepth(n.id))` to `for...of` loop to avoid implicit return in forEach callback

**Result:** All 317 files pass Biome checks.

---

## Session 40: Core OSS Roadmap Implementation

Implemented 5 major features from the Core OSS roadmap:

### 1. Export/Import Workflows (High Priority)
**Files:**
- `apps/api/src/dto/import-workflow.dto.ts` (new) - Import validation DTO
- `apps/api/src/interfaces/workflow-export.interface.ts` (new) - Export format definition
- `apps/api/src/services/workflows.service.ts` - Added `exportWorkflow()` and `importWorkflow()` methods
- `apps/api/src/controllers/workflows.controller.ts` - Added `/workflows/:id/export` and `/workflows/import` endpoints
- `apps/web/src/lib/api/workflows.ts` - Added `export`, `import`, `downloadAsFile`, `importFromFile` functions

**Features:**
- Versioned export format (v1.0.0) for future migrations
- Strips sensitive/internal data on export
- Regenerates node/edge IDs on import to avoid conflicts
- Client-side helpers for file download/upload

### 2. Ollama Integration (High Priority)
**Files:**
- `apps/api/src/services/ollama.service.ts` (new) - Ollama API client with streaming support
- `apps/api/src/modules/ollama.module.ts` (new) - NestJS module
- `apps/api/src/processors/llm.processor.ts` - Added Ollama provider support
- `apps/api/src/modules/worker.module.ts` - Integrated OllamaModule
- `apps/api/src/interfaces/job-data.interface.ts` - Added `provider` and `ollamaModel` to LLMJobData

**Features:**
- `OLLAMA_ENABLED=true` enables local LLM inference
- Configurable base URL and default model
- Automatic fallback to Replicate if Ollama unavailable
- Streaming support for future SSE integration

### 3. Custom Node SDK (High Priority)
**Files:** `packages/sdk/` (new package)
- `src/index.ts` - Main exports
- `src/types.ts` - Node definition, handle, config interfaces
- `src/node-builder.ts` - Fluent builder API for creating nodes
- `src/handle-utils.ts` - Helper functions for creating handles
- `src/registry.ts` - Global node registry for runtime registration
- `src/validation.ts` - Node definition and data validation
- `src/react/hooks.ts` - React hooks for node components
- `src/react/components.tsx` - Config panel renderer
- `README.md` - Comprehensive documentation

**Features:**
- Fluent builder API: `createNode('type').name(...).input(...).build()`
- Handle helpers: `imageInput()`, `videoOutput()`, etc.
- Config schema for settings panels
- Plugin manifest for npm distribution
- React hooks for node UI development

### 4. Health Checks + Metrics (Medium Priority)
**Files:**
- `apps/api/src/interfaces/health.interface.ts` (new) - Health check types
- `apps/api/src/controllers/app.controller.ts` - Added health endpoints
- `apps/api/src/services/app.service.ts` - Full rewrite with health checks

**Endpoints:**
- `GET /health/live` - Kubernetes liveness probe
- `GET /health/ready` - Kubernetes readiness probe
- `GET /health/detailed` - Component health with latency
- `GET /metrics` - System and application metrics

**Features:**
- MongoDB and Redis health checks with latency measurement
- Queue metrics (waiting, active, completed, failed)
- Memory and CPU usage tracking
- Workflow and execution counts

### 5. Kling Motion Control Node (Medium Priority)
**Files:**
- `packages/types/src/nodes.ts` - Added `motionControl` type and `MotionControlNodeData`
- `apps/api/src/interfaces/job-data.interface.ts` - Added `MotionControlJobData`
- `apps/api/src/queue/queue.constants.ts` - Added queue mapping
- `apps/api/src/services/replicate.service.ts` - Added `generateMotionControlVideo()` method
- `apps/api/src/processors/video.processor.ts` - Added motion control handling

**Features:**
- Three motion modes: trajectory, camera, combined
- Trajectory points for path-based animation
- Camera movements: pan, zoom, rotate, dolly
- Adjustable motion strength and camera intensity

### 6. Feature Split Documentation
**Files:** `.agent/SYSTEM/FEATURE-SPLIT.md` (new)
- Documents Core OSS vs Cloud SaaS feature boundaries
- Lists SaaS-only features (teams, billing, marketplace)
- Decision criteria for feature placement
- AI agent guidelines

---

## Key Patterns Established

- **React Flow**: `onConnectEnd` for drop-to-connect, `onMoveStart/End` for minimap visibility
- **Node validation**: `useRequiredInputs` hook checks edge connections
- **API routes**: Static routes before parameterized in NestJS
- **UI dimming**: `[&:hover>*]:opacity-40 [&:hover>*:hover]:opacity-100`
- **CSS variables**: `--category-*` for node colors in globals.scss
- **Settings sync**: localStorage for fast reads, API for persistence
- **Empty states**: Use `hasFetched` flag to prevent flash
- **Shared utilities**: Extract duplicate functions to `lib/utils/` (e.g., `mediaExtraction.ts`)
- **Dynamic mappings**: Generate type mappings from source-of-truth objects (e.g., `NODE_DEFINITIONS`)
- **Biome lint**: Use `for...of` instead of `forEach` when callback returns a value

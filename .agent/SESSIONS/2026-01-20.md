# Session: 2026-01-20

## Session 1: Finish CLI + Workflows Packages

**Duration:** ~15 minutes
**Status:** Completed

### Summary

Finished the `packages/cli/` and `packages/workflows/` packages by fixing 3 bugs and a build configuration issue.

### Tasks Completed

1. **Fixed ESM Module Resolution Bug** (`packages/cli/src/utils/npm.ts`)
   - Added `createRequire` from `node:module` for cross-compatible require.resolve()
   - Simplified `resolvePackagePath` function by removing unnecessary ESM fallback

2. **Fixed Missing Parent Directory Creation** (`packages/cli/src/commands/add.ts`)
   - Added `mkdirSync(dirname(outputPath), { recursive: true })` before `writeFileSync`
   - Allows `--output` flag with nested paths like `./deep/nested/workflow.json`

3. **Fixed Workflow Edge Bug** (`packages/workflows/workflows/image-series.json`)
   - Output node now connects to all 3 image generation nodes (was only connecting to imageGen-2)
   - Added edges e5, e6, e7 for imageGen-1, imageGen-2, imageGen-3 respectively

4. **Fixed Build Configuration** (`packages/cli/tsconfig.json`)
   - Changed `rootDir` from `./src` to `.` to include both src/ and bin/ directories
   - Resolved tsup DTS build error

### Files Modified

| File | Change |
|------|--------|
| `packages/cli/src/utils/npm.ts` | Added createRequire, simplified resolvePackagePath |
| `packages/cli/src/commands/add.ts` | Added mkdirSync for directory creation |
| `packages/cli/tsconfig.json` | Changed rootDir to "." |
| `packages/workflows/workflows/image-series.json` | Added 2 missing output edges |

### Verification

- Both packages build successfully (`bun run build`)
- `list` command shows all 5 workflows
- `info` command shows correct edge count (7 edges)
- `add` command with nested output path creates directories correctly

### Not Committed

Changes are ready but not committed. Packages still untracked in git.

### Next Steps

1. Commit the new packages
2. Update root package.json workspace entries if needed
3. Test npx invocation / npm publish

---

## Session 2: React Flow Drop-to-Connect & Environment Config Fixes

**Duration:** ~20 minutes
**Status:** Completed

### Summary

Fixed environment configuration issues for the web app and implemented drop-to-connect functionality for React Flow nodes.

### Tasks Completed

1. **Fixed allowedDevOrigins Warning** (`cloud/configs/next.config.base.ts`)
   - Added `allowedDevOrigins: ["local.genfeed.ai"]` to shared Next.js config
   - Resolves cross-origin warning for dev servers using custom domains

2. **Diagnosed NEXT_PUBLIC_API_URL Issue** (`apps/web/.env`)
   - User's .env had `NEXT_PUBLIC_API_URL=localhost:3001` (missing `http://` and `/api`)
   - Correct value: `NEXT_PUBLIC_API_URL=http://localhost:3001/api`

3. **Implemented Drop-to-Connect for React Flow Nodes**
   - Users can now drag a connection from an output handle and drop anywhere on a target node
   - Automatically connects to the first compatible input handle

### Files Modified

| File | Change |
|------|--------|
| `cloud/configs/next.config.base.ts` | Added `allowedDevOrigins` for dev cross-origin support |
| `apps/web/src/store/workflowStore.ts` | Added `findCompatibleHandle()` function to interface and implementation |
| `apps/web/src/components/canvas/WorkflowCanvas.tsx` | Added `onConnectEnd` handler for auto-connecting on node drop |

### Technical Details

**findCompatibleHandle()** in workflowStore:
- Takes sourceNodeId, sourceHandleId, targetNodeId
- Uses `CONNECTION_RULES` to find type-compatible handles
- Skips handles already connected
- Returns first compatible handle ID or null

**handleConnectEnd** in WorkflowCanvas:
- Detects drops on `.react-flow__node` elements
- Skips if dropped directly on a handle (normal connection flow)
- Calls `findCompatibleHandle()` to get target handle
- Creates connection via `onConnect()`

### Patterns Established

- React Flow connection customization via `onConnectEnd` callback
- Type-safe casting with `as never` for complex React Flow callback types
- Centralized Next.js config in `cloud/configs/next.config.base.ts` for all 14 web apps

### Not Committed

Changes made but not committed. User should test and commit when ready.

---

## Session 3: Fix Output Node White Background & Edge Crossing

**Duration:** ~10 minutes
**Status:** Completed

### Summary

Fixed two UI issues in the workflow canvas: white background on Output node caused by React Flow defaults, and implemented auto-ordering of input handles to prevent edge crossings.

### Tasks Completed

1. **Fixed White Background on Output Node** (`apps/web/src/app/globals.scss`)
   - React Flow's default node styling was adding white background
   - Added CSS override to make `.react-flow__node` transparent with no border/padding

2. **Implemented Auto-Ordering of Input Handles** (new hook + BaseNode update)
   - Created `useOptimalHandleOrder` hook that sorts input handles by connected source node Y positions
   - When source nodes are arranged vertically, handles reorder to minimize edge crossings
   - Handles dynamically reposition as nodes are moved

### Files Modified

| File | Change |
|------|--------|
| `apps/web/src/app/globals.scss` | Added transparent background override for `.react-flow__node` |
| `apps/web/src/hooks/useOptimalHandleOrder.ts` | **NEW** - Hook to sort input handles by source node Y position |
| `apps/web/src/hooks/index.ts` | Added export for new hook |
| `apps/web/src/components/nodes/BaseNode.tsx` | Integrated `useOptimalHandleOrder`, removed unused `hasError` variable |

### Technical Details

**useOptimalHandleOrder hook:**
- Takes nodeId and array of HandleDefinition
- Gets incoming edges from workflowStore
- Uses `getNode()` from React Flow to get source node positions
- Sorts connected handles by source Y position
- Returns reordered handles array (connected first sorted by Y, then unconnected)

**CSS Override:**
```scss
&__node {
  background: transparent !important;
  border: none !important;
  padding: 0 !important;
}
```

### Patterns Established

- Custom hooks for React Flow handle positioning
- CSS `!important` overrides for React Flow library defaults in globals.scss

### Not Committed

Changes made but not committed. User should test and commit when ready.

---

## Session 4: API Refactor - Centralize Controllers/Services + Path Aliases

**Duration:** ~25 minutes
**Status:** Completed

### Summary

Major refactor of the NestJS API structure to centralize controllers and services into dedicated folders and convert all relative imports to `@/` path aliases.

### Tasks Completed

1. **Updated tsconfig.json with comprehensive path aliases**
   - Added `@/controllers/*`, `@/services/*`, `@/modules/*`, `@/schemas/*`, `@/dto/*`, `@/interfaces/*`, `@/processors/*`, `@/queue/*`, `@/test/*`

2. **Created new folder structure**
   - `controllers/` - All controller files with their specs
   - `services/` - All service files with their specs
   - `modules/` - All module files
   - `schemas/` - All schema files
   - `dto/` - All DTO files
   - `interfaces/` - All interface files
   - `processors/` - All processor files with their specs

3. **Moved 8 controllers to controllers/**
   - app, executions, prompt-library, providers, bull-board, replicate, templates, workflows

4. **Moved 12 services to services/**
   - app, cost-calculator, executions, ffmpeg, job-recovery, prompt-library, queue-manager, replicate, templates, tts, workflow-generator, workflows

5. **Moved 11 modules to modules/**
   - cost, executions, ffmpeg, prompt-library, providers, queue, replicate, templates, tts, worker, workflows

6. **Moved 5 processors to processors/**
   - image, llm, processing, video, workflow

7. **Converted all relative imports to @/ path aliases**
   - Updated all `from '../..'` imports to `from '@/...'`
   - Updated all `from './'` imports to `from '@/...'`

### New Structure

```
apps/api/src/
├── controllers/          # All *.controller.ts + specs
├── services/             # All *.service.ts + specs
├── modules/              # All *.module.ts
├── schemas/              # All *.schema.ts
├── dto/                  # All *.dto.ts
├── interfaces/           # All *.interface.ts
├── processors/           # All *.processor.ts + specs
├── queue/                # queue.constants.ts
├── templates/            # templates.seed.ts
├── ffmpeg/               # index.ts (barrel export)
├── test/                 # Test utilities + mocks
├── app.module.ts
├── main.ts
└── worker.main.ts
```

### Files Modified

| Category | Count | Examples |
|----------|-------|----------|
| Controllers | 8 | executions.controller.ts, workflows.controller.ts |
| Services | 12 | replicate.service.ts, queue-manager.service.ts |
| Modules | 11 | queue.module.ts, executions.module.ts |
| Processors | 5 | image.processor.ts, workflow.processor.ts |
| Schemas | 6 | execution.schema.ts, workflow.schema.ts |
| DTOs | 10 | create-workflow.dto.ts, generate-image.dto.ts |
| Interfaces | 2 | cost.interface.ts, job-data.interface.ts |
| Config | 1 | tsconfig.json |
| Entry Points | 2 | main.ts, worker.main.ts |
| Spec Files | ~20 | All *.spec.ts files updated |

### Key Files Remaining in Place

- `queue/queue.constants.ts` - Queue configuration constants
- `templates/templates.seed.ts` - Template seed data
- `ffmpeg/index.ts` - Barrel export file

### Patterns Established

- Centralized file organization by type (controllers, services, modules)
- Consistent `@/` path aliases throughout codebase
- No relative imports (`../` or `./`) in any file

### Not Committed

All changes made but not committed. IDE may need restart to recognize new path aliases.

---

## Session 5: UI Fixes - Settings Modal & Node Category Colors

**Duration:** ~10 minutes
**Status:** Completed

### Summary

Fixed settings modal taking full screen height and differentiated node category colors so input and processing nodes are visually distinct.

### Tasks Completed

1. **Fixed Settings Modal Full-Height Issue** (`apps/web/src/components/settings/SettingsModal.tsx`)
   - Changed from `inset-4` / `md:inset-y-10` (stretched to edges) to centered auto-height
   - Now uses `top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2` for centering
   - Added `max-h-[90vh]` to prevent overflow on small screens
   - Width: `w-[calc(100%-2rem)] max-w-[600px]`

2. **Differentiated Processing Node Color** (`apps/web/src/app/globals.scss`)
   - Input and processing were both teal (hue 160 vs 175 - only 15° apart)
   - Changed processing from `oklch(0.7 0.18 175)` to `oklch(0.65 0.2 250)` (blue)
   - Now clearly distinct: Input=teal, AI=purple, Processing=blue, Output=amber

3. **Centralized Category Colors** (`apps/web/src/lib/constants/colors.ts`)
   - **NEW FILE** - Single source of truth for hex color constants
   - Exports `CATEGORY_COLORS` and `DEFAULT_NODE_COLOR`
   - Updated `WorkflowCanvas.tsx` minimap to use shared constant
   - Updated `WorkflowPreview.tsx` to use shared constant
   - Removed duplicated inline color definitions

### Files Modified

| File | Change |
|------|--------|
| `apps/web/src/components/settings/SettingsModal.tsx` | Changed modal positioning from stretched to centered auto-height |
| `apps/web/src/app/globals.scss` | Changed `--category-processing` from teal (175) to blue (250) |
| `apps/web/src/lib/constants/colors.ts` | **NEW** - Shared CATEGORY_COLORS constant |
| `apps/web/src/components/canvas/WorkflowCanvas.tsx` | Import and use shared CATEGORY_COLORS for minimap |
| `apps/web/src/components/WorkflowPreview.tsx` | Import and use shared CATEGORY_COLORS |

### Color Scheme (Final)

| Category | OKLCH Hue | Hex | Color |
|----------|-----------|-----|-------|
| Input | 160 | #2dd4bf | Teal |
| AI | 300 | #a855f7 | Purple |
| Processing | 250 | #818cf8 | Blue |
| Output | 70 | #f59e0b | Amber |

### Patterns Established

- Centered modal pattern: `fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 max-h-[90vh]`
- Shared constants in `@/lib/constants/` for values used across multiple components
- CSS variables (globals.scss) remain source of truth; hex constants for React Flow components

### Not Committed

All changes made but not committed.

---

## Session 6: Fix React 18 Strict Mode Workflow Loading Bug

**Duration:** ~10 minutes
**Status:** Completed

### Summary

Fixed a bug where workflows weren't loading nodes when navigating to `/w/{id}`. The issue was caused by React 18 strict mode and the `initRef` pattern used to prevent double-loading.

### Root Cause

In React 18 strict mode (development), components mount → unmount → remount. The code used:
```javascript
const initRef = useRef(false);
useEffect(() => {
  if (initRef.current) return;  // Skip if already initialized
  initRef.current = true;
  // ... fetch workflow
  return () => controller.abort();
}, [...]);
```

Problem:
1. First mount: `initRef.current = false` → sets to `true`, starts fetch
2. Unmount: abort controller cancels the fetch
3. Remount: `initRef.current = true` → returns early, **never refetches**

Result: Workflow data never loaded on second mount.

### Fix

Removed the `initRef` pattern entirely. The abort controller alone handles cleanup correctly:
- If component unmounts during fetch, request is aborted (error caught and ignored)
- On remount, a new fetch starts fresh

### Files Modified

| File | Change |
|------|--------|
| `apps/web/src/app/w/[id]/page.tsx` | Removed `initRef` pattern, removed `useRef` import |

### Technical Notes

- `/w/new` creates workflow via API, then `router.replace()` redirects to `/w/{id}`
- `replace` (not `push`) removes `/w/new` from browser history
- API confirmed working: `curl http://localhost:3001/api/workflows/{id}` returns nodes correctly

### Not Committed

Changes made but not committed.

---

## Session 7: Unified Reframe & Upscale Nodes

**Duration:** ~30 minutes
**Status:** Completed

### Summary

Consolidated 4 separate processing nodes into 2 unified nodes that auto-detect input type (image/video) and show appropriate UI.

### Tasks Completed

1. **Created unified Reframe node** (replaces LumaReframeImage + LumaReframeVideo)
   - Auto-detects input type from connected node
   - Model dropdown for Photon Flash / Photon (image mode only)
   - Shows video limits notice when video connected

2. **Created unified Upscale node** (replaces TopazImageUpscale + TopazVideoUpscale)
   - Auto-detects input type from connected node
   - Model dropdown switches between image models (5) and video model (1)
   - Shows image-specific controls (upscale factor, face enhancement) or video-specific (resolution, fps)

3. **Removed deprecated code**
   - Deleted 4 React components + 4 test files
   - Removed deprecated interfaces from types and API
   - Cleaned up all exports and registry

4. **Added explicit node ordering**
   - `NODE_ORDER` constant defines order per category
   - Most-used nodes appear first (Reframe, Upscale at top of Processing)

### Files Created

| File | Purpose |
|------|---------|
| `apps/web/src/components/nodes/processing/ReframeNode.tsx` | Unified reframe component |
| `apps/web/src/components/nodes/processing/UpscaleNode.tsx` | Unified upscale component |

### Files Modified

| File | Change |
|------|--------|
| `packages/types/src/nodes.ts` | Added ReframeNodeData, UpscaleNodeData, UpscaleModel; removed 4 deprecated types; added NODE_ORDER |
| `apps/web/src/components/nodes/processing/index.ts` | Clean exports (10 nodes) |
| `apps/web/src/components/nodes/index.ts` | Clean registry (24 nodes) |
| `apps/api/src/interfaces/job-data.interface.ts` | Added ReframeJobData, UpscaleJobData; removed 4 deprecated |
| `apps/api/src/services/replicate.service.ts` | Added unified reframe() and upscale() methods |

### Files Deleted

- `LumaReframeImageNode.tsx` + test
- `LumaReframeVideoNode.tsx` + test
- `TopazImageUpscaleNode.tsx` + test
- `TopazVideoUpscaleNode.tsx` + test

### Node Order

```typescript
const NODE_ORDER = {
  input: ['imageInput', 'videoInput', 'audioInput', 'prompt', 'template'],
  ai: ['imageGen', 'videoGen', 'llm', 'lipSync', 'textToSpeech', 'transcribe', 'voiceChange'],
  processing: ['reframe', 'upscale', 'resize', 'videoStitch', 'videoTrim', 'videoFrameExtract', 'imageGridSplit', 'annotation', 'subtitle', 'animation'],
  output: ['output', 'preview'],
};
```

### Technical Details

**Auto-detection logic:**
```typescript
const inputType = nodeData.inputType ?? (nodeData.inputImage ? 'image' : nodeData.inputVideo ? 'video' : null);
```

**Unified API methods delegate to specific handlers:**
- `reframe()` → `reframeImage()` or `reframeVideo()`
- `upscale()` → `upscaleImage()` or `upscaleVideo()`

### Not Committed

All changes made but not committed. Node count reduced from 28 to 24.

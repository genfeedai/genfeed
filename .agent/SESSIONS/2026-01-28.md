# Sessions: 2026-01-28

**Summary:** File storage migration to data/

---

## Session 1: Migrate File Storage to data/ Directory

**Duration:** ~15 minutes
**Status:** Complete

### System Flow

```
Before:
apps/api/assets/input/{workflowId}/*.jpg  →  File uploads
apps/api/assets/output/{workflowId}/*.mp4 →  Generated outputs

After:
data/{workflowId}/input/*.jpg   →  File uploads
data/{workflowId}/output/*.mp4  →  Generated outputs
```

### What was done

- [x] Updated `.gitignore` to ignore `data/*` except `.gitkeep`
- [x] Created `data/` directory structure with workflow subdirectories
- [x] Moved existing files from `apps/api/assets/input/697a2638c578f6a2ba9e1c8c/` to `data/697a2638c578f6a2ba9e1c8c/input/`
- [x] Created `data/.gitkeep` for fresh clones
- [x] Removed old `apps/api/assets/` directory
- [x] Verified gitignore correctly ignores workflow data

### Files changed

- `.gitignore` - Simplified rules: `data/*` ignored, `!data/.gitkeep` preserved
- `data/.gitkeep` - Created (empty file for git tracking)
- `data/697a2638c578f6a2ba9e1c8c/input/` - Created with migrated files

### Files deleted

- `apps/api/assets/` - Entire directory removed (files moved to `data/`)

### Decisions

- **Decision:** Use flat `data/{workflowId}/` structure instead of nested `data/workflows/{workflowId}/`
  - **Context:** Simplifies path construction and matches common patterns
  - **Rationale:** Fewer path segments, easier to work with

- **Decision:** Single `.gitkeep` at root instead of per-subdirectory
  - **Context:** Git will create subdirectories when files are added
  - **Rationale:** Minimizes tracked files, clean repository

### Verification

- Files moved: 2 images confirmed in `data/697a2638c578f6a2ba9e1c8c/input/`
- Gitignore working: Only `data/.gitkeep` tracked, workflow data ignored

### Next steps

- [x] Update `files.service.ts` to use new `data/` path instead of `apps/api/assets/`
- [x] Update any hardcoded paths in processors
- [ ] Test file upload/download with new paths

---

## Session 2: Image Node UX & Local File Storage Implementation

**Duration:** ~1 hour
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Local File Storage Flow                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  UPLOAD (Input Files):                                                   │
│  ┌──────────┐    POST /api/files/workflows/{id}/input/{type}            │
│  │ Frontend │ ──────────────────────────────────────────────►           │
│  │  Upload  │                                                           │
│  └──────────┘    ┌─────────────────────────────────────────────┐        │
│                  │ data/workflows/{workflowId}/input/          │        │
│                  │   └── image-{ts}-{hash}.jpg                 │        │
│                  └─────────────────────────────────────────────┘        │
│                                                                          │
│  AUTO-SAVE (Generated Outputs):                                          │
│  ┌──────────┐    Download from    ┌──────────────────────────┐          │
│  │Processor │ ───────────────────►│ Replicate Output URL     │          │
│  │(img/vid) │                     └──────────────────────────┘          │
│  └──────────┘                                │                          │
│       │                                      │                          │
│       │    Save to local                     ▼                          │
│       └──────────────────►  ┌─────────────────────────────────┐         │
│                             │ data/workflows/{workflowId}/output/│       │
│                             │   └── {nodeId}-{ts}.jpg          │        │
│                             └─────────────────────────────────┘         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

- [x] Fixed replay button positioning in ImageGenNode (changed from `object-contain` to `object-cover` with `aspect-[4/3]`)
- [x] Updated FilesService to use `data/workflows/{id}/` paths
- [x] Added `saveWorkflowOutput()` and `downloadAndSaveOutput()` methods to FilesService
- [x] Updated all API routes from `/api/files/input/` to `/api/files/workflows/{id}/input/`
- [x] Added auto-save functionality to image.processor.ts, video.processor.ts, processing.processor.ts
- [x] Removed Output node from node palette (kept in types for backwards compatibility)
- [x] Updated frontend upload endpoints to match new API paths

### Files changed

**Frontend:**
- `apps/web/src/components/nodes/ai/ImageGenNode.tsx` - Fixed image container sizing (aspect-[4/3], object-cover)
- `apps/web/src/components/nodes/input/ImageInputNode.tsx` - Updated upload endpoint path
- `apps/web/src/components/nodes/input/VideoInputNode.tsx` - Updated upload endpoint path
- `apps/web/src/components/nodes/index.ts` - Added deprecation comment for OutputNode
- `apps/web/src/components/panels/NodePalette.tsx` - Filter out empty categories
- `apps/web/src/components/context-menu/menus/paneMenu.tsx` - Filter out empty categories
- `apps/web/src/lib/api/client.ts` - Updated documentation comment

**Backend:**
- `apps/api/src/services/files.service.ts` - New storage paths + saveWorkflowOutput() + downloadAndSaveOutput()
- `apps/api/src/controllers/files.controller.ts` - Updated routes to new structure
- `apps/api/src/processors/image.processor.ts` - Added auto-save after generation
- `apps/api/src/processors/video.processor.ts` - Added FilesService injection + auto-save
- `apps/api/src/processors/processing.processor.ts` - Added FilesService injection + auto-save
- `apps/api/src/queue/queue.constants.ts` - Removed 'output' from PASSTHROUGH_NODE_TYPES

**Types:**
- `packages/types/src/nodes.ts` - Marked output node deprecated, removed from NODE_ORDER

### Decisions

- **Decision:** Keep output node type for backwards compatibility but hide from UI
  - **Context:** Existing workflows may have Output nodes, would break if type removed
  - **Rationale:** Graceful degradation - old workflows still work, new ones don't show Output

- **Decision:** Auto-save continues workflow even if local save fails
  - **Context:** Remote URL still works even if local save fails
  - **Rationale:** Non-blocking - better UX to complete workflow than fail on optional feature

- **Decision:** Use `data/workflows/{workflowId}/` structure
  - **Context:** Need organized storage per workflow for both inputs and outputs
  - **Rationale:** Better organization, easier cleanup, clearer ownership of files

### Mistakes and fixes

- None encountered

### Next steps

- [ ] Test file upload with new endpoints
- [ ] Test image generation with auto-save
- [ ] Verify Output node no longer appears in palette
- [ ] Consider adding cleanup job for old workflow data

---

## Session 3: Template Thumbnail Images

**Duration:** ~5 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Template Thumbnail Display                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Before:                                                                 │
│  ┌──────────────┐                                                        │
│  │ Templates    │     WorkflowPreview                                   │
│  │ Modal        │ ──► (renders node graph)                              │
│  └──────────────┘                                                        │
│                                                                          │
│  After:                                                                  │
│  ┌──────────────┐     ┌──────────────────────────────────┐              │
│  │ Templates    │ ──► │ Unsplash CDN Image               │              │
│  │ Modal        │     │ (600x400, 3:2 aspect ratio)      │              │
│  └──────────────┘     └──────────────────────────────────┘              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

- [x] Added `thumbnail` property to all 13 templates in TEMPLATE_INFO array
- [x] Used curated Unsplash images matching each template's purpose
- [x] Applied consistent sizing via URL params (`w=600&h=400&fit=crop`)

### Files changed

- `apps/web/src/templates/index.ts` - Added thumbnail URLs to all 13 template entries

### Template Thumbnails Added

| Template | Image Concept |
|----------|---------------|
| image-series | Photo grid/gallery |
| image-to-video | Film/motion |
| full-pipeline | Data pipeline/workflow |
| extended-video | Film reel |
| grid-to-video | Grid/mosaic pattern |
| voice-to-video | Microphone/audio |
| youtube-thumbnail-script | YouTube branding |
| youtube-video-generator | Video production |
| stream-to-social | Live streaming |
| social-brand-kit | Social media branding |
| facecam-avatar | Portrait/face |
| dance-video | Dancing/motion |
| instagram-carousel | Instagram aesthetic |

### Decisions

- **Decision:** Use Unsplash CDN URLs directly instead of local images
  - **Context:** TemplateInfo already had optional `thumbnail` field
  - **Rationale:** No build step needed, CDN handles caching/resizing, free license

### Next steps

- [ ] Verify thumbnails display correctly in templates modal
- [ ] Test that clicking templates still works with thumbnail

---

## Session 4: Workflow Thumbnails + File Menu + Bug Fixes

**Duration:** ~45 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Workflow Thumbnail System                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Auto-Thumbnail Selection (on save):                                     │
│  ┌──────────────┐    ┌─────────────────────────────────────────┐        │
│  │ Workflow     │    │ 1. Find nodes with outputVideo (priority)│        │
│  │   Save       │ ──►│ 2. Find nodes with outputImage           │        │
│  └──────────────┘    │ 3. Pick first complete node              │        │
│                      │ 4. Set as thumbnail + thumbnailNodeId    │        │
│                      └─────────────────────────────────────────┘        │
│                                                                          │
│  Manual Set Thumbnail (right-click):                                     │
│  ┌──────────────┐    PUT /workflows/{id}/thumbnail                      │
│  │ Right-click  │ ────────────────────────────────────────────►         │
│  │ node w/media │    { thumbnailUrl, nodeId }                           │
│  └──────────────┘                                                        │
│                                                                          │
│  Display in Workflow List:                                               │
│  ┌──────────────┐    ┌─────────────────────────────────────────┐        │
│  │ Dashboard    │ ──►│ If thumbnail: <video> or <img>          │        │
│  │ /workflows   │    │ Else: WorkflowPreview (node graph)      │        │
│  └──────────────┘    └─────────────────────────────────────────┘        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

**Workflow Thumbnails:**
- [x] Added `thumbnail` and `thumbnailNodeId` fields to Workflow schema
- [x] Created `PUT /workflows/:id/thumbnail` API endpoint
- [x] Added auto-thumbnail selection on save (video priority > image)
- [x] Added "Set as Thumbnail" to right-click context menu for media nodes
- [x] Updated workflow cards to display thumbnails (video autoplay, image fallback)

**File Menu Actions:**
- [x] Added "Duplicate Workflow" to File menu
- [x] Added "Save As..." to File menu with dialog
- [x] Created SaveAsDialog component
- [x] Updated ToolbarDropdown to support separators and disabled items

**Bug Fixes:**
- [x] Fixed 429 rate limit handling - increased backoff to 10s exponential
- [x] Added smart 429 detection with `retry_after` parsing
- [x] Fixed error not clearing on successful retry (SSE + polling)
- [x] Fixed error not clearing immediately on Retry click
- [x] Fixed Replicate output format handling (string vs object)
- [x] Fixed prompt not being injected when model changed (`inputPrompt` vs `prompt`)
- [x] Fixed Prompt Library save from PromptNode (modal now renders independently)

### Files changed

**Backend - Schema/DTO:**
- `apps/api/src/schemas/workflow.schema.ts` - Added thumbnail, thumbnailNodeId fields
- `apps/api/src/dto/create-workflow.dto.ts` - Added optional thumbnail fields
- `apps/api/src/dto/set-thumbnail.dto.ts` - New DTO for thumbnail endpoint

**Backend - Controller/Service:**
- `apps/api/src/controllers/workflows.controller.ts` - Added PUT thumbnail endpoint
- `apps/api/src/services/workflows.service.ts` - Added setThumbnail(), findAutoThumbnail(), updated create/update/duplicate

**Backend - Processors:**
- `apps/api/src/processors/base.processor.ts` - Added 429 detection + retry_after handling
- `apps/api/src/processors/image.processor.ts` - Fixed output format (string vs object), fixed inputPrompt
- `apps/api/src/processors/video.processor.ts` - Fixed output format, fixed inputPrompt/inputImage
- `apps/api/src/queue/queue.constants.ts` - Increased backoff delays to 10s

**Frontend - Toolbar:**
- `apps/web/src/components/toolbar/Toolbar.tsx` - Added Duplicate, Save As menu items
- `apps/web/src/components/toolbar/SaveAsDialog.tsx` - New component
- `apps/web/src/components/toolbar/ToolbarDropdown.tsx` - Support separators/disabled
- `apps/web/src/components/toolbar/types.ts` - Extended DropdownItem interface

**Frontend - Context Menu:**
- `apps/web/src/components/context-menu/menus/nodeMenu.tsx` - Added "Set as Thumbnail"
- `apps/web/src/hooks/useContextMenu.ts` - Added setAsThumbnail callback

**Frontend - API:**
- `apps/web/src/lib/api/workflows.ts` - Added thumbnail fields, setThumbnail method

**Frontend - Execution:**
- `apps/web/src/store/execution/helpers/sseSubscription.ts` - Clear error on success
- `apps/web/src/store/execution/helpers/pollPrediction.ts` - Clear error on success
- `apps/web/src/components/nodes/BaseNode.tsx` - Clear error on Retry click

**Frontend - Pages:**
- `apps/web/src/app/workflows/page.tsx` - Display thumbnails in workflow cards
- `apps/web/src/app/workflows/[id]/page.tsx` - Handle rename param, render CreatePromptModal

### Decisions

- **Decision:** Auto-select video thumbnails over image thumbnails
  - **Context:** Videos are more engaging as preview content
  - **Rationale:** Video autoplay in dashboard provides better visual feedback

- **Decision:** Use exponential backoff starting at 10s for Replicate rate limits
  - **Context:** Replicate returns 429 with retry_after of ~6-8s
  - **Rationale:** 10s gives buffer above retry_after, exponential prevents cascade

- **Decision:** Normalize Replicate output to `{ image/video: "url" }` format
  - **Context:** Some models return string URL, others return object
  - **Rationale:** Consistent format for frontend consumption

### Mistakes and fixes

- **Mistake:** Workflow schema used `string | null` type without explicit Mongoose type
  - **Fix:** Added `{ type: String, default: null }` to @Prop decorator

- **Mistake:** Image processor read `nodeData.prompt` but input resolution maps to `inputPrompt`
  - **Fix:** Changed to `inputPrompt ?? prompt` in all processors

- **Mistake:** CreatePromptModal only rendered inside PromptLibraryModal
  - **Fix:** Also render at app level when library modal is closed

### Next steps

- [ ] Test thumbnail auto-selection with workflow execution
- [ ] Test Duplicate and Save As functionality
- [ ] Verify output files now save to `data/workflows/{id}/output/`
- [ ] Add thumbnail cleanup when workflow deleted

---

## Session 5: UI Polish & Replicate Base64 Fix

**Duration:** ~45 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 Local URL → Base64 Conversion                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Before (BROKEN):                                                        │
│  ┌──────────┐    localhost:3001/api/files/...                           │
│  │Replicate │ ──────────────────────────────► ❌ Can't access           │
│  │   API    │                                                           │
│  └──────────┘                                                           │
│                                                                          │
│  After (FIXED):                                                          │
│  ┌──────────┐    convertLocalUrlToBase64()   ┌─────────────────┐        │
│  │ Local    │ ────────────────────────────► │ data:image/jpeg; │        │
│  │  File    │                               │ base64,/9j/4...  │        │
│  └──────────┘                               └─────────────────┘        │
│       │                                              │                  │
│       │                                              ▼                  │
│       │                                     ┌──────────────────┐        │
│       └─────────────────────────────────────│   Replicate API  │        │
│                                             │   ✅ Works!      │        │
│                                             └──────────────────┘        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

**UI Fixes:**
- [x] Fixed edge style preview - bezier path now shows actual curve (control points offset)
- [x] Changed edge preview layout - Node A/B at different heights for visibility
- [x] Made modal backdrop darker (50% → 70% opacity)
- [x] Fixed WorkflowPreview sizing (w-full h-full wrapper for ReactFlow)
- [x] Centered workflow thumbnail images (added object-center)
- [x] Prompt node preview now opens prompt editor modal instead of "No preview"
- [x] Node resize handles now match category color (purple for AI, teal for input, etc.)

**Model Browser Thumbnails:**
- [x] Updated sync script to save `coverImageUrl` from Replicate API
- [x] Added export for schemas.json in package.json
- [x] API route now reads thumbnails from cached schemas.json
- [x] Added FLUX, SDXL, MiniMax, Luma Ray to MODELS_TO_SYNC
- [x] Added fallback for broken images (onError handler)
- [x] Made thumbnail full-height of model card

**Replicate Base64 Fix:**
- [x] Added `convertLocalUrlToBase64()` helper to ReplicateService
- [x] Updated generateImage, generateVideo, generateMotionControlVideo
- [x] Updated reframeImage, reframeVideo, upscaleImage, upscaleVideo
- [x] Updated generateLipSync - all methods now convert localhost URLs to base64

**Cleanup:**
- [x] Deleted old `/output` folder at project root (migrated to data/workflows/)

### Files changed

**Frontend:**
- `apps/web/src/components/settings/SettingsModal.tsx` - Edge preview bezier fix, darker backdrop
- `apps/web/src/components/WorkflowPreview.tsx` - Added w-full h-full wrapper
- `apps/web/src/app/workflows/page.tsx` - Added object-center to thumbnails
- `apps/web/src/components/nodes/NodeDetailModal.tsx` - Redirect prompt nodes to editor
- `apps/web/src/components/nodes/BaseNode.tsx` - Category-colored resize handles
- `apps/web/src/components/models/ModelBrowserModal.tsx` - Full-height thumbnails, error fallback

**Backend:**
- `apps/api/src/services/replicate.service.ts` - Added convertLocalUrlToBase64() helper

**Shared:**
- `packages/types/package.json` - Added schemas.json export
- `scripts/sync-replicate-schemas.ts` - Added coverImageUrl, added more models

**API Route:**
- `apps/web/src/app/api/providers/models/route.ts` - Read thumbnails from schemas.json

### Decisions

- **Decision:** Convert local URLs to base64 in ReplicateService
  - **Context:** Replicate can't access localhost URLs
  - **Rationale:** Transparent conversion - callers don't need to change

- **Decision:** Store coverImageUrl in schemas.json rather than fetch live
  - **Context:** User suggested using existing sync infrastructure
  - **Rationale:** No runtime API calls, faster, simpler architecture

- **Decision:** Resize handles match node category color
  - **Context:** User noticed corners were teal regardless of node type
  - **Rationale:** Visual consistency - entire node selection uses category color

### Mistakes and fixes

- Added invalid thumbnail URLs initially → Reverted to sparkle placeholders
- Forgot to export schemas.json from package → Added to exports field

### Pending verification

- [ ] Run `bun run sync:replicate` to fetch cover images
- [ ] Test video generation with local image inputs (base64 conversion)
- [ ] Verify model thumbnails display after sync

---

## Session 6: Workflow Loading UX & Price Calculator Fix

**Duration:** ~20 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 Workflow Page Loading Fix                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE (3-step flash):                                                  │
│  ┌─────────┐    ┌──────────┐    ┌──────────┐                            │
│  │ Empty   │ ──►│ Loading  │ ──►│ Workflow │                            │
│  │ Canvas  │    │ Spinner  │    │ Loaded   │                            │
│  └─────────┘    └──────────┘    └──────────┘                            │
│     flash!                                                               │
│                                                                          │
│  AFTER (2-step smooth):                                                  │
│  ┌──────────┐    ┌──────────┐                                           │
│  │ Loading  │ ──►│ Workflow │   ✅ No flash                             │
│  │ Spinner  │    │ Loaded   │                                           │
│  └──────────┘    └──────────┘                                           │
│                                                                          │
│  Root cause: isLoading starts false, useEffect sets it true             │
│  Fix: Show loading when URL workflowId ≠ store currentWorkflowId        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 Price Calculator Real-time Updates                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE:                                                                 │
│  ┌──────────┐                     ┌───────────┐                         │
│  │ VideoGen │  ←─ no connection ─ │ Toolbar   │                         │
│  │  Node    │                     │ Cost: $0  │  ❌ Never updated       │
│  └──────────┘                     └───────────┘                         │
│                                                                          │
│  AFTER:                                                                  │
│  ┌──────────┐    useEffect        ┌───────────┐                         │
│  │ VideoGen │ ──────────────────► │ Toolbar   │                         │
│  │  model   │    watches nodes    │ Cost:$0.40│  ✅ Real-time updates   │
│  │ duration │    recalculates     └───────────┘                         │
│  │  audio   │    on change                                              │
│  └──────────┘                                                           │
│                                                                          │
│  Pricing (Veo 3.1 Fast):                                                 │
│  - Without audio: $0.10/sec                                             │
│  - With audio: $0.15/sec                                                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

**Workflow Loading UX Fix:**
- [x] Added `isWorkflowNotLoaded` check to loading condition
- [x] Shows loading spinner immediately when URL workflowId doesn't match store
- [x] Prevents empty canvas flash on page reload/navigation

**Price Calculator Fix:**
- [x] Added useEffect to Toolbar that watches nodes for cost-relevant changes
- [x] Calculates cost only when model/duration/audio/resolution change (not position)
- [x] Uses ref to cache previous cost data and avoid unnecessary recalculations
- [x] Removed prices from VideoGenNode dropdown (per user request)

### Files changed

**Frontend:**
- `apps/web/src/app/workflows/[id]/page.tsx` - Added isWorkflowNotLoaded loading check
- `apps/web/src/components/toolbar/Toolbar.tsx` - Added cost calculation useEffect
- `apps/web/src/components/nodes/ai/VideoGenNode.tsx` - Removed prices from dropdown labels

### Decisions

- **Decision:** Check both `isLoading` and `workflowId !== currentWorkflowId` for loading state
  - **Context:** React renders component before useEffect runs
  - **Rationale:** Catches "workflow not yet loaded" state that isLoading misses

- **Decision:** Track cost-relevant data separately from full node state
  - **Context:** Node positions change frequently (drag operations)
  - **Rationale:** Avoids expensive cost recalculation on every mouse move

- **Decision:** Remove pricing from node dropdown, keep it in Cost Modal
  - **Context:** User found inline prices distracting
  - **Rationale:** Price info available in dedicated cost breakdown modal

### Mistakes and fixes

- None encountered

### Next steps

- [ ] Test workflow page loading on hard refresh
- [ ] Test price calculator updates when changing video settings
- [ ] Verify cost modal still shows accurate breakdown

---

**Total sessions today:** 6
## Session 6: Canvas UX - Auto-layout, Edge Animation, Node Resizing

**Duration:** ~2 hours
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Workflow Canvas Enhancements                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  AUTO-LAYOUT (Toolbar Button):                                          │
│  ┌──────────┐    Click    ┌──────────────────────────────────┐          │
│  │LayoutGrid│ ──────────► │ dagre layout + handle alignment  │          │
│  │  Button  │             │ + edge style normalization       │          │
│  └──────────┘             └──────────────────────────────────┘          │
│                                                                          │
│  EDGE ANIMATION (During Execution):                                      │
│  ┌──────────┐    isRunning=true   ┌────────────────────────┐            │
│  │Execution │ ─────────────────► │ All edges: active-pipe  │            │
│  │  Store   │                     │ Current: executing      │            │
│  └──────────┘                     │ (animated dash flow)    │            │
│                                   └────────────────────────┘            │
│                                                                          │
│  NODE RESIZING:                                                          │
│  ┌──────────┐    Drag corners   ┌────────────────────────┐              │
│  │NodeResizer│ ───────────────► │ Content fills space    │              │
│  │(selected)│                   │ (flex-1 for children)  │              │
│  └──────────┘                   └────────────────────────┘              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

**Toolbar & Auto-layout:**
- [x] Moved Auto-layout button from File dropdown to standalone toolbar button
- [x] Rewrote auto-layout algorithm with handle alignment (creates horizontal edges)
- [x] Auto-layout normalizes all edge styles to user's preferred style setting
- [x] Added dagre ranker options (network-simplex, greedy acyclicer)

**Edge Animation (Pipe Flow Effect):**
- [x] Added animated "pipe flow" effect on edges during workflow execution
- [x] Current node's edges: bright glow + fast animation (executing class)
- [x] Other edges: subtle glow + slower animation (active-pipe class)
- [x] CSS keyframes animation (stroke-dashoffset 24→0)

**Node Resizing:**
- [x] Added NodeResizer from @xyflow/react to BaseNode
- [x] Content containers use flex-1 flex-col layout
- [x] PromptNode textarea expands with node (flex-1 min-h-[80px])
- [x] Image/video previews expand with node (flex-1, h-full, object-contain)

**Image Aspect Ratio:**
- [x] Changed from object-cover to object-contain (preserves full image)
- [x] Consistent styling: ImageInputNode, ImageGenNode, VideoGenNode, OutputNode

**Processing Spinner:**
- [x] Added spinner overlay on image/video previews during generation
- [x] Shows Loader2 spinner + "Generating..." text

**Execution Error Handling:**
- [x] Fixed SSE subscription to reset isRunning when node fails
- [x] Stop button correctly resets on execution failure
- [x] Edge animation stops when execution fails

**Edge Style Setting:**
- [x] Settings store now updates current workflow edges when style changes
- [x] Dynamic import of workflowStore to avoid circular dependency

**Handle Order:**
- [x] Removed dynamic handle reordering (useOptimalHandleOrder)
- [x] Handles use static order from node definition
- [x] Auto-layout positions nodes to align handles instead

**Backend Fix:**
- [x] Fixed "No nodes ready to execute" by filtering passthrough nodes from dependencies

### Files changed

**Frontend - Toolbar:**
- `apps/web/src/components/toolbar/Toolbar.tsx` - Standalone auto-layout button

**Frontend - Canvas:**
- `apps/web/src/components/canvas/WorkflowCanvas.tsx` - Edge styling with pipe flow effect

**Frontend - Nodes:**
- `apps/web/src/components/nodes/BaseNode.tsx` - NodeResizer, flex layout, static handle order
- `apps/web/src/components/nodes/input/PromptNode.tsx` - Textarea flex-1
- `apps/web/src/components/nodes/input/ImageInputNode.tsx` - Image preview flex-1
- `apps/web/src/components/nodes/ai/ImageGenNode.tsx` - Container flex-1, spinner
- `apps/web/src/components/nodes/ai/VideoGenNode.tsx` - Container flex-1, spinner
- `apps/web/src/components/nodes/output/OutputNode.tsx` - Container flex-1, preview flex-1

**Frontend - Stores:**
- `apps/web/src/store/settingsStore.ts` - setEdgeStyle updates workflow
- `apps/web/src/store/execution/helpers/sseSubscription.ts` - Reset isRunning on failure

**Frontend - Layout:**
- `apps/web/src/lib/autoLayout.ts` - New alignHandles algorithm
- `apps/web/src/hooks/usePaneActions.ts` - Edge style normalization

**Frontend - Styles:**
- `apps/web/src/app/globals.scss` - executing, active-pipe classes, edge-flow keyframes

**Backend:**
- `apps/api/src/processors/workflow.processor.ts` - Filter passthrough from dependencies

### Decisions

- **Decision:** Remove dynamic handle reordering, use static order + auto-layout
  - **Rationale:** Dynamic reordering confused edges; simpler to position nodes instead

- **Decision:** CSS animation for pipe flow vs React Flow animated prop
  - **Rationale:** More control over flow direction and glow effects

- **Decision:** object-contain instead of object-cover for image previews
  - **Rationale:** Preserve full generated image, important for non-standard ratios

- **Decision:** Filter passthrough nodes from dependencies at orchestration time
  - **Rationale:** Passthrough nodes are marked complete immediately, shouldn't block

### Mistakes and fixes

- isRunning stayed true after failure → Enhanced SSE to check node failures + no pending
- Content didn't resize with node → Added flex-1 to containers and children
- Edge animation was static → Added stroke-dashoffset keyframes animation

---

## Session 7: Cyan Output Handles & Output Node Revival

**Duration:** ~15 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Handle Color Differentiation                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  INPUT HANDLES (left side):                                              │
│  ┌────────────┐                                                         │
│  │ Gold       │ ── image                                                │
│  │ Purple     │ ── video                                                │
│  │ Teal       │ ── text                                                 │
│  │ Blue       │ ── number                                               │
│  │ Pink       │ ── audio                                                │
│  └────────────┘                                                         │
│                                                                          │
│  OUTPUT HANDLES (right side):                                            │
│  ┌────────────┐                                                         │
│  │ Cyan       │ ── ALL outputs (new!)                                   │
│  └────────────┘                                                         │
│                                                                          │
│  Visual cue: cyan = data source, colors = data type expected            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Output Node Revival                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE (deprecated):                                                    │
│  - Single 'media' input (image only)                                    │
│  - Hidden from node palette                                             │
│  - No real purpose                                                      │
│                                                                          │
│  AFTER (useful):                                                         │
│  ┌──────────────┐    ┌─────────────────────────────────────┐            │
│  │ Image/Video  │ ──►│ Output Node                         │            │
│  │   Source     │    │ - Custom filename (editable)        │            │
│  └──────────────┘    │ - Download button                   │            │
│                      │ - Preview (video autoplay)          │            │
│                      └─────────────────────────────────────┘            │
│                                                                          │
│  Accepts: image OR video (separate handles)                             │
│  Icon: Download (was CheckCircle)                                       │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

**Cyan Output Handles:**
- [x] Added `--handle-output: oklch(0.7 0.2 200)` CSS variable
- [x] Added `.handle-output` class to globals.scss
- [x] Updated BaseNode.tsx to use `handle-output` class for all output handles
- [x] Input handles retain data-type colors (gold/purple/teal/blue/pink)

**Output Node Revival:**
- [x] Removed deprecation notice from node definition
- [x] Changed icon from CheckCircle to Download
- [x] Added separate image and video input handles
- [x] Added `output` back to NODE_ORDER (now shows in palette)
- [x] Updated OutputNodeData type with inputImage/inputVideo fields
- [x] Updated OutputNode component to use new data structure
- [x] Updated empty state: "Connect image or video"

### Files changed

**Styles:**
- `apps/web/src/app/globals.scss` - Added --handle-output variable and .handle-output class

**Types:**
- `packages/types/src/nodes.ts` - Updated OutputNodeData, output node definition, NODE_ORDER

**Components:**
- `apps/web/src/components/nodes/BaseNode.tsx` - Output handles use handle-output class
- `apps/web/src/components/nodes/output/OutputNode.tsx` - New dual-input data structure

### Decisions

- **Decision:** All output handles are cyan regardless of data type
  - **Context:** User wanted visual differentiation between inputs and outputs
  - **Rationale:** Cyan outputs = "data source", colored inputs = "data type expected"

- **Decision:** Revive Output node with image + video support
  - **Context:** Node was marked deprecated but has unique value (custom filename + download)
  - **Rationale:** Different from auto-save; allows explicit file naming and manual download

### Next steps

- [ ] Verify cyan handles display correctly in workflow editor
- [ ] Test Output node with both image and video inputs
- [ ] Verify download functionality with custom filename

---

## Session 8: File Storage Path Fix & Node Header Refresh Button

**Duration:** ~10 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     File Storage Path Fix                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE (BROKEN):                                                        │
│  ┌──────────────┐    process.cwd()    ┌────────────────────────┐        │
│  │ FilesService │ ──────────────────► │ apps/api/              │        │
│  │              │                     │ data/workflows/{id}/   │ ❌     │
│  └──────────────┘                     └────────────────────────┘        │
│                                                                          │
│  AFTER (FIXED):                                                          │
│  ┌──────────────┐    __dirname + ../../../  ┌──────────────────┐        │
│  │ FilesService │ ────────────────────────► │ {root}/          │        │
│  │              │    (apps/api/dist → root) │ data/workflows/  │ ✅     │
│  └──────────────┘                           └──────────────────┘        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Refresh Button Relocation                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE:                                                                 │
│  ┌─────────────────────────────┐                                        │
│  │ [Browse]  [🔒] [✓]          │  ← header                              │
│  ├─────────────────────────────┤                                        │
│  │  ┌─────────────────┐        │                                        │
│  │  │  [🔄]           │        │  ← refresh on image                    │
│  │  │  generated.jpg  │        │                                        │
│  │  └─────────────────┘        │                                        │
│  └─────────────────────────────┘                                        │
│                                                                          │
│  AFTER:                                                                  │
│  ┌─────────────────────────────┐                                        │
│  │ [Browse] [🔄] [🔒] [✓]      │  ← refresh in header                   │
│  ├─────────────────────────────┤                                        │
│  │  ┌─────────────────┐        │                                        │
│  │  │  generated.jpg  │        │  ← clean preview                       │
│  │  └─────────────────┘        │                                        │
│  └─────────────────────────────┘                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

**File Storage Path Fix:**
- [x] Changed FilesService from `process.cwd()` to `__dirname` relative path
- [x] Uses `join(__dirname, '..', '..', '..')` to traverse from `apps/api/dist` to root
- [x] Files now correctly save to `{root}/data/workflows/{id}/` instead of `apps/api/data/`

**Node Header Refresh Button:**
- [x] Moved refresh/regenerate button from image preview to node header (ImageGenNode)
- [x] Moved refresh/regenerate button from video preview to node header (VideoGenNode)
- [x] Added Browse button to VideoGenNode header (was inline with model dropdown)
- [x] Refresh button only shows when output exists
- [x] Uses ghost variant with icon-sm size for compact header fit

### Files changed

**Backend:**
- `apps/api/src/services/files.service.ts` - Fixed dataPath to use __dirname instead of process.cwd()

**Frontend:**
- `apps/web/src/components/nodes/ai/ImageGenNode.tsx` - Moved refresh to headerActions
- `apps/web/src/components/nodes/ai/VideoGenNode.tsx` - Moved refresh to headerActions, added Browse button

### Decisions

- **Decision:** Use `__dirname` relative path instead of `process.cwd()`
  - **Context:** Webpack bundles to `apps/api/dist/main.js`, so __dirname is `apps/api/dist`
  - **Rationale:** __dirname is stable relative to built code, process.cwd() varies by how server starts

- **Decision:** Put refresh button in header, not floating on preview
  - **Context:** User requested cleaner preview area
  - **Rationale:** Consistent with other header actions (Browse, lock, status)

### Mistakes and fixes

- Initial fix used 4 levels of `..` (assuming non-webpack structure)
  - **Fix:** Changed to 3 levels after checking webpack bundles to single `dist/main.js`

---

## Session 9: Dynamic Schema-Based Node Inputs

**Duration:** ~30 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  Dynamic Schema-Based Node Inputs                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  MODEL SELECTION (Frontend):                                             │
│  ┌──────────┐   Browse    ┌────────────────────────────────────┐        │
│  │ ImageGen │ ─────────►  │ ModelBrowserModal                   │        │
│  │   Node   │             │ (includes inputSchema from API)     │        │
│  └──────────┘             └────────────────────────────────────┘        │
│       │                                   │                             │
│       │   handleModelSelect               │ model.inputSchema           │
│       ▼                                   ▼                             │
│  ┌──────────────────────────────────────────────────────────────┐       │
│  │ selectedModel: { modelId, displayName, inputSchema }         │       │
│  │ schemaParams: { aspect_ratio: "1:1", resolution: "2K", ... } │       │
│  └──────────────────────────────────────────────────────────────┘       │
│       │                                                                 │
│       ▼                                                                 │
│  ┌──────────────────────────────────────────────────────────────┐       │
│  │ SchemaInputs Component                                        │       │
│  │ - Reads schema.properties                                     │       │
│  │ - Renders Select for enums (allOf/$ref or direct enum)        │       │
│  │ - Renders Slider for integers/numbers with min/max            │       │
│  │ - Renders Checkbox for booleans                               │       │
│  │ - Skips connection fields (prompt, image, video, etc.)        │       │
│  └──────────────────────────────────────────────────────────────┘       │
│                                                                          │
│  EXECUTION (Backend):                                                    │
│  ┌──────────┐   schemaParams   ┌─────────────────────────────────┐      │
│  │Processor │ ───────────────► │ ReplicateService                 │      │
│  │ (img/vid)│                  │ - Uses schemaParams if available │      │
│  └──────────┘                  │ - Falls back to legacy fields    │      │
│                                └─────────────────────────────────┘      │
│                                                                          │
│  DISABLED HANDLES (when model doesn't support image input):              │
│  ┌──────────────────────────────────────────────────────────────┐       │
│  │ Input handles show 30% opacity when model doesn't support     │       │
│  │ that input type (e.g., text-to-image model ignores images)    │       │
│  └──────────────────────────────────────────────────────────────┘       │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

**Types (packages/types/src/nodes.ts):**
- [x] Added `inputSchema?: Record<string, unknown>` to ProviderModel interface
- [x] Added `inputSchema?: Record<string, unknown>` to SelectedModel interface
- [x] Added `schemaParams?: Record<string, unknown>` to ImageGenNodeData
- [x] Added `schemaParams?: Record<string, unknown>` to VideoGenNodeData

**API Route (apps/web/src/app/api/providers/models/route.ts):**
- [x] Include `inputSchema` from schemas.json in ProviderModel response

**New SchemaInputs Component (apps/web/src/components/nodes/SchemaInputs.tsx):**
- [x] Created reusable component for dynamic schema-based inputs
- [x] Handles enums (allOf with $ref) → Select dropdown
- [x] Handles direct enums → Select dropdown
- [x] Handles integers/numbers with min/max → Slider with number input
- [x] Handles integers/numbers without constraints → Simple number input
- [x] Handles booleans → Checkbox
- [x] Skips connection fields: prompt, image, video, audio, etc.
- [x] Sorts inputs by `x-order` property from schema

**ImageGenNode (apps/web/src/components/nodes/ai/ImageGenNode.tsx):**
- [x] Replaced hardcoded ASPECT_RATIOS, RESOLUTIONS, OUTPUT_FORMATS dropdowns
- [x] Uses SchemaInputs for dynamic rendering based on selected model
- [x] handleModelSelect stores inputSchema and initializes schemaParams with defaults
- [x] Added disabledInputs prop for reduced opacity on unsupported image handles
- [x] Shows warning when model doesn't support image inputs

**VideoGenNode (apps/web/src/components/nodes/ai/VideoGenNode.tsx):**
- [x] Replaced hardcoded Model/Duration/Resolution/AspectRatio dropdowns
- [x] Uses SchemaInputs for dynamic rendering
- [x] Disables image/lastFrame handles when model doesn't support image input

**BaseNode (apps/web/src/components/nodes/BaseNode.tsx):**
- [x] Added `disabledInputs?: string[]` prop
- [x] Handles in disabledInputs render with opacity-30

**Backend - ReplicateService (apps/api/src/services/replicate.service.ts):**
- [x] Added schemaParams to ImageGenInput and VideoGenInput interfaces
- [x] generateImage() uses schemaParams when available, falls back to legacy fields
- [x] generateVideo() uses schemaParams when available, falls back to legacy fields

**Backend - Processors:**
- [x] ImageProcessor passes schemaParams to replicateService.generateImage()
- [x] VideoProcessor passes schemaParams and selectedModel to generateVideo()

**Backend - Job Interfaces (apps/api/src/interfaces/job-data.interface.ts):**
- [x] Added SelectedModelInfo interface
- [x] Added selectedModel and schemaParams to ImageJobData
- [x] Added selectedModel and schemaParams to VideoJobData
- [x] Added inputPrompt and inputImage fields for connection-based inputs

### Files changed

**Types:**
- `packages/types/src/nodes.ts` - inputSchema on ProviderModel/SelectedModel, schemaParams on node data

**Frontend:**
- `apps/web/src/app/api/providers/models/route.ts` - Include inputSchema in response
- `apps/web/src/components/nodes/SchemaInputs.tsx` - NEW: Dynamic input renderer
- `apps/web/src/components/nodes/ai/ImageGenNode.tsx` - Use SchemaInputs
- `apps/web/src/components/nodes/ai/VideoGenNode.tsx` - Use SchemaInputs
- `apps/web/src/components/nodes/BaseNode.tsx` - disabledInputs prop

**Backend:**
- `apps/api/src/services/replicate.service.ts` - schemaParams support
- `apps/api/src/processors/image.processor.ts` - Pass schemaParams
- `apps/api/src/processors/video.processor.ts` - Pass schemaParams and selectedModel
- `apps/api/src/interfaces/job-data.interface.ts` - Extended interfaces

### Decisions

- **Decision:** Use schemaParams object instead of individual fields
  - **Context:** Different models have different parameters (width/height vs aspect_ratio)
  - **Rationale:** Flexible, model-agnostic, future-proof

- **Decision:** Fall back to legacy fields when schemaParams is empty
  - **Context:** Existing workflows don't have schemaParams saved
  - **Rationale:** Backward compatibility - old workflows still work

- **Decision:** Show reduced opacity (30%) on unsupported input handles
  - **Context:** User requested visual feedback when model doesn't support image input
  - **Rationale:** Clear indication that connected inputs won't be used

- **Decision:** Skip connection fields in SchemaInputs (prompt, image, video, etc.)
  - **Context:** These come from node connections, not UI controls
  - **Rationale:** Avoids duplicate controls, cleaner UI

### Key Features Implemented

1. **Dynamic UI**: Node inputs automatically update based on selected model's JSON schema
2. **Backward Compatibility**: Legacy workflows without schemaParams still work
3. **Disabled Handle Feedback**: Image/video input handles show 30% opacity when model doesn't support them
4. **Warning Messages**: Users see warning when connecting image inputs to text-only models
5. **Schema Defaults**: When model is selected, schemaParams initialized with schema defaults

### Next steps

- [ ] Test with different image models (Nano Banana, Z-Image Turbo, FLUX)
- [ ] Test with different video models (Veo 3.1, Kling, Luma Ray)
- [ ] Verify schemaParams correctly passed to Replicate API
- [ ] Test backward compatibility with existing workflows

---

## Session 10: Job Recovery Infinite Loop Fix

**Duration:** ~10 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Job Heartbeat Mechanism                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  PROBLEM (Infinite Recovery Loop):                                       │
│  ┌──────────────┐    5 min    ┌────────────────────────────────────┐    │
│  │ JobRecovery  │ ──────────► │ Finds "stalled" jobs (updatedAt    │    │
│  │   Service    │             │ > 5 min ago) → Re-enqueues them    │    │
│  └──────────────┘             └────────────────────────────────────┘    │
│         │                                  │                            │
│         │                                  ▼                            │
│         │              ┌────────────────────────────────────────┐       │
│         │              │ Processor polls Replicate for 5-20 min │       │
│         │              │ (updatedAt not refreshed during poll)  │       │
│         │              └────────────────────────────────────────┘       │
│         │                                  │                            │
│         └──────────────────────────────────┘                            │
│              ↻ Same jobs recovered every 5 min                          │
│                                                                          │
│  SOLUTION (Heartbeat During Polling):                                    │
│  ┌──────────────┐    Poll     ┌────────────────────────────────────┐    │
│  │ Processor    │ ──────────► │ ReplicatePollerService             │    │
│  │ (img/vid)    │  (loop)     │ - Every 24 attempts (~2 min)       │    │
│  └──────────────┘             │ - Calls onHeartbeat callback       │    │
│                               └────────────────────────────────────┘    │
│                                            │                            │
│                                            ▼                            │
│                               ┌────────────────────────────────────┐    │
│                               │ QueueManagerService.heartbeatJob() │    │
│                               │ → Updates lastHeartbeat timestamp  │    │
│                               └────────────────────────────────────┘    │
│                                            │                            │
│                                            ▼                            │
│                               ┌────────────────────────────────────┐    │
│                               │ JobRecoveryService now checks:      │    │
│                               │ - updatedAt < threshold AND         │    │
│                               │ - lastHeartbeat < threshold         │    │
│                               │ Jobs with recent heartbeat = NOT    │    │
│                               │ stalled, won't be recovered         │    │
│                               └────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

**Schema:**
- [x] Added `lastHeartbeat?: Date` field to QueueJob schema

**QueueManagerService:**
- [x] Added `heartbeatJob(bullJobId)` method that updates `lastHeartbeat` timestamp

**ReplicatePollerService:**
- [x] Extended `PollOptions` interface with `onHeartbeat` callback and `heartbeatInterval`
- [x] Poll loop calls heartbeat every N iterations (default: 24 = ~2 min for 5s polls)
- [x] Heartbeat errors are caught and logged (non-blocking)

**Processors:**
- [x] ImageProcessor passes `onHeartbeat` callback (uses default 24 interval)
- [x] VideoProcessor passes `onHeartbeat` callback with `heartbeatInterval: 12` (~2 min for 10s polls)

**JobRecoveryService:**
- [x] Updated stalled job query to check BOTH `updatedAt` AND `lastHeartbeat`
- [x] Jobs are only considered stalled if both timestamps are older than threshold
- [x] Jobs with null/missing lastHeartbeat are still eligible for recovery

### Files changed

- `apps/api/src/schemas/queue-job.schema.ts` - Added lastHeartbeat field
- `apps/api/src/services/queue-manager.service.ts` - Added heartbeatJob() method
- `apps/api/src/services/replicate-poller.service.ts` - Extended PollOptions, added heartbeat call in loop
- `apps/api/src/processors/image.processor.ts` - Pass onHeartbeat callback
- `apps/api/src/processors/video.processor.ts` - Pass onHeartbeat callback with custom interval
- `apps/api/src/services/job-recovery.service.ts` - Check lastHeartbeat in stalled query

### Decisions

- **Decision:** Heartbeat every ~2 minutes regardless of poll interval
  - **Context:** Recovery runs every 5 minutes with 5 minute threshold
  - **Rationale:** 2 min heartbeat gives buffer, ensures job isn't recovered during active polling

- **Decision:** Heartbeat errors are non-blocking
  - **Context:** DB connectivity issues shouldn't fail the entire prediction
  - **Rationale:** Better to complete generation than fail on optional heartbeat

- **Decision:** Check both updatedAt AND lastHeartbeat in recovery query
  - **Context:** Legacy jobs may not have lastHeartbeat field
  - **Rationale:** Query handles `{ lastHeartbeat: { $exists: false } }` for backward compatibility

### How It Fixes The Bug

**Before:**
1. Job starts, sets status=ACTIVE, updatedAt=now
2. Processor polls Replicate for 5-20 minutes
3. After 5 min: JobRecovery sees updatedAt > 5 min ago → marks as stalled
4. Recovery re-enqueues job → new processor starts polling same prediction
5. Loop continues every 5 minutes

**After:**
1. Job starts, sets status=ACTIVE, updatedAt=now
2. Processor polls Replicate, sends heartbeat every ~2 min
3. lastHeartbeat refreshed throughout polling
4. JobRecovery checks: updatedAt < 5 min AND lastHeartbeat < 5 min
5. Recent heartbeat → job NOT stalled → no recovery
6. If server crashes: no more heartbeats → job IS stalled → recovery works

---

## Session 11: ImageGenNode Two-Column Layout & Unused Input Visual Feedback

**Duration:** ~15 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 ImageGenNode Two-Column Layout                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE (stacked):                                                       │
│  ┌─────────────────────────────┐                                        │
│  │ [Schema Inputs]             │                                        │
│  │ [Aspect Ratio] [Resolution] │                                        │
│  ├─────────────────────────────┤                                        │
│  │                             │                                        │
│  │    [Preview / Generate]     │                                        │
│  │                             │                                        │
│  └─────────────────────────────┘                                        │
│                                                                          │
│  AFTER (two-column):                                                     │
│  ┌──────────────┬──────────────┐                                        │
│  │ [Schema      │              │                                        │
│  │  Inputs]     │   Preview/   │                                        │
│  │              │   Generate   │                                        │
│  │ scrollable   │              │                                        │
│  │ if many      │              │                                        │
│  └──────────────┴──────────────┘                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 Unused Input Visual Feedback                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  DISABLED INPUT HANDLE (model doesn't support image input):              │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │   ●─────────────────────────────────────────────────────────●    │   │
│  │   │ Warning           Edge: dashed,           Handle:        │    │   │
│  │   │ indicator         30% opacity              30% opacity   │    │   │
│  │   ▼ (amber dot)       (edge-disabled)         (opacity-30)   │    │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  Components:                                                             │
│  1. Handle renders with opacity-30 class                                │
│  2. Amber warning dot positioned near handle (title shows tooltip)      │
│  3. Edge connecting to disabled handle: dashed line, 30% opacity        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

**ImageGenNode Two-Column Layout:**
- [x] Changed layout from `flex-col` to `flex` (side-by-side)
- [x] Left column: schema inputs with `min-w-[160px] max-w-[200px] overflow-y-auto`
- [x] Right column: preview/generate button with `flex-1 min-w-[180px]`
- [x] Generate button fills preview area when no output exists
- [x] Processing state shown in generate button area (spinner + text)

**BaseNode Warning Badge:**
- [x] Added warning indicator (amber dot) near disabled input handles
- [x] Uses absolute positioning relative to handle top position
- [x] Shows tooltip "This input is not used by the current model" on hover

**Edge Dimming for Disabled Inputs:**
- [x] Added `supportsImageInput()` helper to WorkflowCanvas
- [x] Added `isEdgeTargetingDisabledInput()` callback that checks:
  - Target node type (imageGen, videoGen)
  - Target handle ID ('images')
  - Model's inputSchema for image support
- [x] styledEdges now applies `edge-disabled` class to these edges
- [x] Added CSS `.edge-disabled` style: dashed line, 30% opacity, amber stroke

### Files changed

**Frontend:**
- `apps/web/src/components/nodes/ai/ImageGenNode.tsx` - Two-column layout
- `apps/web/src/components/nodes/BaseNode.tsx` - Warning badge for disabled handles
- `apps/web/src/components/canvas/WorkflowCanvas.tsx` - Edge dimming logic
- `apps/web/src/app/globals.scss` - `.edge-disabled` CSS class

### Decisions

- **Decision:** Controls on left, preview on right (not vice versa)
  - **Context:** Natural reading order left-to-right
  - **Rationale:** Settings → result matches workflow direction

- **Decision:** Warning indicator is a small amber dot, not text
  - **Context:** Space is limited in node UI
  - **Rationale:** Minimal visual footprint, tooltip provides detail

- **Decision:** Edge disabled style uses chart-3 (amber) color
  - **Context:** Need to differentiate from dimmed (gray) and highlighted (primary)
  - **Rationale:** Amber matches warning dot, indicates "connected but unused"

### Verification

1. **Two-column layout**: Open ImageGenNode, verify controls left, preview right
2. **Warning badge**: Connect Image Input to ImageGenNode with z-image-turbo model
3. **Edge dimming**: Same setup, verify edge shows dashed amber line at 30% opacity

---

---

## Session 12: Model Browser Modal Loading Flash Fix

**Duration:** ~5 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Model Browser Modal Loading Fix                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE (flash problem):                                                 │
│  ┌──────────────┐    ┌──────────────────┐    ┌──────────────┐           │
│  │ Modal opens  │ ──►│ Warning flashes  │ ──►│ Loading      │           │
│  │ isLoading=   │    │ "No providers    │    │ spinner      │           │
│  │ false (init) │    │ configured"      │    │ shows        │           │
│  └──────────────┘    └──────────────────┘    └──────────────┘           │
│       │                     ↑                      │                     │
│       │                     │ configuredProviders  │                     │
│       │                     │ is [] initially      │                     │
│       └─────────────────────┘                      │                     │
│                                                    ▼                     │
│                                            ┌──────────────┐             │
│                                            │ Models load  │             │
│                                            │ (no warning) │             │
│                                            └──────────────┘             │
│                                                                          │
│  AFTER (fixed):                                                          │
│  ┌──────────────┐    ┌──────────────────┐    ┌──────────────┐           │
│  │ Modal opens  │ ──►│ Loading spinner  │ ──►│ Models shown │           │
│  │ hasFetched=  │    │ hasFetched=false │    │ OR warning   │           │
│  │ false        │    │ no warning shown │    │ hasFetched=  │           │
│  └──────────────┘    └──────────────────┘    │ true         │           │
│                                              └──────────────┘           │
│                                                                          │
│  Warning condition now requires hasFetched=true                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

- [x] Added `hasFetched` state initialized to `false`
- [x] Set `hasFetched = true` in fetchModels finally block
- [x] Updated warning condition to check `hasFetched` before showing
- [x] Added useEffect to reset `hasFetched` when modal closes

### Files changed

- `apps/web/src/components/models/ModelBrowserModal.tsx` - Added hasFetched state and condition

### Decisions

- **Decision:** Use `hasFetched` flag instead of changing `isLoading` initial value
  - **Context:** Need to distinguish "never fetched" from "not currently fetching"
  - **Rationale:** More explicit state, warning only shows after we know server state

---

## Session 13: Output Node Preview URL Mismatch Fix

**Duration:** ~5 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Output Node Preview Fix                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE (bug):                                                           │
│  ┌──────────────┐                        ┌────────────────────────┐     │
│  │ OutputNode   │  uses inputImage/      │ Shows correct image    │     │
│  │ component    │  inputVideo correctly  │ in node preview        │     │
│  └──────────────┘                        └────────────────────────┘     │
│                                                                          │
│  ┌──────────────┐                        ┌────────────────────────┐     │
│  │ NodeDetail   │  uses getMediaFromNode │ Shows different/wrong  │     │
│  │ Modal        │  → outData.inputMedia  │ image in full preview  │     │
│  └──────────────┘  (WRONG property!)     └────────────────────────┘     │
│                                                                          │
│  AFTER (fixed):                                                          │
│  ┌──────────────┐                        ┌────────────────────────┐     │
│  │ getMedia     │  case 'output':        │ Both node and modal    │     │
│  │ FromNode     │  → inputVideo ||       │ show same image        │     │
│  │              │    inputImage          └────────────────────────┘     │
│  └──────────────┘                                                       │
│                                                                          │
│  OutputNodeData type has: inputImage, inputVideo                         │
│  mediaExtraction was using: inputMedia (doesn't exist!)                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

- [x] Fixed `getMediaFromNode()` for output node type
- [x] Changed from `outData.inputMedia` (non-existent) to `outData.inputVideo || outData.inputImage`
- [x] Now matches OutputNode component logic exactly

### Files changed

- `apps/web/src/lib/utils/mediaExtraction.ts` - Fixed output node media extraction

### Root Cause

The `mediaExtraction.ts` utility was referencing `outData.inputMedia` which doesn't exist on `OutputNodeData`. The correct properties are `inputImage` and `inputVideo` (matching the OutputNode component).

---

## Session 14: Output Propagation & Image Overflow Fixes

**Duration:** ~15 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 Output Propagation Fix                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE (BROKEN):                                                        │
│  mapOutputToInput() returns:                                             │
│    { inputMedia: url, inputType: 'image' }  ❌ Wrong field name         │
│                                                                          │
│  OutputNode checks:                                                      │
│    nodeData.inputImage || nodeData.inputVideo  ❌ Never finds inputMedia│
│                                                                          │
│  AFTER (FIXED):                                                          │
│  mapOutputToInput() returns:                                             │
│    { inputImage: url, inputVideo: null, inputType: 'image' }  ✅        │
│    { inputVideo: url, inputImage: null, inputType: 'video' }  ✅        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 Backend Output Format Fix                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Backend sends (image.processor.ts):                                     │
│    { image: "https://..." }  or  { video: "https://..." }               │
│                                                                          │
│  extractOutputValue() checked:                                           │
│    if ('url' in output)  ❌ Misses image/video fields                   │
│                                                                          │
│  FIXED - Now also checks:                                                │
│    if ('image' in obj) return obj.image  ✅                             │
│    if ('video' in obj) return obj.video  ✅                             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 Image Overflow Fix                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE (Image overflows node):                                          │
│  ┌─────────────────────────────┐                                        │
│  │ Node Container              │                                        │
│  │  ┌─────────────────────────┴──────┐                                  │
│  │  │ Image with flex-1 min-h-[80px] │  ← Grows unbounded               │
│  │  │ width={400} height={300}       │                                  │
│  │  └────────────────────────────────┘                                  │
│  └─────────────────────────────┘                                        │
│                                                                          │
│  AFTER (Image constrained):                                              │
│  ┌─────────────────────────────┐                                        │
│  │ Node Container              │                                        │
│  │  ┌─────────────────────────┐│                                        │
│  │  │ aspect-[4/3] w-full     ││  ← Fixed aspect ratio                  │
│  │  │ Image fill + object-    ││                                        │
│  │  │ contain                 ││                                        │
│  │  └─────────────────────────┘│                                        │
│  └─────────────────────────────┘                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

**Output Propagation Bugs:**
- [x] Fixed `mapOutputToInput()` - now returns `inputImage`/`inputVideo` instead of `inputMedia`
- [x] Fixed `extractOutputValue()` - now handles `{ image: url }` and `{ video: url }` formats

**Image Overflow Bugs:**
- [x] ImageInputNode - Changed from `flex-1 min-h-[80px]` to `aspect-[4/3] w-full` + `fill`
- [x] ImageGenNode - Same fix: `aspect-[4/3] w-full` + `fill`
- [x] OutputNode - Fixed both image (`aspect-[4/3]`) and video (`aspect-video`) previews
- [x] VideoGenNode - Changed from `flex-1 min-h-[80px]` to `aspect-video w-full`

### Files changed

**Frontend - Store:**
- `apps/web/src/store/workflow/slices/nodeSlice.ts` - Fixed mapOutputToInput() field names
- `apps/web/src/store/execution/helpers/outputHelpers.ts` - Fixed extractOutputValue() to handle image/video fields

**Frontend - Nodes:**
- `apps/web/src/components/nodes/input/ImageInputNode.tsx` - aspect-[4/3] + fill
- `apps/web/src/components/nodes/ai/ImageGenNode.tsx` - aspect-[4/3] + fill
- `apps/web/src/components/nodes/ai/VideoGenNode.tsx` - aspect-video + absolute inset-0
- `apps/web/src/components/nodes/output/OutputNode.tsx` - aspect-[4/3] for image, aspect-video for video

### Decisions

- **Decision:** Use aspect ratio classes instead of flex-1 for media containers
  - **Context:** flex-1 allows unbounded growth in flex layouts
  - **Rationale:** Aspect ratios provide predictable, bounded sizing

- **Decision:** Use Next.js Image `fill` prop instead of explicit width/height
  - **Context:** Explicit dimensions don't respect container constraints with h-full
  - **Rationale:** `fill` properly fills container while respecting object-fit

### Root Causes

1. **Output not showing in nodes**: Backend sends `{ image: url }`, frontend expected `{ url: url }`
2. **OutputNode "Waiting for input"**: Propagation used `inputMedia`, node checks `inputImage/inputVideo`
3. **Image overflow**: `flex-1` + `h-full` + explicit Image dimensions = unbounded growth

---

## Session 15: Handle Positioning Fix & Video Model Selection Bug

**Duration:** ~30 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Handle Positioning Fix                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  PROBLEM (Edges connecting to wrong positions):                          │
│  ┌──────────────┐                                                       │
│  │ BaseNode     │ ← overflow-hidden clipped handles!                    │
│  │ container    │   React Flow couldn't calculate positions             │
│  │              │                                                       │
│  └──────────────┘                                                       │
│         ↓                                                                │
│  ┌──────────────┐                                                       │
│  │ Edge paths   │ ← Connected to wrong Y coordinates                    │
│  │ misaligned   │                                                       │
│  └──────────────┘                                                       │
│                                                                          │
│  FIX: Remove overflow-hidden from node container div                     │
│  - Handles need to extend beyond container bounds                        │
│  - React Flow calculates positions from actual DOM elements              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Video Model Selection Bug                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  PROBLEM (UI shows Kling, API calls Veo):                                │
│  ┌──────────────┐                                                       │
│  │ VideoGenNode │  selectedModel = { modelId: "kling/v2.5-turbo-pro" }  │
│  │ (frontend)   │  schemaParams = { aspect_ratio: "16:9" }              │
│  └──────────────┘                                                       │
│         │ POST /replicate/video                                         │
│         ▼                                                                │
│  ┌──────────────┐                                                       │
│  │ Controller   │  ← NOT passing selectedModel or schemaParams!         │
│  │              │  → Only passing legacy model field ("veo-3.1-fast")   │
│  └──────────────┘                                                       │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────┐                                                       │
│  │ Replicate    │  ← Called veo-3.1-fast instead of kling!              │
│  │ API          │                                                       │
│  └──────────────┘                                                       │
│                                                                          │
│  FIX: Added selectedModel and schemaParams to DTO and controller         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

**Handle Positioning Fix:**
- [x] Removed `overflow-hidden` from BaseNode container div
- [x] Removed warning indicator dots (were causing layout issues)
- [x] Reverted ImageGenNode to original stacked layout (two-column was problematic)

**Video Model Selection Bug Fix:**
- [x] Added `SelectedModelDto` class to `generate-video.dto.ts`
- [x] Added `selectedModel` and `schemaParams` fields to `GenerateVideoDto`
- [x] Added `schemaParams` field to `GenerateImageDto`
- [x] Updated `replicate.controller.ts` to pass `selectedModel` and `schemaParams` for both image and video endpoints

### Files changed

**Backend - DTOs:**
- `apps/api/src/dto/generate-video.dto.ts` - Added SelectedModelDto, selectedModel, schemaParams
- `apps/api/src/dto/generate-image.dto.ts` - Added schemaParams

**Backend - Controller:**
- `apps/api/src/controllers/replicate.controller.ts` - Pass selectedModel and schemaParams to service

**Frontend:**
- `apps/web/src/components/nodes/BaseNode.tsx` - Removed overflow-hidden, removed warning indicators
- `apps/web/src/components/nodes/ai/ImageGenNode.tsx` - Reverted to stacked layout

### Decisions

- **Decision:** Remove overflow-hidden from node container
  - **Context:** React Flow needs handles to extend beyond node bounds for position calculation
  - **Rationale:** CSS clipping was causing handle positions to be calculated incorrectly

- **Decision:** Revert ImageGenNode to stacked layout
  - **Context:** Two-column layout caused issues with handle positioning and resizing
  - **Rationale:** Simpler layout is more stable, user can resize node as needed

- **Decision:** Add selectedModel to both DTOs even though image DTO had it
  - **Context:** Consistency between image and video endpoints
  - **Rationale:** Both need selectedModel.modelId for dynamic model selection

### Mistakes and fixes

- **Mistake:** Added `overflow-hidden` to BaseNode in earlier session
  - **Fix:** Removed it - handles must extend beyond container for React Flow

- **Mistake:** Wrapped Handle components in div for warning indicators
  - **Fix:** Removed div wrapper, rendered warning indicators separately (then removed entirely)

- **Mistake:** Video controller wasn't passing selectedModel to service
  - **Fix:** Added selectedModel and schemaParams to DTO and controller

### Verification

1. **Handle positioning**: Edges now connect to actual handle positions
2. **Model selection**: VideoGenNode with Kling model now calls kling API, not veo
3. **Schema params**: Custom parameters (aspect_ratio, etc.) now passed to Replicate

---

## Session 16: Schema Mapper for Model-Specific Field Names

**Duration:** ~25 minutes
**Status:** Complete

### Problem

Video generation with Kling v2.5 Turbo Pro was only receiving one image (start frame) even though both Starting Frame and Ending Frame were connected. The Replicate API response showed:
- `image` was sent (start frame)
- `end_image` was NOT sent (end frame missing)

### Root Cause

Different models use different field names for the same concepts:
- **Kling**: `start_image`, `end_image`
- **Veo/Others**: `image`, `last_frame`

The code was hardcoding `image` and `last_frame` without checking the model's inputSchema for the correct field names.

### Solution

Created `SchemaMapperService` to dynamically map canonical field names to model-specific names based on the model's inputSchema.

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Schema-Based Field Mapping                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Canonical (Internal)          Model-Specific (Replicate API)           │
│  ┌────────────────────┐        ┌────────────────────────────┐           │
│  │ image              │ ──────►│ start_image (Kling)        │           │
│  │                    │        │ image (Veo)                │           │
│  │ lastFrame          │ ──────►│ end_image (Kling)          │           │
│  │                    │        │ last_frame (Veo)           │           │
│  │ referenceImages    │ ──────►│ reference_images           │           │
│  │ aspectRatio        │ ──────►│ aspect_ratio               │           │
│  │ negativePrompt     │ ──────►│ negative_prompt            │           │
│  └────────────────────┘        └────────────────────────────┘           │
│                                                                          │
│  SchemaMapper inspects model.inputSchema.properties to determine        │
│  which field names the model expects, then maps accordingly.            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Files changed

**Backend - New Service:**
- `apps/api/src/services/schema-mapper.service.ts` - NEW: Maps canonical → model-specific field names

**Backend - Module:**
- `apps/api/src/modules/replicate.module.ts` - Added SchemaMapperService provider

**Backend - Services:**
- `apps/api/src/services/replicate.service.ts` - Inject SchemaMapperService, use for generateImage/generateVideo
- `apps/api/src/services/executions.service.ts` - Added lastFrame to handle mappings

### Decisions

- **Decision:** Create dedicated SchemaMapperService instead of inline logic
  - **Rationale:** Centralized, reusable, testable; different models have different naming conventions

- **Decision:** Use model's inputSchema to detect field names
  - **Rationale:** The schema is the source of truth for what the model expects

- **Decision:** Support multiple alternative names per canonical field
  - **Rationale:** Models may use `end_image`, `last_frame`, `tail_image`, etc.

### Field Mappings

**Video fields:**
| Canonical | Alternatives |
|-----------|-------------|
| image | start_image, first_frame, init_image, source_image |
| lastFrame | end_image, last_frame, tail_image, final_frame, target_image |
| referenceImages | reference_images, ref_images, style_images |
| duration | length, video_length, duration_seconds |
| aspectRatio | aspect_ratio, ratio |
| negativePrompt | negative_prompt, negative, neg_prompt |

**Image fields:**
| Canonical | Alternatives |
|-----------|-------------|
| inputImages | image_input, images, source_images, reference_images |
| aspectRatio | aspect_ratio, ratio |
| resolution | output_resolution, image_resolution, size |
| outputFormat | output_format, format, image_format |

---

## Session 17: Replicate Schema Verification & Fix

**Duration:** ~5 minutes
**Status:** Complete

### What was done

Verified and fixed remaining gaps in schema field mapping system:

**1. Schema Mapper Service Fix:**
- [x] Added `first_frame_image` to VIDEO_FIELD_MAPPINGS image alternatives
- Required for minimax/video-01 which uses `first_frame_image` instead of `image` or `start_image`

**2. SchemaInputs Connection Fields:**
- [x] Added `subject_reference` - minimax S2V mode character reference
- [x] Added `image_prompt` - flux-1.1-pro Redux image prompt
- [x] Added `mask` - sdxl inpainting mask

These fields come from node connections and should not appear in the node's parameter UI.

### Files changed

| File | Changes |
|------|---------|
| `apps/api/src/services/schema-mapper.service.ts` | Added `first_frame_image` to image field alternatives |
| `apps/web/src/components/nodes/SchemaInputs.tsx` | Added 3 connection fields to filter set |

### Verification Checklist

- [ ] Test minimax/video-01: Verify start frame maps to `first_frame_image` correctly
- [ ] Test flux-1.1-pro: Verify `image_prompt` doesn't appear in UI (filtered)
- [ ] Test minimax S2V: Verify `subject_reference` doesn't appear in UI (filtered)
- [ ] Test sdxl: Verify `mask` doesn't appear in UI (filtered)

---

## Session 18: Canvas Performance Optimization

**Status:** Complete

### Problem

Canvas slowed down the longer it was used due to:
1. Memory leak - Jobs Map never cleared
2. Cascading re-renders - Edge styling recalculated on every node change
3. Polling couldn't be aborted - Orphaned polls continued after stop
4. Cost calculation created new arrays on every render

### What was done

| Fix | File | Change |
|-----|------|--------|
| Jobs memory leak | `sseSubscription.ts:94` | Clear `jobs: new Map()` when execution finishes |
| Cascading re-renders | `WorkflowCanvas.tsx:199-204` | Added stable `nodeMap` via useMemo, callback now depends on map |
| Abortable polling | `pollPrediction.ts:16,22-23,64-81` | Added AbortSignal parameter with abort checks and abortable delay |
| Cost optimization | `Toolbar.tsx:102-123` | Extracted `costRelevantData` with useMemo before useEffect |
| Context menu deps | `useContextMenu.ts:43-71,178-246` | Used `stableHandlersRef` for 11 handlers, reduced deps from 25+ to ~15 |

### Files changed

| File | Changes |
|------|---------|
| `apps/web/src/store/execution/helpers/sseSubscription.ts` | Added `jobs: new Map()` to clear jobs on completion |
| `apps/web/src/components/canvas/WorkflowCanvas.tsx` | Added `nodeMap` useMemo, updated `isEdgeTargetingDisabledInput` deps |
| `apps/web/src/store/execution/helpers/pollPrediction.ts` | Added `signal?: AbortSignal` param, abort checks, abortable setTimeout |
| `apps/web/src/components/toolbar/Toolbar.tsx` | Extracted `costRelevantData` useMemo before effect |
| `apps/web/src/hooks/useContextMenu.ts` | Added `stableHandlersRef`, reduced `getMenuItems` dependencies |

### Verification

1. **Memory Leak Test:** Run 10+ executions, check heap snapshot for unbounded Map growth
2. **Re-render Test:** Add log in `styledEdges` useMemo - node drag should NOT trigger
3. **Abort Test:** Start execution, click Stop - no further API calls should appear
4. **General:** Use React DevTools Profiler - render times should stay consistent

---

## Session 19: Fix Stale Closure Bug in Schema Params

**Duration:** ~10 minutes
**Status:** Complete

### Problem

When changing schema params (like `output_format`), the UI showed the new value (e.g., "webp") but the API received the old value (e.g., "jpg"). This was caused by stale closures in both the auto-save hook and the node components.

### Root Cause Analysis

```
User changes output_format to "webp"
        │
        ▼
┌───────────────────────────────────────────────┐
│ 1. handleSchemaParamChange called             │
│    - Uses nodeData.schemaParams from closure  │
│    - Closure may be stale if rapid changes    │
└───────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│ 2. useAutoSave timer running                  │
│    - Only tracked nodes.length (not data)     │
│    - saveWorkflow in closure was stale        │
│    - Could save OLD data when timer fires     │
└───────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│ 3. When user executes workflow                │
│    - Database has old schemaParams            │
│    - API receives "jpg" instead of "webp"     │
└───────────────────────────────────────────────┘
```

### What was done

**1. useAutoSave.ts - Fixed auto-save stale closure:**
- [x] Added `nodesHash` dependency to track actual node data changes (not just length)
- [x] Get `saveWorkflow` fresh from store at save time using `useWorkflowStore.getState()`

**2. ImageGenNode.tsx - Fixed schema param update closure:**
- [x] Get fresh node state from store in `handleSchemaParamChange`
- [x] Removed `nodeData.schemaParams` from dependency array

**3. VideoGenNode.tsx - Same fix as ImageGenNode:**
- [x] Get fresh node state from store in `handleSchemaParamChange`
- [x] Removed `nodeData.schemaParams` from dependency array

### Files changed

| File | Changes |
|------|---------|
| `apps/web/src/hooks/useAutoSave.ts` | Track nodes data changes, get fresh saveWorkflow |
| `apps/web/src/components/nodes/ai/ImageGenNode.tsx` | Get fresh state in handleSchemaParamChange |
| `apps/web/src/components/nodes/ai/VideoGenNode.tsx` | Get fresh state in handleSchemaParamChange |

### Key Code Patterns

**Before (stale closure):**
```tsx
const handleSchemaParamChange = useCallback(
  (key: string, value: unknown) => {
    updateNodeData(id, {
      schemaParams: {
        ...(nodeData.schemaParams ?? {}), // ❌ Stale closure
        [key]: value,
      },
    });
  },
  [id, nodeData.schemaParams, updateNodeData]
);
```

**After (fresh state):**
```tsx
const handleSchemaParamChange = useCallback(
  (key: string, value: unknown) => {
    const currentNode = useWorkflowStore.getState().getNodeById(id);
    const currentData = currentNode?.data;
    updateNodeData(id, {
      schemaParams: {
        ...(currentData?.schemaParams ?? {}), // ✅ Fresh from store
        [key]: value,
      },
    });
  },
  [id, updateNodeData] // Removed stale dependency
);
```

### Verification

- [ ] Change output_format in ImageGenNode, verify API receives correct value
- [ ] Change multiple params rapidly, verify all are saved correctly
- [ ] Verify auto-save saves latest state after debounce

---

**Total sessions today:** 19
